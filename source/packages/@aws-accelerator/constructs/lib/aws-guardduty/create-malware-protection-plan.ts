/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */

import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';

/**
 * Tag interface for Malware Protection Plan
 */
export interface malwareProtectionTag {
  readonly key: string;
  readonly value: string;
}

/**
 * Initialized CreateMalwareProtectionPlanProps properties
 */
export interface CreateMalwareProtectionPlanProps {
  /**
   * S3 Bucket ARN
   */
  readonly s3BucketName: string;
  /**
   * Object prefixes to scan (optional)
   */
  readonly objectPrefixes?: string[];
  /**
   * Enable malware protection tags on scanned objects
   */
  readonly enableMalwareProtectionTags?: boolean;
  /**
   * Tags to apply to the malware protection plan (optional)
   */
  readonly tags?: malwareProtectionTag[];
  /**
   * IAM role ARN for GuardDuty to access the S3 bucket
   */
  readonly roleArn: string;
}

/**
 * Class to create GuardDuty Malware Protection Plan
 */
export class CreateMalwareProtectionPlan extends Construct {
  public readonly id: string;
  public readonly malwareProtectionPlan: cdk.aws_guardduty.CfnMalwareProtectionPlan;

  constructor(scope: Construct, id: string, props: CreateMalwareProtectionPlanProps) {
    super(scope, id);
    // Build the protected resource configuration
    const protectedResource: cdk.aws_guardduty.CfnMalwareProtectionPlan.CFNProtectedResourceProperty = {
      s3Bucket: {
        bucketName: props.s3BucketName,
        objectPrefixes: props.objectPrefixes,
      },
    };

    // Build actions configuration
    const actions: cdk.aws_guardduty.CfnMalwareProtectionPlan.CFNActionsProperty = {
      tagging: {
        status: props.enableMalwareProtectionTags === true ? 'ENABLED' : 'DISABLED',
      },
    };

    // Convert tags to CDK tag format
    const cdkTags = props.tags?.map(tag => ({
      key: tag.key,
      value: tag.value,
    }));
    // Create the Malware Protection Plan
    this.malwareProtectionPlan = new cdk.aws_guardduty.CfnMalwareProtectionPlan(this, 'MalwareProtectionPlan', {
      role: props.roleArn,
      protectedResource: protectedResource,
      actions: actions,
      tags: cdkTags,
    });

    this.id = this.malwareProtectionPlan.attrArn;
  }
}
