import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { pascalCase } from 'change-case';
import { GuardDutyConfig } from '@aws-accelerator/config';
import { CreateMalwareProtectionPlan } from '@aws-accelerator/constructs';
import { NagSuppressions } from 'cdk-nag';
import { AcceleratorStack, AcceleratorStackProps, NagSuppressionRuleIds } from './accelerator-stack';

export class GuardDutyMalwareStack extends AcceleratorStack {
  constructor(scope: Construct, id: string, props: AcceleratorStackProps) {
    super(scope, id, props);

    this.logger.info('Begin stack synthesis');
    //
    // Create Guard Duty S3 Malware Protection Plans
    //
    this.configureS3MalwareProtection();

    //
    // Create NagSuppressions
    //
    this.addResourceSuppressionsByPath();

    this.logger.info('End stack synthesis');
  }
  /**
   * FUNCTION PURPOSE: Configures GuardDuty S3 Malware Protection for specified S3 buckets
   *
   * WORKFLOW OVERVIEW:
   * 1. Validates GuardDuty and S3 Malware Protection are enabled
   * 2. Retrieves S3 configurations from security config
   * 3. Creates IAM role with required permissions for malware scanning
   * 4. Iterates through S3 configurations and creates malware protection plans
   *
   * DEPENDENCIES: Requires guardDutyConfig.enable and guardDutyConfig.s3MalwareProtection.enable
   * CREATES: IAM role and CreateMalwareProtectionPlan constructs for each matching S3 bucket
   * SCOPE: Only processes configurations matching current stack's account and region
   */
  private configureS3MalwareProtection() {
    // STEP 1: Get GuardDuty configuration from security config
    const guardDutyConfig = this.props.securityConfig.centralSecurityServices.guardduty;

    // STEP 2: Early exit validation - check if both GuardDuty and S3 Malware Protection are enabled
    if (!guardDutyConfig?.enable || !guardDutyConfig.s3MalwareProtection?.enable) {
      this.logger.info('GuardDuty S3 Malware Protection is not enabled, skipping configuration');
      return;
    }

    // STEP 3: Extract S3 configurations array (default to empty array if undefined)
    const s3Configurations = guardDutyConfig.s3MalwareProtection.s3Configurations ?? [];

    // STEP 4: Early exit if no S3 configurations are defined
    if (s3Configurations.length === 0) {
      this.logger.info('No S3 configurations found for GuardDuty Malware Protection');
      return;
    }

    // STEP 5: Create shared IAM role for GuardDuty malware protection service
    // This role allows GuardDuty to scan S3 objects and manage EventBridge rules
    const guardDutyMalwareProtectionRole = this.createGuardDutyMalwareProtectionRole();
    if (!guardDutyMalwareProtectionRole) {
      this.logger.error('Failed to create IAM role for GuardDuty Malware Protection');
      return;
    }

    // STEP 6: Process each S3 configuration and create malware protection plans
    // Only creates plans for configurations matching current stack's account and region
    for (const s3ConfigItem of s3Configurations) {
      // FILTER: Check if configuration applies to current stack's region and account
      const targetAccount = this.props.accountsConfig.getAccountId(s3ConfigItem.account);
      if (s3ConfigItem.region === cdk.Stack.of(this).region && targetAccount === cdk.Stack.of(this).account) {
        // Get the account ID for the configured account
        const targetAccountId = this.props.accountsConfig.getAccountId(s3ConfigItem.account);

        this.logger.info(
          `Configuring GuardDuty S3 Malware Protection for bucket: ${s3ConfigItem.s3BucketName} in account ${s3ConfigItem.account} (${targetAccountId})`,
        );
        // CREATE: Malware Protection Plan construct for this S3 bucket
        const malwareProtectionPlan = new CreateMalwareProtectionPlan(
          this,
          pascalCase(`MalwareProtectionPlan-${s3ConfigItem.s3BucketName}`),
          {
            s3BucketName: s3ConfigItem.s3BucketName,
            objectPrefixes: s3ConfigItem.objectPrefixes,
            enableMalwareProtectionTags: s3ConfigItem.enableMalwareProtectionTags!,
            tags: s3ConfigItem.tags,
            roleArn: guardDutyMalwareProtectionRole.roleArn,
          },
        );
        // DEPENDENCY: Ensure IAM role is created before malware protection plan
        malwareProtectionPlan.node.addDependency(guardDutyMalwareProtectionRole);
        this.logger.info(`Created Malware Protection plan for bucket: ${s3ConfigItem.s3BucketName}`);
      }
    }
  }

  /**
   * FUNCTION PURPOSE: Creates IAM role for GuardDuty S3 Malware Protection service
   *
   * WORKFLOW OVERVIEW:
   * 1. Gets list of S3 buckets configured for malware protection
   * 2. Creates IAM role with trust policy for GuardDuty malware protection service
   * 3. Adds EventBridge permissions for managing S3 event rules
   * 4. Adds GuardDuty service permissions for malware protection plans
   * 5. Adds KMS permissions for decrypting S3 objects during scans
   * 6. Conditionally adds S3-specific permissions if buckets are configured
   *
   * RETURNS: IAM role that GuardDuty can assume to perform malware scanning
   * SECURITY: Role is restricted to specific account and GuardDuty service principals
   */
  private createGuardDutyMalwareProtectionRole(): cdk.aws_iam.IRole {
    // STEP 1: Get list of S3 buckets that need malware protection in current account/region
    const malwareProtectionS3Buckets = this.getS3BucketsMalwareProtection();

    // STEP 2: Create IAM role with restrictive trust policy
    // SECURITY: Only allows GuardDuty malware protection service from same account
    const malwareProtectionRole = new cdk.aws_iam.Role(this, 'MalwareProtectionRole', {
      roleName: `${this.props.prefixes.accelerator}-GuardDutyS3MalwareScanRole-${cdk.Stack.of(this).region}`,
      assumedBy: new cdk.aws_iam.ServicePrincipal('malware-protection-plan.guardduty.amazonaws.com', {
        conditions: {
          StringEquals: {
            'aws:SourceAccount': cdk.Stack.of(this).account,
          },
          ArnLike: {
            'aws:SourceArn': `arn:${cdk.Stack.of(this).partition}:guardduty:${cdk.Stack.of(this).region}:${cdk.Stack.of(this).account}:malware-protection-plan/*`,
          },
        },
      }),
    });

    // STEP 3: Add EventBridge permissions for managing S3 event rules
    // PURPOSE: Allows GuardDuty to create/manage EventBridge rules for S3 events
    malwareProtectionRole.addToPolicy(
      new cdk.aws_iam.PolicyStatement({
        sid: 'AllowManagedRuleToSendS3EventsToGuardDuty',
        effect: cdk.aws_iam.Effect.ALLOW,
        actions: ['events:DeleteRule', 'events:PutRule', 'events:PutTargets', 'events:RemoveTargets'],
        resources: [
          `arn:${cdk.Stack.of(this).partition}:events:${cdk.Stack.of(this).region}:${cdk.Stack.of(this).account}:rule/DO-NOT-DELETE-AmazonGuardDutyMalwareProtectionS3*`,
        ],
        conditions: {
          StringEquals: {
            'events:ManagedBy': 'malware-protection-plan.guardduty.amazonaws.com',
          },
        },
      }),
    );

    // STEP 4: Add EventBridge monitoring permissions
    // PURPOSE: Allows GuardDuty to monitor existing EventBridge rules
    malwareProtectionRole.addToPolicy(
      new cdk.aws_iam.PolicyStatement({
        sid: 'AllowGuardDutyToMonitorEventBridgeManagedRule',
        effect: cdk.aws_iam.Effect.ALLOW,
        actions: ['events:DescribeRule', 'events:ListTargetsByRule'],
        resources: [
          `arn:${cdk.Stack.of(this).partition}:events:${cdk.Stack.of(this).region}:${cdk.Stack.of(this).account}:rule/DO-NOT-DELETE-AmazonGuardDutyMalwareProtectionS3*`,
        ],
      }),
    );

    // STEP 5: Add GuardDuty service permissions
    // PURPOSE: Allows creation of malware protection plans
    malwareProtectionRole.addToPolicy(
      new cdk.aws_iam.PolicyStatement({
        sid: 'AllowGuardDutyCreateMalwareProtectionPlan',
        effect: cdk.aws_iam.Effect.ALLOW,
        actions: ['guardduty:CreateMalwareProtectionPlan'],
        resources: ['*'],
      }),
    );

    // STEP 6: Add IAM PassRole permission for self-reference
    // PURPOSE: Allows GuardDuty to pass this role to malware protection plans
    malwareProtectionRole.addToPolicy(
      new cdk.aws_iam.PolicyStatement({
        sid: 'IamPassRole',
        effect: cdk.aws_iam.Effect.ALLOW,
        actions: ['iam:PassRole'],
        resources: [malwareProtectionRole.roleArn],
        conditions: {
          StringEquals: {
            'iam:PassedToService': 'malware-protection-plan.guardduty.amazonaws.com',
          },
        },
      }),
    );

    // STEP 7: Add KMS permissions for encrypted S3 objects
    // PURPOSE: Allows decryption of S3 objects during malware scanning
    malwareProtectionRole.addToPolicy(
      new cdk.aws_iam.PolicyStatement({
        sid: 'AllowDecryptForMalwareScan',
        effect: cdk.aws_iam.Effect.ALLOW,
        actions: ['kms:GenerateDataKey', 'kms:Decrypt'],
        resources: ['*'],
        conditions: {
          StringLike: {
            'kms:ViaService': `s3.${cdk.Stack.of(this).region}.amazonaws.com`,
          },
        },
      }),
    );

    // STEP 8: Add S3-specific permissions if buckets are configured
    // CONDITIONAL: Only adds permissions if there are S3 buckets to protect
    if (malwareProtectionS3Buckets?.length > 0) {
      // TRANSFORM: Convert bucket names to bucket ARNs for IAM policies
      const s3BucketArns =
        malwareProtectionS3Buckets?.map(bucketName => `arn:${cdk.Stack.of(this).partition}:s3:::${bucketName}`) || [];

      // PERMISSION: Allow placing validation objects in S3 buckets
      malwareProtectionRole.addToPolicy(
        new cdk.aws_iam.PolicyStatement({
          // amazonq-ignore-next-line
          sid: 'AllowPutValidationObject',
          effect: cdk.aws_iam.Effect.ALLOW,
          actions: ['s3:PutObject'],
          resources: malwareProtectionS3Buckets?.map(
            bucketName =>
              `arn:${cdk.Stack.of(this).partition}:s3:::${bucketName}/malware-protection-resource-validation-object`,
          ),
        }),
      );

      // PERMISSION: Allow managing S3 bucket notifications for EventBridge
      malwareProtectionRole.addToPolicy(
        new cdk.aws_iam.PolicyStatement({
          sid: 'AllowEnableS3EventBridgeEvents',
          effect: cdk.aws_iam.Effect.ALLOW,
          actions: ['s3:PutBucketNotification', 's3:GetBucketNotification'],
          resources: s3BucketArns,
        }),
      );

      // TRANSFORM: Convert bucket names to object ARNs for scanning permissions
      const s3ObjectArns =
        malwareProtectionS3Buckets?.map(bucketName => `arn:${cdk.Stack.of(this).partition}:s3:::${bucketName}/*`) || [];

      // PERMISSION: Allow tagging objects after malware scan
      malwareProtectionRole.addToPolicy(
        new cdk.aws_iam.PolicyStatement({
          sid: 'AllowPostScanTag',
          effect: cdk.aws_iam.Effect.ALLOW,
          actions: [
            's3:GetObjectTagging',
            's3:GetObjectVersionTagging',
            's3:PutObjectTagging',
            's3:PutObjectVersionTagging',
          ],
          resources: s3ObjectArns,
        }),
      );

      // PERMISSION: Allow checking bucket ownership and configuration
      malwareProtectionRole.addToPolicy(
        new cdk.aws_iam.PolicyStatement({
          sid: 'AllowCheckBucketOwnership',
          effect: cdk.aws_iam.Effect.ALLOW,
          actions: [
            's3:ListBucket',
            's3:GetBucketPolicy',
            's3:GetBucketAcl',
            's3:GetBucketLocation',
            's3:GetBucketVersioning',
            's3:GetBucketTagging',
          ],
          resources: s3BucketArns,
        }),
      );

      // PERMISSION: Allow reading S3 objects for malware scanning
      malwareProtectionRole.addToPolicy(
        new cdk.aws_iam.PolicyStatement({
          sid: 'AllowMalwareScan',
          effect: cdk.aws_iam.Effect.ALLOW,
          actions: ['s3:GetObject', 's3:GetObjectVersion'],
          resources: s3ObjectArns,
        }),
      );
    }
    // AwsSolutions-IAM5: The IAM entity contains wildcard permissions and does not have a cdk_nag rule suppression with evidence for those permission.
    // rule suppression with evidence for this permission.
    // AwsSolutions-IAM4: The IAM user, role, or group uses AWS managed policies
    // rule suppression with evidence for this permission.
    NagSuppressions.addResourceSuppressions(
      malwareProtectionRole,
      [
        {
          id: 'AwsSolutions-IAM5',
          reason: 'GuardDuty Malware Protection requires a wildcard for KMS and CreateMalwareProtectionPlan API calls.',
        },
      ],
      true,
    );
    this.nagSuppressionInputs.push({
      id: NagSuppressionRuleIds.IAM5,
      details: [
        {
          path: `${this.stackName}/MalwareProtectionRole/DefaultPolicy/Resource`,
          reason: 'GuardDuty Malware Protection requires a wildcard for KMS API calls.',
        },
      ],
    });
    return malwareProtectionRole;
  }

  /**
   * FUNCTION PURPOSE: Retrieves S3 bucket names configured for malware protection in current stack context
   *
   * WORKFLOW OVERVIEW:
   * 1. Validates S3 Malware Protection is enabled in GuardDuty config
   * 2. Filters S3 configurations by current account and region
   * 3. Extracts unique bucket names from matching configurations
   * 4. Logs summary of found buckets
   *
   * RETURNS: Array of unique S3 bucket names (strings) for current account/region
   * FILTER CRITERIA: Only includes buckets where account and region match current stack
   * USE CASE: Used by createGuardDutyMalwareProtectionRole to scope IAM permissions
   */
  private getS3BucketsMalwareProtection(): string[] {
    // STEP 1: Get GuardDuty configuration and current stack context
    const guardDutyConfig: GuardDutyConfig = this.props.securityConfig.centralSecurityServices.guardduty;
    const currentAccount = cdk.Stack.of(this).account;
    const currentRegion = cdk.Stack.of(this).region;
    const s3Buckets: string[] = [];

    // STEP 2: Early exit validation - check if S3 Malware Protection is enabled
    if (!guardDutyConfig.s3MalwareProtection?.enable) {
      this.logger.info('S3 Malware Protection is not enabled');
      return [];
    }

    // STEP 3: Filter and collect S3 bucket names matching current account and region
    // ITERATION: Process each S3 configuration from security config
    for (const s3Item of guardDutyConfig.s3MalwareProtection.s3Configurations ?? []) {
      // FILTER: Only process configurations for current account and region
      if (
        s3Item.region === currentRegion &&
        this.props.accountsConfig.getAccountId(s3Item.account) === currentAccount
      ) {
        // DEDUPLICATION: Only add bucket if it exists and isn't already in the array
        if (s3Item.s3BucketName && !s3Buckets.includes(s3Item.s3BucketName)) {
          s3Buckets.push(s3Item.s3BucketName);
          this.logger.info(`Added S3 bucket for malware protection: ${s3Item.s3BucketName}`);
        }
      }
    }

    // STEP 4: Log summary of discovered buckets
    if (s3Buckets.length > 0) {
      this.logger.info(
        `Found ${s3Buckets.length} unique S3 bucket(s) for Malware Protection in account ${currentAccount}, region ${currentRegion}`,
      );
      s3Buckets.forEach(bucket => {
        this.logger.info(`  - ${bucket}`);
      });
    } else {
      this.logger.info(
        `No S3 buckets found for Malware Protection in account ${currentAccount}, region ${currentRegion}`,
      );
    }

    return s3Buckets;
  }
}
