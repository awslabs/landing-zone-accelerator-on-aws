// Vitest Snapshot v1, https://vitest.dev/guide/snapshot.html

exports[`InstallerContainerStack > Construct(InstallerContainerStack): Default Configuration Snapshot Test 1`] = `
{
  "Conditions": {
    "CreateConfigCondition": {
      "Fn::Equals": [
        "No",
        {
          "Ref": "UseExistingConfig",
        },
      ],
    },
    "CreateVpcCondition": {
      "Fn::Equals": [
        "No",
        {
          "Ref": "UseExistingVpc",
        },
      ],
    },
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "Source Configuration",
          },
          "Parameters": [
            "EcrUri",
          ],
        },
        {
          "Label": {
            "default": "Mandatory Accounts Configuration",
          },
          "Parameters": [
            "ManagementAccountEmail",
            "LogArchiveAccountEmail",
            "AuditAccountEmail",
          ],
        },
        {
          "Label": {
            "default": "Environment Configuration",
          },
          "Parameters": [
            "ControlTowerEnabled",
            "AcceleratorPrefix",
            "PythonRuntimeVersion",
            "LogLevel",
          ],
        },
        {
          "Label": {
            "default": "Config Bucket Configuration",
          },
          "Parameters": [
            "UseExistingConfig",
            "ExistingConfigBucketName",
            "ExistingConfigBucketKey",
          ],
        },
        {
          "Label": {
            "default": "Network Configuration",
          },
          "Parameters": [
            "VpcCidr",
            "UseExistingVpc",
            "ExistingVpcId",
            "ExistingSubnetId",
            "ExistingSecurityGroupId",
          ],
        },
      ],
      "ParameterLabels": {
        "AcceleratorPrefix": {
          "default": "Accelerator Resource name prefix",
        },
        "AuditAccountEmail": {
          "default": "Audit Account Email",
        },
        "ControlTowerEnabled": {
          "default": "Control Tower Environment",
        },
        "EcrUri": {
          "default": "ECR URI",
        },
        "ExistingSecurityGroupId": {
          "default": "Existing Security Group ID",
        },
        "ExistingSubnetId": {
          "default": "Existing Subnet ID",
        },
        "ExistingVpcId": {
          "default": "Existing VPC ID",
        },
        "LogArchiveAccountEmail": {
          "default": "Log Archive Account Email",
        },
        "LogLevel": {
          "default": "Log Level",
        },
        "ManagementAccountEmail": {
          "default": "Management Account Email",
        },
        "PythonRuntimeVersion": {
          "default": "Python Runtime Version (for SSM aws:executeScript)",
        },
        "UseExistingVpc": {
          "default": "Use Existing VPC",
        },
        "VpcCidr": {
          "default": "VPC CIDR Block",
        },
      },
    },
  },
  "Outputs": {
    "DeploySolutionDocumentOutput": {
      "Description": "SSM Document name that will be used to trigger automation for LZA engine using container",
      "Value": {
        "Ref": "DeploySolutionDocument",
      },
    },
  },
  "Parameters": {
    "AcceleratorPrefix": {
      "AllowedPattern": "[A-Za-z0-9-]+",
      "Default": "AWSAccelerator",
      "Description": "The prefix value for accelerator deployed resources. Leave the default value if using solution defined resource name prefix, the solution will use AWSAccelerator as resource name prefix. Note: Updating this value after initial installation will cause stack failure. Non-default value can not start with keyword "aws" or "ssm". Trailing dash (-) in non-default value will be ignored.",
      "MaxLength": 15,
      "Type": "String",
    },
    "AuditAccountEmail": {
      "AllowedPattern": "[^\\s@]+@[^\\s@]+\\.[^\\s@]+",
      "ConstraintDescription": "Must be a valid email address matching "[^\\s@]+@[^\\s@]+\\.[^\\s@]+"",
      "Description": "The security audit account (also referred to as the audit account)",
      "Type": "String",
    },
    "ControlTowerEnabled": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "Yes",
      "Description": "Select yes if deploying to a Control Tower environment.  Select no if using just Organizations. If no, you must first set up mandatory accounts.",
      "Type": "String",
    },
    "EcrUri": {
      "Description": "The Amazon Elastic Container Registry (Amazon ECR) repository, where Landing Zone Accelerator on AWS code is present.",
      "Type": "String",
    },
    "ExistingConfigBucketKey": {
      "Default": "",
      "Description": "Specify the branch name of the existing LZA configuration bucket key to pull the accelerator configuration from.",
      "Type": "String",
    },
    "ExistingConfigBucketName": {
      "Default": "",
      "Description": "The name of an existing LZA configuration bucket hosting the accelerator configuration.",
      "Type": "String",
    },
    "ExistingSecurityGroupId": {
      "Default": "",
      "Description": "The ID of an existing security group (required when UseExistingVpc is Yes)",
      "Type": "String",
    },
    "ExistingSubnetId": {
      "Default": "",
      "Description": "The ID of an existing subnet (required when UseExistingVpc is Yes)",
      "Type": "String",
    },
    "ExistingVpcId": {
      "Default": "",
      "Description": "The ID of an existing VPC (required when UseExistingVpc is Yes)",
      "Type": "String",
    },
    "LogArchiveAccountEmail": {
      "AllowedPattern": "[^\\s@]+@[^\\s@]+\\.[^\\s@]+",
      "ConstraintDescription": "Must be a valid email address matching "[^\\s@]+@[^\\s@]+\\.[^\\s@]+"",
      "Description": "The log archive account email",
      "Type": "String",
    },
    "LogLevel": {
      "AllowedValues": [
        "error",
        "info",
        "debug",
      ],
      "Default": "error",
      "Description": "The log level for LZA engine. Controls the verbosity of logs generated during deployment.",
      "Type": "String",
    },
    "ManagementAccountEmail": {
      "AllowedPattern": "[^\\s@]+@[^\\s@]+\\.[^\\s@]+",
      "ConstraintDescription": "Must be a valid email address matching "[^\\s@]+@[^\\s@]+\\.[^\\s@]+"",
      "Description": "The management (primary) account email - NOTE: This must match the address of the management account email as listed in AWS Organizations > AWS accounts.",
      "Type": "String",
    },
    "PythonRuntimeVersion": {
      "Default": "python3.11",
      "Description": "The Python runtime version for SSM Document aws:executeScript actions. Must match SSM supported runtimes (e.g., python3.8, python3.9, python3.10, python3.11).",
      "Type": "String",
    },
    "UseExistingConfig": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Select Yes if deploying the solution with an existing configuration. Leave the default value if using the solution-deployed bucket. If the AcceleratorPrefix parameter is set to the default value, the solution will deploy a bucket named "aws-accelerator-config-$account-$region." Otherwise, the solution-deployed bucket will be named "AcceleratorPrefix-config-$account-$region." Note: Updating this value after initial installation may cause adverse affects.",
      "Type": "String",
    },
    "UseExistingVpc": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Select Yes to use an existing VPC. If Yes, provide existing subnet and security group IDs.",
      "Type": "String",
    },
    "VpcCidr": {
      "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$",
      "Default": "10.0.0.0/16",
      "Description": "The CIDR block for the VPC (used when UseExistingVpc is No)",
      "Type": "String",
    },
  },
  "Resources": {
    "AcceleratorManagementKmsArnParameter1E6975BF": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/installer/kms/key-arn",
            ],
          ],
        },
        "Type": "String",
        "Value": {
          "Fn::GetAtt": [
            "InstallerKey2A6A8C6D",
            "Arn",
          ],
        },
      },
      "Type": "AWS::SSM::Parameter",
    },
    "ConfigBucket": {
      "Condition": "CreateConfigCondition",
      "DeletionPolicy": "Retain",
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "KMSMasterKeyID": {
                  "Fn::GetAtt": [
                    "InstallerKey2A6A8C6D",
                    "Arn",
                  ],
                },
                "SSEAlgorithm": "aws:kms",
              },
            },
          ],
        },
        "BucketName": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-config-",
              {
                "Ref": "AWS::AccountId",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
            ],
          ],
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "AbortIncompleteMultipartUpload": {
                "DaysAfterInitiation": 1,
              },
              "ExpirationInDays": 1825,
              "ExpiredObjectDeleteMarker": false,
              "Id": {
                "Fn::Join": [
                  "",
                  [
                    "LifecycleRule",
                    {
                      "Fn::GetAtt": [
                        "ResourceNamePrefixesGetPrefixResource96A10E6E",
                        "lowerCasePrefix",
                      ],
                    },
                    "-config-",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    "-",
                    {
                      "Ref": "AWS::Region",
                    },
                  ],
                ],
              },
              "NoncurrentVersionExpiration": {
                "NoncurrentDays": 1825,
              },
              "NoncurrentVersionTransitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 366,
                },
              ],
              "Status": "Enabled",
              "Transitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 365,
                },
              ],
            },
          ],
        },
        "LoggingConfiguration": {
          "DestinationBucketName": {
            "Ref": "InstallerAccessLogsBucket647700E9",
          },
          "LogFilePrefix": {
            "Fn::Join": [
              "",
              [
                {
                  "Fn::GetAtt": [
                    "ResourceNamePrefixesGetPrefixResource96A10E6E",
                    "lowerCasePrefix",
                  ],
                },
                "-config-",
                {
                  "Ref": "AWS::AccountId",
                },
                "-",
                {
                  "Ref": "AWS::Region",
                },
                "/",
              ],
            ],
          },
        },
        "OwnershipControls": {
          "Rules": [
            {
              "ObjectOwnership": "BucketOwnerPreferred",
            },
          ],
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true,
        },
        "VersioningConfiguration": {
          "Status": "Enabled",
        },
      },
      "Type": "AWS::S3::Bucket",
      "UpdateReplacePolicy": "Retain",
    },
    "ConfigBucketPolicy": {
      "Condition": "CreateConfigCondition",
      "Properties": {
        "Bucket": {
          "Ref": "ConfigBucket",
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:*",
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false",
                },
              },
              "Effect": "Deny",
              "Principal": {
                "AWS": "*",
              },
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "ConfigBucket",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "ConfigBucket",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
              "Sid": "deny-insecure-connections",
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::S3::BucketPolicy",
    },
    "DeploySolutionDocument": {
      "Properties": {
        "Content": {
          "assumeRole": "{{AutomationAssumeRole}}",
          "description": "Automation document to deploy Landing Zone Accelerator on AWS (LZA) solution by running ECS Fargate tasks in a private subnet",
          "mainSteps": [
            {
              "action": "aws:executeScript",
              "description": "Starts a new ECS task and returns task details with CloudWatch log URL",
              "inputs": {
                "Handler": "handler",
                "InputPayload": {
                  "Cluster": "{{Cluster}}",
                  "LogGroupName": {
                    "Ref": "LogGroup",
                  },
                  "Region": {
                    "Ref": "AWS::Region",
                  },
                  "SecurityGroupId": "{{SecurityGroupId}}",
                  "SolutionId": "AwsSolution/SO0199/1.15.0",
                  "SubnetId": "{{SubnetId}}",
                  "TaskDefinition": "{{TaskDefinition}}",
                },
                "Runtime": "{{PythonRuntime}}",
                "Script": "REPLACED-JSON-PATH.json",
              },
              "name": "RunTask",
              "outputs": [
                {
                  "Name": "ClusterName",
                  "Selector": "$.Payload.ClusterName",
                  "Type": "String",
                },
                {
                  "Name": "TaskArn",
                  "Selector": "$.Payload.TaskArn",
                  "Type": "String",
                },
                {
                  "Name": "LogGroupName",
                  "Selector": "$.Payload.LogGroupName",
                  "Type": "String",
                },
                {
                  "Name": "LogStreamName",
                  "Selector": "$.Payload.LogStreamName",
                  "Type": "String",
                },
              ],
              "timeoutSeconds": 600,
            },
            {
              "action": "aws:waitForAwsResourceProperty",
              "description": "Wait for ECS task to complete",
              "inputs": {
                "Api": "DescribeTasks",
                "DesiredValues": [
                  "STOPPED",
                ],
                "PropertySelector": "$.tasks[0].lastStatus",
                "Service": "ecs",
                "cluster": "{{RunTask.ClusterName}}",
                "tasks": [
                  "{{RunTask.TaskArn}}",
                ],
              },
              "name": "WaitForTaskCompletion",
              "outputs": [
                {
                  "Name": "TaskStatus",
                  "Selector": "$.tasks[0].lastStatus",
                  "Type": "String",
                },
              ],
              "timeoutSeconds": 43200,
            },
            {
              "action": "aws:executeScript",
              "description": "Verifies the container exit code after task completion and fails the automation if exit code is non-zero",
              "inputs": {
                "Handler": "handler",
                "InputPayload": {
                  "ClusterName": "{{RunTask.ClusterName}}",
                  "LogGroupName": "{{RunTask.LogGroupName}}",
                  "LogStreamName": "{{RunTask.LogStreamName}}",
                  "Region": {
                    "Ref": "AWS::Region",
                  },
                  "SolutionId": "AwsSolution/SO0199/1.15.0",
                  "TaskArn": "{{RunTask.TaskArn}}",
                },
                "Runtime": "{{PythonRuntime}}",
                "Script": "import boto3
from botocore.config import Config

def handler(event, context):
    config = Config(user_agent_extra=event['SolutionId']) 
    client = boto3.client('ecs', region_name=event['Region'], config=config)
    
    response = client.describe_tasks(
        cluster=event['ClusterName'],
        tasks=[event['TaskArn']]
    )
    
    if not response['tasks']:
        raise Exception(f"Task not found: {event['TaskArn']}")
    
    task = response['tasks'][0]
    containers = task.get('containers', [])
    
    if not containers:
        raise Exception(f"No containers found in task: {event['TaskArn']}")
    
    # Extract exit code from tasks[0].containers[0].exitCode
    container = containers[0]
    exit_code = container.get('exitCode')  # Can be 0, 1, 137, etc. or None if killed
    
    # Extract task-level stop information
    stop_code = task.get('stopCode', 'Unknown')  # e.g., "EssentialContainerExited"
    stop_reason = task.get('stoppedReason', 'Unknown')  # e.g., "Essential container in task exited"
    task_status = task.get('lastStatus', 'Unknown')
    
    result = {
        'ExitCode': exit_code if exit_code is not None else -1,
        'StopCode': stop_code,
        'StopReason': stop_reason,
        'TaskStatus': task_status,
        'LogStreamName': event['LogStreamName'],
        'LogGroupName': event['LogGroupName']
    }
    
    # Fail if exit code is non-zero or None (container was killed)
    if exit_code is None or exit_code != 0:
        error_msg = (
            f"ECS task failed with exit code {exit_code}. "
            f"Stop code: {stop_code}. "
            f"Stop reason: {stop_reason}. "
            f"Check CloudWatch logs: {event['LogGroupName']}/{event['LogStreamName']}"
        )
        raise Exception(error_msg)
    
    return result",
              },
              "name": "CheckTaskExitCode",
              "outputs": [
                {
                  "Name": "ExitCode",
                  "Selector": "$.Payload.ExitCode",
                  "Type": "Integer",
                },
                {
                  "Name": "StopCode",
                  "Selector": "$.Payload.StopCode",
                  "Type": "String",
                },
                {
                  "Name": "StopReason",
                  "Selector": "$.Payload.StopReason",
                  "Type": "String",
                },
                {
                  "Name": "TaskStatus",
                  "Selector": "$.Payload.TaskStatus",
                  "Type": "String",
                },
              ],
              "timeoutSeconds": 600,
            },
          ],
          "outputs": [
            "RunTask.TaskArn",
            "RunTask.ClusterName",
            "RunTask.LogGroupName",
            "RunTask.LogStreamName",
            "WaitForTaskCompletion.TaskStatus",
            "CheckTaskExitCode.ExitCode",
            "CheckTaskExitCode.StopCode",
            "CheckTaskExitCode.StopReason",
          ],
          "parameters": {
            "AutomationAssumeRole": {
              "default": {
                "Fn::GetAtt": [
                  "SsmAutomationRole",
                  "Arn",
                ],
              },
              "description": "The ARN of the IAM role that allows Systems Manager Automation to perform actions",
              "type": "String",
            },
            "Cluster": {
              "default": {
                "Ref": "EcsCluster",
              },
              "description": "The short name or full ARN of the cluster to run your task on",
              "type": "String",
            },
            "PythonRuntime": {
              "default": {
                "Ref": "PythonRuntimeVersion",
              },
              "description": "The Python runtime version for aws:executeScript actions",
              "type": "String",
            },
            "SecurityGroupId": {
              "default": {
                "Fn::If": [
                  "CreateVpcCondition",
                  {
                    "Ref": "SecurityGroup",
                  },
                  {
                    "Ref": "ExistingSecurityGroupId",
                  },
                ],
              },
              "description": "The security group used by the ECS task",
              "type": "String",
            },
            "SubnetId": {
              "default": {
                "Fn::If": [
                  "CreateVpcCondition",
                  {
                    "Ref": "PrivateSubnet0",
                  },
                  {
                    "Ref": "ExistingSubnetId",
                  },
                ],
              },
              "description": "The subnet where the ECS task will be placed",
              "type": "String",
            },
            "TaskDefinition": {
              "default": {
                "Ref": "TaskDefinition",
              },
              "description": "The family and revision or full ARN of the task definition to run",
              "type": "String",
            },
          },
          "schemaVersion": "0.3",
        },
        "DocumentType": "Automation",
        "Name": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "acceleratorPrefix",
                ],
              },
              "-RunEngine",
            ],
          ],
        },
        "UpdateMethod": "NewVersion",
      },
      "Type": "AWS::SSM::Document",
    },
    "EcsCluster": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-ECS4",
              "reason": "The ECS Cluster has CloudWatch Container Insights are not present in all partitions.",
            },
            {
              "id": "AwsSolutions-ECS7",
              "reason": "The ECS task definition used has logging enabled to CloudWatch logs.",
            },
          ],
        },
      },
      "Properties": {
        "ClusterName": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-ecs-cluster",
            ],
          ],
        },
      },
      "Type": "AWS::ECS::Cluster",
    },
    "EcsExecutionRole": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "The ECS task needs admin access to orchestrate the engine.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/AdministratorAccess",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "EcsTaskRole": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "The ECS task needs admin access to orchestrate LZA deployment and manage AWS resources.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/AdministratorAccess",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "InstallerAccessLogsBucket647700E9": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-S1",
              "reason": "AccessLogsBucket has server access logs disabled till the task for access logging completed.",
            },
          ],
        },
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W35",
              "reason": "This is an access logging bucket.",
            },
          ],
        },
      },
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256",
              },
            },
          ],
        },
        "BucketName": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-s3-logs-",
              {
                "Ref": "AWS::AccountId",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
            ],
          ],
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "AbortIncompleteMultipartUpload": {
                "DaysAfterInitiation": 1,
              },
              "ExpirationInDays": 1825,
              "ExpiredObjectDeleteMarker": false,
              "Id": {
                "Fn::Join": [
                  "",
                  [
                    "LifecycleRule",
                    {
                      "Fn::GetAtt": [
                        "ResourceNamePrefixesGetPrefixResource96A10E6E",
                        "lowerCasePrefix",
                      ],
                    },
                    "-s3-logs-",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    "-",
                    {
                      "Ref": "AWS::Region",
                    },
                  ],
                ],
              },
              "NoncurrentVersionExpiration": {
                "NoncurrentDays": 1825,
              },
              "NoncurrentVersionTransitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 366,
                },
              ],
              "Status": "Enabled",
              "Transitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 365,
                },
              ],
            },
          ],
        },
        "OwnershipControls": {
          "Rules": [
            {
              "ObjectOwnership": "BucketOwnerPreferred",
            },
          ],
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true,
        },
        "VersioningConfiguration": {
          "Status": "Enabled",
        },
      },
      "Type": "AWS::S3::Bucket",
      "UpdateReplacePolicy": "Retain",
    },
    "InstallerAccessLogsBucketName4F700F48": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/installer-access-logs-bucket-name",
            ],
          ],
        },
        "Type": "String",
        "Value": {
          "Ref": "InstallerAccessLogsBucket647700E9",
        },
      },
      "Type": "AWS::SSM::Parameter",
    },
    "InstallerAccessLogsBucketPolicy20D4E285": {
      "Properties": {
        "Bucket": {
          "Ref": "InstallerAccessLogsBucket647700E9",
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:*",
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false",
                },
              },
              "Effect": "Deny",
              "Principal": {
                "AWS": "*",
              },
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "InstallerAccessLogsBucket647700E9",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "InstallerAccessLogsBucket647700E9",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
              "Sid": "deny-insecure-connections",
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::S3::BucketPolicy",
    },
    "InstallerKey2A6A8C6D": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "F76",
              "reason": "KMS key using * principal with added arn condition",
            },
          ],
        },
      },
      "Properties": {
        "Description": "KMS key for encrypting LZA installer S3 configuration bucket in the management account",
        "EnableKeyRotation": true,
        "KeyPolicy": {
          "Statement": [
            {
              "Action": "kms:*",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":iam::",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":root",
                    ],
                  ],
                },
              },
              "Resource": "*",
            },
            {
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ],
              "Condition": {
                "ArnLike": {
                  "aws:PrincipalARN": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":iam::",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":role/",
                        {
                          "Fn::GetAtt": [
                            "ResourceNamePrefixesGetPrefixResource96A10E6E",
                            "acceleratorPrefix",
                          ],
                        },
                        "-*",
                      ],
                    ],
                  },
                },
              },
              "Effect": "Allow",
              "Principal": {
                "AWS": "*",
              },
              "Resource": "*",
              "Sid": "Allow Accelerator Role to use the encryption key",
            },
            {
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": "sns.amazonaws.com",
              },
              "Resource": "*",
              "Sid": "Allow SNS service to use the encryption key",
            },
            {
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ],
              "Condition": {
                "ArnLike": {
                  "kms:EncryptionContext:aws:logs:arn": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":logs:",
                        {
                          "Ref": "AWS::Region",
                        },
                        ":",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":log-group:*",
                      ],
                    ],
                  },
                },
              },
              "Effect": "Allow",
              "Principal": {
                "Service": {
                  "Fn::Join": [
                    "",
                    [
                      "logs.",
                      {
                        "Ref": "AWS::Region",
                      },
                      ".amazonaws.com",
                    ],
                  ],
                },
              },
              "Resource": "*",
              "Sid": "Allow Cloudwatch Logs service to use the encryption key",
            },
          ],
        },
      },
      "Type": "AWS::KMS::Key",
      "UpdateReplacePolicy": "Retain",
    },
    "InstallerKeyAliasD5C174F0": {
      "Properties": {
        "AliasName": {
          "Fn::Join": [
            "",
            [
              "alias/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/installer/kms/key",
            ],
          ],
        },
        "TargetKeyId": {
          "Fn::GetAtt": [
            "InstallerKey2A6A8C6D",
            "Arn",
          ],
        },
      },
      "Type": "AWS::KMS::Alias",
    },
    "InternetGateway": {
      "Condition": "CreateVpcCondition",
      "Type": "AWS::EC2::InternetGateway",
    },
    "LogGroup": {
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/ecs/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-lza-deployment",
            ],
          ],
        },
        "RetentionInDays": 365,
      },
      "Type": "AWS::Logs::LogGroup",
    },
    "NatEip0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "Domain": "vpc",
      },
      "Type": "AWS::EC2::EIP",
    },
    "NatEip1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "Domain": "vpc",
      },
      "Type": "AWS::EC2::EIP",
    },
    "NatGateway0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "NatEip0",
            "AllocationId",
          ],
        },
        "SubnetId": {
          "Ref": "PublicSubnet0",
        },
      },
      "Type": "AWS::EC2::NatGateway",
    },
    "NatGateway1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "NatEip1",
            "AllocationId",
          ],
        },
        "SubnetId": {
          "Ref": "PublicSubnet1",
        },
      },
      "Type": "AWS::EC2::NatGateway",
    },
    "PrivateRoute0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "NatGateway0",
        },
        "RouteTableId": {
          "Ref": "PrivateRouteTable0",
        },
      },
      "Type": "AWS::EC2::Route",
    },
    "PrivateRoute1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "NatGateway1",
        },
        "RouteTableId": {
          "Ref": "PrivateRouteTable1",
        },
      },
      "Type": "AWS::EC2::Route",
    },
    "PrivateRouteTable0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::RouteTable",
    },
    "PrivateRouteTable1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::RouteTable",
    },
    "PrivateSubnet0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            0,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.10.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PrivateSubnet1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            1,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.11.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PrivateSubnetRouteTableAssociation0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PrivateRouteTable0",
        },
        "SubnetId": {
          "Ref": "PrivateSubnet0",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "PrivateSubnetRouteTableAssociation1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PrivateRouteTable1",
        },
        "SubnetId": {
          "Ref": "PrivateSubnet1",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "PublicRoute": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "InternetGateway",
        },
        "RouteTableId": {
          "Ref": "PublicRouteTable",
        },
      },
      "Type": "AWS::EC2::Route",
    },
    "PublicRouteTable": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::RouteTable",
    },
    "PublicSubnet0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            0,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.0.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PublicSubnet1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            1,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.1.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PublicSubnetRouteTableAssociation0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PublicRouteTable",
        },
        "SubnetId": {
          "Ref": "PublicSubnet0",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "PublicSubnetRouteTableAssociation1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PublicRouteTable",
        },
        "SubnetId": {
          "Ref": "PublicSubnet1",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "ResourceNamePrefixesGetPrefixResource96A10E6E": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "ResourceNamePrefixesResourceNamePrefixesFunction138C66F1",
            "Arn",
          ],
        },
        "pipelineStackVersionSsmParamName": {
          "Fn::Join": [
            "",
            [
              "/accelerator/AWSAccelerator-PipelineStack-",
              {
                "Ref": "AWS::AccountId",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
              "/version",
            ],
          ],
        },
        "prefix": {
          "Ref": "AcceleratorPrefix",
        },
        "prefixParameterName": "/accelerator/lza-prefix",
      },
      "Type": "Custom::GetPrefixes",
      "UpdateReplacePolicy": "Delete",
    },
    "ResourceNamePrefixesResourceNamePrefixesFunction138C66F1": {
      "DependsOn": [
        "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRoleDefaultPolicyDC1CC159",
        "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2",
      ],
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "Needed to write to CWL group",
            },
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Needed to create SSM parameter for prefix",
            },
          ],
        },
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W58",
              "reason": "CloudWatch Logs are enabled in AWSLambdaBasicExecutionRole",
            },
            {
              "id": "W89",
              "reason": "This function supports infrastructure deployment and is not deployed inside a VPC.",
            },
            {
              "id": "W92",
              "reason": "This function supports infrastructure deployment and does not require setting ReservedConcurrentExecutions.",
            },
          ],
        },
      },
      "Properties": {
        "Code": {
          "ZipFile": "
          const response = require('cfn-response'); 
          const { SSMClient, DeleteParameterCommand, GetParameterCommand, ParameterNotFound, PutParameterCommand } = require("@aws-sdk/client-ssm");
          const { ConfiguredRetryStrategy } = require("@aws-sdk/util-retry");
          exports.handler = async function (event, context) { 
          console.log(JSON.stringify(event, null, 4)); 
          const prefix=event.ResourceProperties.prefix;
          const pipelineStackVersionSsmParamName=event.ResourceProperties.pipelineStackVersionSsmParamName;
          const lowerCasePrefix=prefix.toLowerCase();
          
          const ssm = new SSMClient({retryStrategy: new ConfiguredRetryStrategy(10, (attempt) => 100 + attempt * 1000)});
          
          let data = {};
          
          let paramName = event.ResourceProperties.prefixParameterName;
          
          if (lowerCasePrefix === 'awsaccelerator') {
              data['acceleratorPrefix'] = 'AWSAccelerator';
              data['lowerCasePrefix'] = 'aws-accelerator'; 
              data['oneWordPrefix'] = 'accelerator';               
          } else {
              data['acceleratorPrefix'] = prefix;
              data['lowerCasePrefix'] = lowerCasePrefix; 
              data['oneWordPrefix'] = prefix; 
          }
                  

          if (event.RequestType === 'Update'){

              var params = {
                Name: paramName,
              };
              try {
                  const ssmResponse = await ssm.send(new GetParameterCommand(params));
                  // Fail stack if prefix was changed during update
                  if (ssmResponse.Parameter.Value !== prefix) {
                      await response.send(event, context, response.FAILED, {'FailureReason': 'LZA does not allow changing AcceleratorPrefix parameter value after initial deploy !!! Existing prefix: ' + event.OldResourceProperties.prefix + ' New prefix: ' + prefix + '.' }, event.PhysicalResourceId);
                      return;
                  }
                  await response.send(event, context, response.SUCCESS, data, event.PhysicalResourceId);
              } catch (error) {
                  console.log(error);
                  if (error instanceof ParameterNotFound){
                      await response.send(event, context, response.FAILED, {'FailureReason': 'LZA prefix ssm parameter ' + paramName + ' not found!!! Recreate the parameter with existing AcceleratorPrefix parameter value to fix the issue'}, event.PhysicalResourceId);
                      return;
                  }
                  else {
                      await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while accessing LZA prefix ssm parameter ' + paramName }, event.PhysicalResourceId);
                      return;
                  }
              }          
          } 
          
          if (event.RequestType === 'Create') {
          
              if (lowerCasePrefix !== 'awsaccelerator') {
                  // Fail stack if prefix starts with aws or ssm
                  if (lowerCasePrefix.startsWith('aws') || lowerCasePrefix.startsWith('ssm')) { 
                      await response.send(event, context, response.FAILED, {'FailureReason': 'Accelerator prefix ' + prefix + ' can not be started with aws or ssm !!!'}, event.PhysicalResourceId);
                      return;
                  }

                  // Check if this is an existing deployment and prefix changed with initial deployment of custom resource
                  var versionParams = {
                    Name: pipelineStackVersionSsmParamName,
                  };
                  try {
                    await ssm.send(new GetParameterCommand(versionParams));
                    await response.send(event, context, response.FAILED, {'FailureReason': 'Can not change AcceleratorPrefix parameter for existing deployment, existing prefix value is AWSAccelerator, keep AcceleratorPrefix parameter value to default value for successfully stack update !!!'}, event.PhysicalResourceId);
                    return;
                  }
                  catch (error) {
                    console.log(error);
                    if (!(error instanceof ParameterNotFound)){
                      await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while accessing LZA ssm parameter ' + pipelineStackVersionSsmParamName }, event.PhysicalResourceId);
                      return;
                    }
                  }
              }
          
              // Create /accelerator/lza-prefix SSM parameter to store prefix value to protect updating prefix
              try {
                  var newParams = {
                        Name: paramName,
                        Value: prefix,
                        Description: 'LZA created SSM parameter for Accelerator prefix value, DO NOT MODIFY/DELETE this parameter',
                        Type: 'String',
                      };
                  await ssm.send(new PutParameterCommand(newParams));
                  await response.send(event, context, response.SUCCESS, data, event.PhysicalResourceId);
              }
              catch (error) {
                  console.log(error);
                  await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while creating LZA prefix ssm parameter ' + paramName }, event.PhysicalResourceId);
                  return;
              }
          }
          if (event.RequestType === 'Delete') {

            var deleteParams = {
              Name: paramName,
            };
            try {
              await ssm.send(new DeleteParameterCommand(deleteParams));
            }
            catch (error) {
              console.log(error);
              if (!(error instanceof ParameterNotFound)){
                await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while deleting LZA ssm parameter ' + paramName }, event.PhysicalResourceId);
                return;
              }
            }
            await response.send(event, context, response.SUCCESS, {'Status': 'Custom resource deleted successfully' }, event.PhysicalResourceId);
          }
          
          return;
      }",
        },
        "Description": "This function converts accelerator prefix parameter to lower case to name s3 buckets in installer stack",
        "Handler": "index.handler",
        "Role": {
          "Fn::GetAtt": [
            "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2",
            "Arn",
          ],
        },
        "Runtime": "nodejs22.x",
      },
      "Type": "AWS::Lambda::Function",
    },
    "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "Needed to write to CWL group",
            },
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Needed to create SSM parameter for prefix",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRoleDefaultPolicyDC1CC159": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "Needed to write to CWL group",
            },
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Needed to create SSM parameter for prefix",
            },
          ],
        },
      },
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "ssm:GetParameters",
                "ssm:GetParameter",
                "ssm:PutParameter",
                "ssm:DeleteParameter",
              ],
              "Condition": {
                "StringEquals": {
                  "aws:PrincipalAccount": {
                    "Ref": "AWS::AccountId",
                  },
                },
              },
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":ssm:",
                      {
                        "Ref": "AWS::Region",
                      },
                      ":",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":parameter/accelerator/lza-prefix",
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":ssm:",
                      {
                        "Ref": "AWS::Region",
                      },
                      ":",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":parameter/accelerator/AWSAccelerator-PipelineStack-",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      "-",
                      {
                        "Ref": "AWS::Region",
                      },
                      "/version",
                    ],
                  ],
                },
              ],
              "Sid": "SsmReadParameterAccess",
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRoleDefaultPolicyDC1CC159",
        "Roles": [
          {
            "Ref": "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "SecurityGroup": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "GroupDescription": "Security group for VPC",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::SecurityGroup",
    },
    "SsmAutomationRole": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Wild card permissions are needed on describe and run task calls.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ssm.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "ecs:RunTask",
                    "ecs:DescribeTasks",
                  ],
                  "Effect": "Allow",
                  "Resource": "*",
                },
                {
                  "Action": [
                    "iam:PassRole",
                  ],
                  "Effect": "Allow",
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "EcsExecutionRole",
                        "Arn",
                      ],
                    },
                    {
                      "Fn::GetAtt": [
                        "EcsTaskRole",
                        "Arn",
                      ],
                    },
                  ],
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "EcsRunTaskPolicy",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "SsmParamAcceleratorVersionFF83282D": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/TestInstallerContainerStack/version",
            ],
          ],
        },
        "Type": "String",
        "Value": "1.15.0",
      },
      "Type": "AWS::SSM::Parameter",
    },
    "SsmParamStackId521A78D3": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/TestInstallerContainerStack/stack-id",
            ],
          ],
        },
        "Type": "String",
        "Value": {
          "Ref": "AWS::StackId",
        },
      },
      "Type": "AWS::SSM::Parameter",
    },
    "TaskDefinition": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-ECS2",
              "reason": "Environment variables are needed to turn off features made for services relying on CodePipeline and CodeBuild",
            },
          ],
        },
      },
      "Properties": {
        "ContainerDefinitions": [
          {
            "Command": [
              "/landing-zone-accelerator-on-aws/scripts/run-lza.sh deploy",
            ],
            "EntryPoint": [
              "sh",
              "-c",
            ],
            "Environment": [
              {
                "Name": "ENABLE_DIAGNOSTICS_PACK",
                "Value": "No",
              },
              {
                "Name": "SkipPipelinePrerequisites",
                "Value": "true",
              },
              {
                "Name": "SkipAcceleratorPrerequisites",
                "Value": "true",
              },
              {
                "Name": "AWS_REGION",
                "Value": {
                  "Ref": "AWS::Region",
                },
              },
              {
                "Name": "CONFIG_S3_PATH",
                "Value": {
                  "Fn::If": [
                    "CreateConfigCondition",
                    {
                      "Fn::Join": [
                        "",
                        [
                          "s3://",
                          {
                            "Fn::GetAtt": [
                              "ResourceNamePrefixesGetPrefixResource96A10E6E",
                              "lowerCasePrefix",
                            ],
                          },
                          "-config-",
                          {
                            "Ref": "AWS::AccountId",
                          },
                          "-",
                          {
                            "Ref": "AWS::Region",
                          },
                          "/lza/aws-accelerator-config.zip",
                        ],
                      ],
                    },
                    {
                      "Fn::Join": [
                        "",
                        [
                          "s3://",
                          {
                            "Ref": "ExistingConfigBucketName",
                          },
                          "/",
                          {
                            "Ref": "ExistingConfigBucketKey",
                          },
                        ],
                      ],
                    },
                  ],
                },
              },
              {
                "Name": "CONFIG_S3_BUCKET",
                "Value": {
                  "Fn::If": [
                    "CreateConfigCondition",
                    {
                      "Fn::Join": [
                        "",
                        [
                          {
                            "Fn::GetAtt": [
                              "ResourceNamePrefixesGetPrefixResource96A10E6E",
                              "lowerCasePrefix",
                            ],
                          },
                          "-config-",
                          {
                            "Ref": "AWS::AccountId",
                          },
                          "-",
                          {
                            "Ref": "AWS::Region",
                          },
                        ],
                      ],
                    },
                    {
                      "Ref": "ExistingConfigBucketName",
                    },
                  ],
                },
              },
              {
                "Name": "CONFIG_S3_KEY",
                "Value": {
                  "Fn::If": [
                    "CreateConfigCondition",
                    "lza/aws-accelerator-config.zip",
                    {
                      "Ref": "ExistingConfigBucketKey",
                    },
                  ],
                },
              },
              {
                "Name": "CONFIG_BUCKET_NAME",
                "Value": {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "ResourceNamePrefixesGetPrefixResource96A10E6E",
                          "lowerCasePrefix",
                        ],
                      },
                      "-config-",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      "-",
                      {
                        "Ref": "AWS::Region",
                      },
                    ],
                  ],
                },
              },
              {
                "Name": "MANAGEMENT_ACCOUNT_EMAIL",
                "Value": {
                  "Ref": "ManagementAccountEmail",
                },
              },
              {
                "Name": "LOG_ARCHIVE_ACCOUNT_EMAIL",
                "Value": {
                  "Ref": "LogArchiveAccountEmail",
                },
              },
              {
                "Name": "AUDIT_ACCOUNT_EMAIL",
                "Value": {
                  "Ref": "AuditAccountEmail",
                },
              },
              {
                "Name": "CONTROL_TOWER_ENABLED",
                "Value": {
                  "Ref": "ControlTowerEnabled",
                },
              },
              {
                "Name": "ACCELERATOR_PREFIX",
                "Value": {
                  "Fn::GetAtt": [
                    "ResourceNamePrefixesGetPrefixResource96A10E6E",
                    "acceleratorPrefix",
                  ],
                },
              },
              {
                "Name": "INSTALLER_STACK_NAME",
                "Value": {
                  "Fn::Sub": "\${AWS::StackName}",
                },
              },
              {
                "Name": "PARTITION",
                "Value": {
                  "Fn::Sub": "\${AWS::Partition}",
                },
              },
              {
                "Name": "PIPELINE_ACCOUNT_ID",
                "Value": {
                  "Ref": "AWS::AccountId",
                },
              },
              {
                "Name": "LOG_LEVEL",
                "Value": {
                  "Ref": "LogLevel",
                },
              },
            ],
            "Image": {
              "Ref": "EcrUri",
            },
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-group": {
                  "Ref": "LogGroup",
                },
                "awslogs-region": {
                  "Ref": "AWS::Region",
                },
                "awslogs-stream-prefix": "ecs",
              },
            },
            "Name": "lza-deployment-container",
          },
        ],
        "Cpu": "8192",
        "ExecutionRoleArn": {
          "Fn::GetAtt": [
            "EcsExecutionRole",
            "Arn",
          ],
        },
        "Family": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-lza-deployment-task",
            ],
          ],
        },
        "Memory": "32768",
        "NetworkMode": "awsvpc",
        "RequiresCompatibilities": [
          "EC2",
          "FARGATE",
        ],
        "TaskRoleArn": {
          "Fn::GetAtt": [
            "EcsTaskRole",
            "Arn",
          ],
        },
      },
      "Type": "AWS::ECS::TaskDefinition",
    },
    "Vpc": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "CidrBlock": {
          "Ref": "VpcCidr",
        },
        "EnableDnsHostnames": true,
        "EnableDnsSupport": true,
        "InstanceTenancy": "default",
      },
      "Type": "AWS::EC2::VPC",
    },
    "VpcFlowLog": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DeliverLogsPermissionArn": {
          "Fn::GetAtt": [
            "VpcFlowLogRole",
            "Arn",
          ],
        },
        "LogDestinationType": "cloud-watch-logs",
        "LogGroupName": {
          "Ref": "VpcFlowLogGroup",
        },
        "ResourceId": {
          "Ref": "Vpc",
        },
        "ResourceType": "VPC",
        "TrafficType": "ALL",
      },
      "Type": "AWS::EC2::FlowLog",
    },
    "VpcFlowLogGroup": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/aws/vpc/flowlogs/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
            ],
          ],
        },
        "RetentionInDays": 365,
      },
      "Type": "AWS::Logs::LogGroup",
    },
    "VpcFlowLogRole": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "vpc-flow-logs.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "logs:CreateLogStream",
                    "logs:PutLogEvents",
                    "logs:DescribeLogGroups",
                    "logs:DescribeLogStreams",
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::GetAtt": [
                      "VpcFlowLogGroup",
                      "Arn",
                    ],
                  },
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "CloudWatchLogPolicy",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "VpcGatewayAttachment": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "InternetGatewayId": {
          "Ref": "InternetGateway",
        },
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::VPCGatewayAttachment",
    },
  },
  "Rules": {
    "RequiredParametersForExistingRepo": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingConfigBucketKey",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "existingConfigBucketKey parameter must be provided when useExistingConfig is set to Yes",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingConfigBucketName",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "existingConfigBucketName parameter must be provided when useExistingRepository is set to Yes",
        },
      ],
      "RuleCondition": {
        "Fn::Equals": [
          "Yes",
          {
            "Ref": "UseExistingConfig",
          },
        ],
      },
    },
    "RequiredParametersForExistingVpc": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingVpcId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ExistingVpcId parameter must be provided when UseExistingVpc is set to Yes",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingSubnetId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ExistingSubnetId parameter must be provided when UseExistingVpc is set to Yes",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingSecurityGroupId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ExistingSecurityGroupId parameter must be provided when UseExistingVpc is set to Yes",
        },
      ],
      "RuleCondition": {
        "Fn::Equals": [
          "Yes",
          {
            "Ref": "UseExistingVpc",
          },
        ],
      },
    },
    "UniqueAccountEmails": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "ManagementAccountEmail",
                  },
                  {
                    "Ref": "LogArchiveAccountEmail",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "Management Account Email and Log Archive Account Email must be different",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "ManagementAccountEmail",
                  },
                  {
                    "Ref": "AuditAccountEmail",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "Management Account Email and Audit Account Email must be different",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "LogArchiveAccountEmail",
                  },
                  {
                    "Ref": "AuditAccountEmail",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "Log Archive Account Email and Audit Account Email must be different",
        },
      ],
    },
  },
}
`;

exports[`InstallerContainerStack > Construct(InstallerContainerStack): Deployment Mode Compatibility Snapshot Test 1`] = `
{
  "Conditions": {
    "CreateConfigCondition": {
      "Fn::Equals": [
        "No",
        {
          "Ref": "UseExistingConfig",
        },
      ],
    },
    "CreateVpcCondition": {
      "Fn::Equals": [
        "No",
        {
          "Ref": "UseExistingVpc",
        },
      ],
    },
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "Source Configuration",
          },
          "Parameters": [
            "EcrUri",
          ],
        },
        {
          "Label": {
            "default": "Mandatory Accounts Configuration",
          },
          "Parameters": [
            "ManagementAccountEmail",
            "LogArchiveAccountEmail",
            "AuditAccountEmail",
          ],
        },
        {
          "Label": {
            "default": "Environment Configuration",
          },
          "Parameters": [
            "ControlTowerEnabled",
            "AcceleratorPrefix",
            "PythonRuntimeVersion",
            "LogLevel",
          ],
        },
        {
          "Label": {
            "default": "Config Bucket Configuration",
          },
          "Parameters": [
            "UseExistingConfig",
            "ExistingConfigBucketName",
            "ExistingConfigBucketKey",
          ],
        },
        {
          "Label": {
            "default": "Network Configuration",
          },
          "Parameters": [
            "VpcCidr",
            "UseExistingVpc",
            "ExistingVpcId",
            "ExistingSubnetId",
            "ExistingSecurityGroupId",
          ],
        },
        {
          "Label": {
            "default": "Permission Boundary Configuration",
          },
          "Parameters": [
            "PermissionBoundaryPolicyName",
          ],
        },
        {
          "Label": {
            "default": "Target Environment Configuration",
          },
          "Parameters": [
            "AcceleratorQualifier",
            "ManagementAccountId",
            "ManagementAccountRoleName",
          ],
        },
      ],
      "ParameterLabels": {
        "AcceleratorPrefix": {
          "default": "Accelerator Resource name prefix",
        },
        "AcceleratorQualifier": {
          "default": "Accelerator Qualifier",
        },
        "AuditAccountEmail": {
          "default": "Audit Account Email",
        },
        "ControlTowerEnabled": {
          "default": "Control Tower Environment",
        },
        "EcrUri": {
          "default": "ECR URI",
        },
        "ExistingSecurityGroupId": {
          "default": "Existing Security Group ID",
        },
        "ExistingSubnetId": {
          "default": "Existing Subnet ID",
        },
        "ExistingVpcId": {
          "default": "Existing VPC ID",
        },
        "LogArchiveAccountEmail": {
          "default": "Log Archive Account Email",
        },
        "LogLevel": {
          "default": "Log Level",
        },
        "ManagementAccountEmail": {
          "default": "Management Account Email",
        },
        "ManagementAccountId": {
          "default": "Management Account ID",
        },
        "ManagementAccountRoleName": {
          "default": "Management Account Role Name",
        },
        "PermissionBoundaryPolicyName": {
          "default": "Permission Boundary Policy Name",
        },
        "PythonRuntimeVersion": {
          "default": "Python Runtime Version (for SSM aws:executeScript)",
        },
        "UseExistingVpc": {
          "default": "Use Existing VPC",
        },
        "VpcCidr": {
          "default": "VPC CIDR Block",
        },
      },
    },
  },
  "Outputs": {
    "DeploySolutionDocumentOutput": {
      "Description": "SSM Document name that will be used to trigger automation for LZA engine using container",
      "Value": {
        "Ref": "DeploySolutionDocument",
      },
    },
  },
  "Parameters": {
    "AcceleratorPrefix": {
      "AllowedPattern": "[A-Za-z0-9-]+",
      "Default": "AWSAccelerator",
      "Description": "The prefix value for accelerator deployed resources. Leave the default value if using solution defined resource name prefix, the solution will use AWSAccelerator as resource name prefix. Note: Updating this value after initial installation will cause stack failure. Non-default value can not start with keyword "aws" or "ssm". Trailing dash (-) in non-default value will be ignored.",
      "MaxLength": 15,
      "Type": "String",
    },
    "AcceleratorQualifier": {
      "AllowedPattern": "^[a-z]+[a-z0-9-]{1,61}[a-z0-9]+$",
      "ConstraintDescription": "Qualifier must include lowercase letters and numbers only and cannot be aws-accelerator",
      "Description": "Names the resources in the external deployment account. This must be unique for each LZA pipeline created in a single external deployment account, for example "env2" or "app1." Do not use "aws-accelerator" or a similar value that could be confused with the prefix."",
      "Type": "String",
    },
    "AuditAccountEmail": {
      "AllowedPattern": "[^\\s@]+@[^\\s@]+\\.[^\\s@]+",
      "ConstraintDescription": "Must be a valid email address matching "[^\\s@]+@[^\\s@]+\\.[^\\s@]+"",
      "Description": "The security audit account (also referred to as the audit account)",
      "Type": "String",
    },
    "ControlTowerEnabled": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "Yes",
      "Description": "Select yes if deploying to a Control Tower environment.  Select no if using just Organizations. If no, you must first set up mandatory accounts.",
      "Type": "String",
    },
    "EcrUri": {
      "Description": "The Amazon Elastic Container Registry (Amazon ECR) repository, where Landing Zone Accelerator on AWS code is present.",
      "Type": "String",
    },
    "ExistingConfigBucketKey": {
      "Default": "",
      "Description": "Specify the branch name of the existing LZA configuration bucket key to pull the accelerator configuration from.",
      "Type": "String",
    },
    "ExistingConfigBucketName": {
      "Default": "",
      "Description": "The name of an existing LZA configuration bucket hosting the accelerator configuration.",
      "Type": "String",
    },
    "ExistingSecurityGroupId": {
      "Default": "",
      "Description": "The ID of an existing security group (required when UseExistingVpc is Yes)",
      "Type": "String",
    },
    "ExistingSubnetId": {
      "Default": "",
      "Description": "The ID of an existing subnet (required when UseExistingVpc is Yes)",
      "Type": "String",
    },
    "ExistingVpcId": {
      "Default": "",
      "Description": "The ID of an existing VPC (required when UseExistingVpc is Yes)",
      "Type": "String",
    },
    "LogArchiveAccountEmail": {
      "AllowedPattern": "[^\\s@]+@[^\\s@]+\\.[^\\s@]+",
      "ConstraintDescription": "Must be a valid email address matching "[^\\s@]+@[^\\s@]+\\.[^\\s@]+"",
      "Description": "The log archive account email",
      "Type": "String",
    },
    "LogLevel": {
      "AllowedValues": [
        "error",
        "info",
        "debug",
      ],
      "Default": "error",
      "Description": "The log level for LZA engine. Controls the verbosity of logs generated during deployment.",
      "Type": "String",
    },
    "ManagementAccountEmail": {
      "AllowedPattern": "[^\\s@]+@[^\\s@]+\\.[^\\s@]+",
      "ConstraintDescription": "Must be a valid email address matching "[^\\s@]+@[^\\s@]+\\.[^\\s@]+"",
      "Description": "The management (primary) account email - NOTE: This must match the address of the management account email as listed in AWS Organizations > AWS accounts.",
      "Type": "String",
    },
    "ManagementAccountId": {
      "Description": "Target management account id",
      "Type": "String",
    },
    "ManagementAccountRoleName": {
      "Description": "Target management account role name",
      "Type": "String",
    },
    "PermissionBoundaryPolicyName": {
      "Description": "Permission boundary Policy Name which is valid only for management account",
      "Type": "String",
    },
    "PythonRuntimeVersion": {
      "Default": "python3.11",
      "Description": "The Python runtime version for SSM Document aws:executeScript actions. Must match SSM supported runtimes (e.g., python3.8, python3.9, python3.10, python3.11).",
      "Type": "String",
    },
    "UseExistingConfig": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Select Yes if deploying the solution with an existing configuration. Leave the default value if using the solution-deployed bucket. If the AcceleratorPrefix parameter is set to the default value, the solution will deploy a bucket named "aws-accelerator-config-$account-$region." Otherwise, the solution-deployed bucket will be named "AcceleratorPrefix-config-$account-$region." Note: Updating this value after initial installation may cause adverse affects.",
      "Type": "String",
    },
    "UseExistingVpc": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Select Yes to use an existing VPC. If Yes, provide existing subnet and security group IDs.",
      "Type": "String",
    },
    "VpcCidr": {
      "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$",
      "Default": "10.0.0.0/16",
      "Description": "The CIDR block for the VPC (used when UseExistingVpc is No)",
      "Type": "String",
    },
  },
  "Resources": {
    "AcceleratorManagementKmsArnParameter1E6975BF": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/",
              {
                "Ref": "AcceleratorQualifier",
              },
              "/installer/kms/key-arn",
            ],
          ],
        },
        "Type": "String",
        "Value": {
          "Fn::GetAtt": [
            "InstallerKey2A6A8C6D",
            "Arn",
          ],
        },
      },
      "Type": "AWS::SSM::Parameter",
    },
    "ConfigBucket": {
      "Condition": "CreateConfigCondition",
      "DeletionPolicy": "Retain",
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "KMSMasterKeyID": {
                  "Fn::GetAtt": [
                    "InstallerKey2A6A8C6D",
                    "Arn",
                  ],
                },
                "SSEAlgorithm": "aws:kms",
              },
            },
          ],
        },
        "BucketName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AcceleratorQualifier",
              },
              "-config-",
              {
                "Ref": "AWS::AccountId",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
            ],
          ],
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "AbortIncompleteMultipartUpload": {
                "DaysAfterInitiation": 1,
              },
              "ExpirationInDays": 1825,
              "ExpiredObjectDeleteMarker": false,
              "Id": {
                "Fn::Join": [
                  "",
                  [
                    "LifecycleRule",
                    {
                      "Ref": "AcceleratorQualifier",
                    },
                    "-config-",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    "-",
                    {
                      "Ref": "AWS::Region",
                    },
                  ],
                ],
              },
              "NoncurrentVersionExpiration": {
                "NoncurrentDays": 1825,
              },
              "NoncurrentVersionTransitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 366,
                },
              ],
              "Status": "Enabled",
              "Transitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 365,
                },
              ],
            },
          ],
        },
        "LoggingConfiguration": {
          "DestinationBucketName": {
            "Ref": "InstallerAccessLogsBucket647700E9",
          },
          "LogFilePrefix": {
            "Fn::Join": [
              "",
              [
                {
                  "Ref": "AcceleratorQualifier",
                },
                "-config-",
                {
                  "Ref": "AWS::AccountId",
                },
                "-",
                {
                  "Ref": "AWS::Region",
                },
                "/",
              ],
            ],
          },
        },
        "OwnershipControls": {
          "Rules": [
            {
              "ObjectOwnership": "BucketOwnerPreferred",
            },
          ],
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true,
        },
        "VersioningConfiguration": {
          "Status": "Enabled",
        },
      },
      "Type": "AWS::S3::Bucket",
      "UpdateReplacePolicy": "Retain",
    },
    "ConfigBucketPolicy": {
      "Condition": "CreateConfigCondition",
      "Properties": {
        "Bucket": {
          "Ref": "ConfigBucket",
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:*",
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false",
                },
              },
              "Effect": "Deny",
              "Principal": {
                "AWS": "*",
              },
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "ConfigBucket",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "ConfigBucket",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
              "Sid": "deny-insecure-connections",
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::S3::BucketPolicy",
    },
    "DeploySolutionDocument": {
      "Properties": {
        "Content": {
          "assumeRole": "{{AutomationAssumeRole}}",
          "description": "Automation document to deploy Landing Zone Accelerator on AWS (LZA) solution by running ECS Fargate tasks in a private subnet",
          "mainSteps": [
            {
              "action": "aws:executeScript",
              "description": "Starts a new ECS task and returns task details with CloudWatch log URL",
              "inputs": {
                "Handler": "handler",
                "InputPayload": {
                  "Cluster": "{{Cluster}}",
                  "LogGroupName": {
                    "Ref": "LogGroup",
                  },
                  "Region": {
                    "Ref": "AWS::Region",
                  },
                  "SecurityGroupId": "{{SecurityGroupId}}",
                  "SolutionId": "AwsSolution/SO0199/1.15.0",
                  "SubnetId": "{{SubnetId}}",
                  "TaskDefinition": "{{TaskDefinition}}",
                },
                "Runtime": "{{PythonRuntime}}",
                "Script": "REPLACED-JSON-PATH.json",
              },
              "name": "RunTask",
              "outputs": [
                {
                  "Name": "ClusterName",
                  "Selector": "$.Payload.ClusterName",
                  "Type": "String",
                },
                {
                  "Name": "TaskArn",
                  "Selector": "$.Payload.TaskArn",
                  "Type": "String",
                },
                {
                  "Name": "LogGroupName",
                  "Selector": "$.Payload.LogGroupName",
                  "Type": "String",
                },
                {
                  "Name": "LogStreamName",
                  "Selector": "$.Payload.LogStreamName",
                  "Type": "String",
                },
              ],
              "timeoutSeconds": 600,
            },
            {
              "action": "aws:waitForAwsResourceProperty",
              "description": "Wait for ECS task to complete",
              "inputs": {
                "Api": "DescribeTasks",
                "DesiredValues": [
                  "STOPPED",
                ],
                "PropertySelector": "$.tasks[0].lastStatus",
                "Service": "ecs",
                "cluster": "{{RunTask.ClusterName}}",
                "tasks": [
                  "{{RunTask.TaskArn}}",
                ],
              },
              "name": "WaitForTaskCompletion",
              "outputs": [
                {
                  "Name": "TaskStatus",
                  "Selector": "$.tasks[0].lastStatus",
                  "Type": "String",
                },
              ],
              "timeoutSeconds": 43200,
            },
            {
              "action": "aws:executeScript",
              "description": "Verifies the container exit code after task completion and fails the automation if exit code is non-zero",
              "inputs": {
                "Handler": "handler",
                "InputPayload": {
                  "ClusterName": "{{RunTask.ClusterName}}",
                  "LogGroupName": "{{RunTask.LogGroupName}}",
                  "LogStreamName": "{{RunTask.LogStreamName}}",
                  "Region": {
                    "Ref": "AWS::Region",
                  },
                  "SolutionId": "AwsSolution/SO0199/1.15.0",
                  "TaskArn": "{{RunTask.TaskArn}}",
                },
                "Runtime": "{{PythonRuntime}}",
                "Script": "import boto3
from botocore.config import Config

def handler(event, context):
    config = Config(user_agent_extra=event['SolutionId']) 
    client = boto3.client('ecs', region_name=event['Region'], config=config)
    
    response = client.describe_tasks(
        cluster=event['ClusterName'],
        tasks=[event['TaskArn']]
    )
    
    if not response['tasks']:
        raise Exception(f"Task not found: {event['TaskArn']}")
    
    task = response['tasks'][0]
    containers = task.get('containers', [])
    
    if not containers:
        raise Exception(f"No containers found in task: {event['TaskArn']}")
    
    # Extract exit code from tasks[0].containers[0].exitCode
    container = containers[0]
    exit_code = container.get('exitCode')  # Can be 0, 1, 137, etc. or None if killed
    
    # Extract task-level stop information
    stop_code = task.get('stopCode', 'Unknown')  # e.g., "EssentialContainerExited"
    stop_reason = task.get('stoppedReason', 'Unknown')  # e.g., "Essential container in task exited"
    task_status = task.get('lastStatus', 'Unknown')
    
    result = {
        'ExitCode': exit_code if exit_code is not None else -1,
        'StopCode': stop_code,
        'StopReason': stop_reason,
        'TaskStatus': task_status,
        'LogStreamName': event['LogStreamName'],
        'LogGroupName': event['LogGroupName']
    }
    
    # Fail if exit code is non-zero or None (container was killed)
    if exit_code is None or exit_code != 0:
        error_msg = (
            f"ECS task failed with exit code {exit_code}. "
            f"Stop code: {stop_code}. "
            f"Stop reason: {stop_reason}. "
            f"Check CloudWatch logs: {event['LogGroupName']}/{event['LogStreamName']}"
        )
        raise Exception(error_msg)
    
    return result",
              },
              "name": "CheckTaskExitCode",
              "outputs": [
                {
                  "Name": "ExitCode",
                  "Selector": "$.Payload.ExitCode",
                  "Type": "Integer",
                },
                {
                  "Name": "StopCode",
                  "Selector": "$.Payload.StopCode",
                  "Type": "String",
                },
                {
                  "Name": "StopReason",
                  "Selector": "$.Payload.StopReason",
                  "Type": "String",
                },
                {
                  "Name": "TaskStatus",
                  "Selector": "$.Payload.TaskStatus",
                  "Type": "String",
                },
              ],
              "timeoutSeconds": 600,
            },
          ],
          "outputs": [
            "RunTask.TaskArn",
            "RunTask.ClusterName",
            "RunTask.LogGroupName",
            "RunTask.LogStreamName",
            "WaitForTaskCompletion.TaskStatus",
            "CheckTaskExitCode.ExitCode",
            "CheckTaskExitCode.StopCode",
            "CheckTaskExitCode.StopReason",
          ],
          "parameters": {
            "AutomationAssumeRole": {
              "default": {
                "Fn::GetAtt": [
                  "SsmAutomationRole",
                  "Arn",
                ],
              },
              "description": "The ARN of the IAM role that allows Systems Manager Automation to perform actions",
              "type": "String",
            },
            "Cluster": {
              "default": {
                "Ref": "EcsCluster",
              },
              "description": "The short name or full ARN of the cluster to run your task on",
              "type": "String",
            },
            "PythonRuntime": {
              "default": {
                "Ref": "PythonRuntimeVersion",
              },
              "description": "The Python runtime version for aws:executeScript actions",
              "type": "String",
            },
            "SecurityGroupId": {
              "default": {
                "Fn::If": [
                  "CreateVpcCondition",
                  {
                    "Ref": "SecurityGroup",
                  },
                  {
                    "Ref": "ExistingSecurityGroupId",
                  },
                ],
              },
              "description": "The security group used by the ECS task",
              "type": "String",
            },
            "SubnetId": {
              "default": {
                "Fn::If": [
                  "CreateVpcCondition",
                  {
                    "Ref": "PrivateSubnet0",
                  },
                  {
                    "Ref": "ExistingSubnetId",
                  },
                ],
              },
              "description": "The subnet where the ECS task will be placed",
              "type": "String",
            },
            "TaskDefinition": {
              "default": {
                "Ref": "TaskDefinition",
              },
              "description": "The family and revision or full ARN of the task definition to run",
              "type": "String",
            },
          },
          "schemaVersion": "0.3",
        },
        "DocumentType": "Automation",
        "Name": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AcceleratorQualifier",
              },
              "-RunEngine",
            ],
          ],
        },
        "UpdateMethod": "NewVersion",
      },
      "Type": "AWS::SSM::Document",
    },
    "EcsCluster": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-ECS4",
              "reason": "The ECS Cluster has CloudWatch Container Insights are not present in all partitions.",
            },
            {
              "id": "AwsSolutions-ECS7",
              "reason": "The ECS task definition used has logging enabled to CloudWatch logs.",
            },
          ],
        },
      },
      "Properties": {
        "ClusterName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AcceleratorQualifier",
              },
              "-ecs-cluster",
            ],
          ],
        },
      },
      "Type": "AWS::ECS::Cluster",
    },
    "EcsExecutionRole": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "The ECS task needs admin access to orchestrate the engine.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/AdministratorAccess",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "EcsTaskRole": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "The ECS task needs admin access to orchestrate LZA deployment and manage AWS resources.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/AdministratorAccess",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "InstallerAccessLogsBucket647700E9": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-S1",
              "reason": "AccessLogsBucket has server access logs disabled till the task for access logging completed.",
            },
          ],
        },
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W35",
              "reason": "This is an access logging bucket.",
            },
          ],
        },
      },
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256",
              },
            },
          ],
        },
        "BucketName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AcceleratorQualifier",
              },
              "-s3-logs-",
              {
                "Ref": "AWS::AccountId",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
            ],
          ],
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "AbortIncompleteMultipartUpload": {
                "DaysAfterInitiation": 1,
              },
              "ExpirationInDays": 1825,
              "ExpiredObjectDeleteMarker": false,
              "Id": {
                "Fn::Join": [
                  "",
                  [
                    "LifecycleRule",
                    {
                      "Ref": "AcceleratorQualifier",
                    },
                    "-s3-logs-",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    "-",
                    {
                      "Ref": "AWS::Region",
                    },
                  ],
                ],
              },
              "NoncurrentVersionExpiration": {
                "NoncurrentDays": 1825,
              },
              "NoncurrentVersionTransitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 366,
                },
              ],
              "Status": "Enabled",
              "Transitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 365,
                },
              ],
            },
          ],
        },
        "OwnershipControls": {
          "Rules": [
            {
              "ObjectOwnership": "BucketOwnerPreferred",
            },
          ],
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true,
        },
        "VersioningConfiguration": {
          "Status": "Enabled",
        },
      },
      "Type": "AWS::S3::Bucket",
      "UpdateReplacePolicy": "Retain",
    },
    "InstallerAccessLogsBucketName4F700F48": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/",
              {
                "Ref": "AcceleratorQualifier",
              },
              "/installer-access-logs-bucket-name",
            ],
          ],
        },
        "Type": "String",
        "Value": {
          "Ref": "InstallerAccessLogsBucket647700E9",
        },
      },
      "Type": "AWS::SSM::Parameter",
    },
    "InstallerAccessLogsBucketPolicy20D4E285": {
      "Properties": {
        "Bucket": {
          "Ref": "InstallerAccessLogsBucket647700E9",
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:*",
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false",
                },
              },
              "Effect": "Deny",
              "Principal": {
                "AWS": "*",
              },
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "InstallerAccessLogsBucket647700E9",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "InstallerAccessLogsBucket647700E9",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
              "Sid": "deny-insecure-connections",
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::S3::BucketPolicy",
    },
    "InstallerKey2A6A8C6D": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "F76",
              "reason": "KMS key using * principal with added arn condition",
            },
          ],
        },
      },
      "Properties": {
        "Description": "KMS key for encrypting LZA installer S3 configuration bucket in the management account",
        "EnableKeyRotation": true,
        "KeyPolicy": {
          "Statement": [
            {
              "Action": "kms:*",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":iam::",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":root",
                    ],
                  ],
                },
              },
              "Resource": "*",
            },
            {
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ],
              "Condition": {
                "ArnLike": {
                  "aws:PrincipalARN": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":iam::",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":role/",
                        {
                          "Ref": "AcceleratorQualifier",
                        },
                        "-*",
                      ],
                    ],
                  },
                },
              },
              "Effect": "Allow",
              "Principal": {
                "AWS": "*",
              },
              "Resource": "*",
              "Sid": "Allow Accelerator Role to use the encryption key",
            },
            {
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": "sns.amazonaws.com",
              },
              "Resource": "*",
              "Sid": "Allow SNS service to use the encryption key",
            },
            {
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ],
              "Condition": {
                "ArnLike": {
                  "kms:EncryptionContext:aws:logs:arn": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":logs:",
                        {
                          "Ref": "AWS::Region",
                        },
                        ":",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":log-group:*",
                      ],
                    ],
                  },
                },
              },
              "Effect": "Allow",
              "Principal": {
                "Service": {
                  "Fn::Join": [
                    "",
                    [
                      "logs.",
                      {
                        "Ref": "AWS::Region",
                      },
                      ".amazonaws.com",
                    ],
                  ],
                },
              },
              "Resource": "*",
              "Sid": "Allow Cloudwatch Logs service to use the encryption key",
            },
          ],
        },
      },
      "Type": "AWS::KMS::Key",
      "UpdateReplacePolicy": "Retain",
    },
    "InstallerKeyAliasD5C174F0": {
      "Properties": {
        "AliasName": {
          "Fn::Join": [
            "",
            [
              "alias/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/",
              {
                "Ref": "AcceleratorQualifier",
              },
              "/installer/kms/key",
            ],
          ],
        },
        "TargetKeyId": {
          "Fn::GetAtt": [
            "InstallerKey2A6A8C6D",
            "Arn",
          ],
        },
      },
      "Type": "AWS::KMS::Alias",
    },
    "InternetGateway": {
      "Condition": "CreateVpcCondition",
      "Type": "AWS::EC2::InternetGateway",
    },
    "LogGroup": {
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/ecs/",
              {
                "Ref": "AcceleratorQualifier",
              },
              "-lza-deployment",
            ],
          ],
        },
        "RetentionInDays": 365,
      },
      "Type": "AWS::Logs::LogGroup",
    },
    "NatEip0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "Domain": "vpc",
      },
      "Type": "AWS::EC2::EIP",
    },
    "NatEip1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "Domain": "vpc",
      },
      "Type": "AWS::EC2::EIP",
    },
    "NatGateway0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "NatEip0",
            "AllocationId",
          ],
        },
        "SubnetId": {
          "Ref": "PublicSubnet0",
        },
      },
      "Type": "AWS::EC2::NatGateway",
    },
    "NatGateway1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "NatEip1",
            "AllocationId",
          ],
        },
        "SubnetId": {
          "Ref": "PublicSubnet1",
        },
      },
      "Type": "AWS::EC2::NatGateway",
    },
    "PrivateRoute0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "NatGateway0",
        },
        "RouteTableId": {
          "Ref": "PrivateRouteTable0",
        },
      },
      "Type": "AWS::EC2::Route",
    },
    "PrivateRoute1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "NatGateway1",
        },
        "RouteTableId": {
          "Ref": "PrivateRouteTable1",
        },
      },
      "Type": "AWS::EC2::Route",
    },
    "PrivateRouteTable0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::RouteTable",
    },
    "PrivateRouteTable1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::RouteTable",
    },
    "PrivateSubnet0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            0,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.10.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PrivateSubnet1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            1,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.11.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PrivateSubnetRouteTableAssociation0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PrivateRouteTable0",
        },
        "SubnetId": {
          "Ref": "PrivateSubnet0",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "PrivateSubnetRouteTableAssociation1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PrivateRouteTable1",
        },
        "SubnetId": {
          "Ref": "PrivateSubnet1",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "PublicRoute": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "InternetGateway",
        },
        "RouteTableId": {
          "Ref": "PublicRouteTable",
        },
      },
      "Type": "AWS::EC2::Route",
    },
    "PublicRouteTable": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::RouteTable",
    },
    "PublicSubnet0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            0,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.0.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PublicSubnet1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            1,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.1.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PublicSubnetRouteTableAssociation0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PublicRouteTable",
        },
        "SubnetId": {
          "Ref": "PublicSubnet0",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "PublicSubnetRouteTableAssociation1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PublicRouteTable",
        },
        "SubnetId": {
          "Ref": "PublicSubnet1",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "ResourceNamePrefixesGetPrefixResource96A10E6E": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "ResourceNamePrefixesResourceNamePrefixesFunction138C66F1",
            "Arn",
          ],
        },
        "pipelineStackVersionSsmParamName": {
          "Fn::Join": [
            "",
            [
              "/accelerator/",
              {
                "Ref": "AcceleratorQualifier",
              },
              "-pipeline-stack-",
              {
                "Ref": "AWS::AccountId",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
              "/version",
            ],
          ],
        },
        "prefix": {
          "Ref": "AcceleratorPrefix",
        },
        "prefixParameterName": {
          "Fn::Join": [
            "",
            [
              "/accelerator/",
              {
                "Ref": "AcceleratorQualifier",
              },
              "/lza-prefix",
            ],
          ],
        },
      },
      "Type": "Custom::GetPrefixes",
      "UpdateReplacePolicy": "Delete",
    },
    "ResourceNamePrefixesResourceNamePrefixesFunction138C66F1": {
      "DependsOn": [
        "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRoleDefaultPolicyDC1CC159",
        "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2",
      ],
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "Needed to write to CWL group",
            },
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Needed to create SSM parameter for prefix",
            },
          ],
        },
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W58",
              "reason": "CloudWatch Logs are enabled in AWSLambdaBasicExecutionRole",
            },
            {
              "id": "W89",
              "reason": "This function supports infrastructure deployment and is not deployed inside a VPC.",
            },
            {
              "id": "W92",
              "reason": "This function supports infrastructure deployment and does not require setting ReservedConcurrentExecutions.",
            },
          ],
        },
      },
      "Properties": {
        "Code": {
          "ZipFile": "
          const response = require('cfn-response'); 
          const { SSMClient, DeleteParameterCommand, GetParameterCommand, ParameterNotFound, PutParameterCommand } = require("@aws-sdk/client-ssm");
          const { ConfiguredRetryStrategy } = require("@aws-sdk/util-retry");
          exports.handler = async function (event, context) { 
          console.log(JSON.stringify(event, null, 4)); 
          const prefix=event.ResourceProperties.prefix;
          const pipelineStackVersionSsmParamName=event.ResourceProperties.pipelineStackVersionSsmParamName;
          const lowerCasePrefix=prefix.toLowerCase();
          
          const ssm = new SSMClient({retryStrategy: new ConfiguredRetryStrategy(10, (attempt) => 100 + attempt * 1000)});
          
          let data = {};
          
          let paramName = event.ResourceProperties.prefixParameterName;
          
          if (lowerCasePrefix === 'awsaccelerator') {
              data['acceleratorPrefix'] = 'AWSAccelerator';
              data['lowerCasePrefix'] = 'aws-accelerator'; 
              data['oneWordPrefix'] = 'accelerator';               
          } else {
              data['acceleratorPrefix'] = prefix;
              data['lowerCasePrefix'] = lowerCasePrefix; 
              data['oneWordPrefix'] = prefix; 
          }
                  

          if (event.RequestType === 'Update'){

              var params = {
                Name: paramName,
              };
              try {
                  const ssmResponse = await ssm.send(new GetParameterCommand(params));
                  // Fail stack if prefix was changed during update
                  if (ssmResponse.Parameter.Value !== prefix) {
                      await response.send(event, context, response.FAILED, {'FailureReason': 'LZA does not allow changing AcceleratorPrefix parameter value after initial deploy !!! Existing prefix: ' + event.OldResourceProperties.prefix + ' New prefix: ' + prefix + '.' }, event.PhysicalResourceId);
                      return;
                  }
                  await response.send(event, context, response.SUCCESS, data, event.PhysicalResourceId);
              } catch (error) {
                  console.log(error);
                  if (error instanceof ParameterNotFound){
                      await response.send(event, context, response.FAILED, {'FailureReason': 'LZA prefix ssm parameter ' + paramName + ' not found!!! Recreate the parameter with existing AcceleratorPrefix parameter value to fix the issue'}, event.PhysicalResourceId);
                      return;
                  }
                  else {
                      await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while accessing LZA prefix ssm parameter ' + paramName }, event.PhysicalResourceId);
                      return;
                  }
              }          
          } 
          
          if (event.RequestType === 'Create') {
          
              if (lowerCasePrefix !== 'awsaccelerator') {
                  // Fail stack if prefix starts with aws or ssm
                  if (lowerCasePrefix.startsWith('aws') || lowerCasePrefix.startsWith('ssm')) { 
                      await response.send(event, context, response.FAILED, {'FailureReason': 'Accelerator prefix ' + prefix + ' can not be started with aws or ssm !!!'}, event.PhysicalResourceId);
                      return;
                  }

                  // Check if this is an existing deployment and prefix changed with initial deployment of custom resource
                  var versionParams = {
                    Name: pipelineStackVersionSsmParamName,
                  };
                  try {
                    await ssm.send(new GetParameterCommand(versionParams));
                    await response.send(event, context, response.FAILED, {'FailureReason': 'Can not change AcceleratorPrefix parameter for existing deployment, existing prefix value is AWSAccelerator, keep AcceleratorPrefix parameter value to default value for successfully stack update !!!'}, event.PhysicalResourceId);
                    return;
                  }
                  catch (error) {
                    console.log(error);
                    if (!(error instanceof ParameterNotFound)){
                      await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while accessing LZA ssm parameter ' + pipelineStackVersionSsmParamName }, event.PhysicalResourceId);
                      return;
                    }
                  }
              }
          
              // Create /accelerator/lza-prefix SSM parameter to store prefix value to protect updating prefix
              try {
                  var newParams = {
                        Name: paramName,
                        Value: prefix,
                        Description: 'LZA created SSM parameter for Accelerator prefix value, DO NOT MODIFY/DELETE this parameter',
                        Type: 'String',
                      };
                  await ssm.send(new PutParameterCommand(newParams));
                  await response.send(event, context, response.SUCCESS, data, event.PhysicalResourceId);
              }
              catch (error) {
                  console.log(error);
                  await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while creating LZA prefix ssm parameter ' + paramName }, event.PhysicalResourceId);
                  return;
              }
          }
          if (event.RequestType === 'Delete') {

            var deleteParams = {
              Name: paramName,
            };
            try {
              await ssm.send(new DeleteParameterCommand(deleteParams));
            }
            catch (error) {
              console.log(error);
              if (!(error instanceof ParameterNotFound)){
                await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while deleting LZA ssm parameter ' + paramName }, event.PhysicalResourceId);
                return;
              }
            }
            await response.send(event, context, response.SUCCESS, {'Status': 'Custom resource deleted successfully' }, event.PhysicalResourceId);
          }
          
          return;
      }",
        },
        "Description": "This function converts accelerator prefix parameter to lower case to name s3 buckets in installer stack",
        "Handler": "index.handler",
        "Role": {
          "Fn::GetAtt": [
            "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2",
            "Arn",
          ],
        },
        "Runtime": "nodejs22.x",
      },
      "Type": "AWS::Lambda::Function",
    },
    "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "Needed to write to CWL group",
            },
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Needed to create SSM parameter for prefix",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRoleDefaultPolicyDC1CC159": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "Needed to write to CWL group",
            },
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Needed to create SSM parameter for prefix",
            },
          ],
        },
      },
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "ssm:GetParameters",
                "ssm:GetParameter",
                "ssm:PutParameter",
                "ssm:DeleteParameter",
              ],
              "Condition": {
                "StringEquals": {
                  "aws:PrincipalAccount": {
                    "Ref": "AWS::AccountId",
                  },
                },
              },
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":ssm:",
                      {
                        "Ref": "AWS::Region",
                      },
                      ":",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":parameter/accelerator/",
                      {
                        "Ref": "AcceleratorQualifier",
                      },
                      "/lza-prefix",
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":ssm:",
                      {
                        "Ref": "AWS::Region",
                      },
                      ":",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":parameter/accelerator/",
                      {
                        "Ref": "AcceleratorQualifier",
                      },
                      "-pipeline-stack-",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      "-",
                      {
                        "Ref": "AWS::Region",
                      },
                      "/version",
                    ],
                  ],
                },
              ],
              "Sid": "SsmReadParameterAccess",
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRoleDefaultPolicyDC1CC159",
        "Roles": [
          {
            "Ref": "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "SecurityGroup": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "GroupDescription": "Security group for VPC",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::SecurityGroup",
    },
    "SsmAutomationRole": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Wild card permissions are needed on describe and run task calls.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ssm.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "ecs:RunTask",
                    "ecs:DescribeTasks",
                  ],
                  "Effect": "Allow",
                  "Resource": "*",
                },
                {
                  "Action": [
                    "iam:PassRole",
                  ],
                  "Effect": "Allow",
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "EcsExecutionRole",
                        "Arn",
                      ],
                    },
                    {
                      "Fn::GetAtt": [
                        "EcsTaskRole",
                        "Arn",
                      ],
                    },
                  ],
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "EcsRunTaskPolicy",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "SsmParamAcceleratorVersionFF83282D": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/",
              {
                "Ref": "AcceleratorQualifier",
              },
              "/TestInstallerContainerStackCombined/version",
            ],
          ],
        },
        "Type": "String",
        "Value": "1.15.0",
      },
      "Type": "AWS::SSM::Parameter",
    },
    "SsmParamStackId521A78D3": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/",
              {
                "Ref": "AcceleratorQualifier",
              },
              "/TestInstallerContainerStackCombined/stack-id",
            ],
          ],
        },
        "Type": "String",
        "Value": {
          "Ref": "AWS::StackId",
        },
      },
      "Type": "AWS::SSM::Parameter",
    },
    "TaskDefinition": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-ECS2",
              "reason": "Environment variables are needed to turn off features made for services relying on CodePipeline and CodeBuild",
            },
          ],
        },
      },
      "Properties": {
        "ContainerDefinitions": [
          {
            "Command": [
              "/landing-zone-accelerator-on-aws/scripts/run-lza.sh deploy",
            ],
            "EntryPoint": [
              "sh",
              "-c",
            ],
            "Environment": [
              {
                "Name": "ENABLE_DIAGNOSTICS_PACK",
                "Value": "No",
              },
              {
                "Name": "SkipPipelinePrerequisites",
                "Value": "true",
              },
              {
                "Name": "SkipAcceleratorPrerequisites",
                "Value": "true",
              },
              {
                "Name": "AWS_REGION",
                "Value": {
                  "Ref": "AWS::Region",
                },
              },
              {
                "Name": "CONFIG_S3_PATH",
                "Value": {
                  "Fn::If": [
                    "CreateConfigCondition",
                    {
                      "Fn::Join": [
                        "",
                        [
                          "s3://",
                          {
                            "Ref": "AcceleratorQualifier",
                          },
                          "-config-",
                          {
                            "Ref": "AWS::AccountId",
                          },
                          "-",
                          {
                            "Ref": "AWS::Region",
                          },
                          "/lza/aws-accelerator-config.zip",
                        ],
                      ],
                    },
                    {
                      "Fn::Join": [
                        "",
                        [
                          "s3://",
                          {
                            "Ref": "ExistingConfigBucketName",
                          },
                          "/",
                          {
                            "Ref": "ExistingConfigBucketKey",
                          },
                        ],
                      ],
                    },
                  ],
                },
              },
              {
                "Name": "CONFIG_S3_BUCKET",
                "Value": {
                  "Fn::If": [
                    "CreateConfigCondition",
                    {
                      "Fn::Join": [
                        "",
                        [
                          {
                            "Ref": "AcceleratorQualifier",
                          },
                          "-config-",
                          {
                            "Ref": "AWS::AccountId",
                          },
                          "-",
                          {
                            "Ref": "AWS::Region",
                          },
                        ],
                      ],
                    },
                    {
                      "Ref": "ExistingConfigBucketName",
                    },
                  ],
                },
              },
              {
                "Name": "CONFIG_S3_KEY",
                "Value": {
                  "Fn::If": [
                    "CreateConfigCondition",
                    "lza/aws-accelerator-config.zip",
                    {
                      "Ref": "ExistingConfigBucketKey",
                    },
                  ],
                },
              },
              {
                "Name": "CONFIG_BUCKET_NAME",
                "Value": {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Ref": "AcceleratorQualifier",
                      },
                      "-config-",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      "-",
                      {
                        "Ref": "AWS::Region",
                      },
                    ],
                  ],
                },
              },
              {
                "Name": "MANAGEMENT_ACCOUNT_EMAIL",
                "Value": {
                  "Ref": "ManagementAccountEmail",
                },
              },
              {
                "Name": "LOG_ARCHIVE_ACCOUNT_EMAIL",
                "Value": {
                  "Ref": "LogArchiveAccountEmail",
                },
              },
              {
                "Name": "AUDIT_ACCOUNT_EMAIL",
                "Value": {
                  "Ref": "AuditAccountEmail",
                },
              },
              {
                "Name": "CONTROL_TOWER_ENABLED",
                "Value": {
                  "Ref": "ControlTowerEnabled",
                },
              },
              {
                "Name": "ACCELERATOR_PREFIX",
                "Value": {
                  "Fn::GetAtt": [
                    "ResourceNamePrefixesGetPrefixResource96A10E6E",
                    "acceleratorPrefix",
                  ],
                },
              },
              {
                "Name": "INSTALLER_STACK_NAME",
                "Value": {
                  "Fn::Sub": "\${AWS::StackName}",
                },
              },
              {
                "Name": "PARTITION",
                "Value": {
                  "Fn::Sub": "\${AWS::Partition}",
                },
              },
              {
                "Name": "PIPELINE_ACCOUNT_ID",
                "Value": {
                  "Ref": "AWS::AccountId",
                },
              },
              {
                "Name": "LOG_LEVEL",
                "Value": {
                  "Ref": "LogLevel",
                },
              },
              {
                "Name": "MANAGEMENT_ACCOUNT_ID",
                "Value": {
                  "Ref": "ManagementAccountId",
                },
              },
              {
                "Name": "MANAGEMENT_ACCOUNT_ROLE_NAME",
                "Value": {
                  "Ref": "ManagementAccountRoleName",
                },
              },
              {
                "Name": "ACCELERATOR_QUALIFIER",
                "Value": {
                  "Ref": "AcceleratorQualifier",
                },
              },
              {
                "Name": "ACCELERATOR_PERMISSION_BOUNDARY",
                "Value": {
                  "Ref": "PermissionBoundaryPolicyName",
                },
              },
            ],
            "Image": {
              "Ref": "EcrUri",
            },
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-group": {
                  "Ref": "LogGroup",
                },
                "awslogs-region": {
                  "Ref": "AWS::Region",
                },
                "awslogs-stream-prefix": "ecs",
              },
            },
            "Name": "lza-deployment-container",
          },
        ],
        "Cpu": "8192",
        "ExecutionRoleArn": {
          "Fn::GetAtt": [
            "EcsExecutionRole",
            "Arn",
          ],
        },
        "Family": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AcceleratorQualifier",
              },
              "-lza-deployment-task",
            ],
          ],
        },
        "Memory": "32768",
        "NetworkMode": "awsvpc",
        "RequiresCompatibilities": [
          "EC2",
          "FARGATE",
        ],
        "TaskRoleArn": {
          "Fn::GetAtt": [
            "EcsTaskRole",
            "Arn",
          ],
        },
      },
      "Type": "AWS::ECS::TaskDefinition",
    },
    "Vpc": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "CidrBlock": {
          "Ref": "VpcCidr",
        },
        "EnableDnsHostnames": true,
        "EnableDnsSupport": true,
        "InstanceTenancy": "default",
      },
      "Type": "AWS::EC2::VPC",
    },
    "VpcFlowLog": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DeliverLogsPermissionArn": {
          "Fn::GetAtt": [
            "VpcFlowLogRole",
            "Arn",
          ],
        },
        "LogDestinationType": "cloud-watch-logs",
        "LogGroupName": {
          "Ref": "VpcFlowLogGroup",
        },
        "ResourceId": {
          "Ref": "Vpc",
        },
        "ResourceType": "VPC",
        "TrafficType": "ALL",
      },
      "Type": "AWS::EC2::FlowLog",
    },
    "VpcFlowLogGroup": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/aws/vpc/flowlogs/",
              {
                "Ref": "AcceleratorQualifier",
              },
            ],
          ],
        },
        "RetentionInDays": 365,
      },
      "Type": "AWS::Logs::LogGroup",
    },
    "VpcFlowLogRole": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "vpc-flow-logs.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "logs:CreateLogStream",
                    "logs:PutLogEvents",
                    "logs:DescribeLogGroups",
                    "logs:DescribeLogStreams",
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::GetAtt": [
                      "VpcFlowLogGroup",
                      "Arn",
                    ],
                  },
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "CloudWatchLogPolicy",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "VpcGatewayAttachment": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "InternetGatewayId": {
          "Ref": "InternetGateway",
        },
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::VPCGatewayAttachment",
    },
  },
  "Rules": {
    "ExternalPipelineParameterValidation": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "AcceleratorQualifier",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "AcceleratorQualifier parameter must not be empty when using external pipeline account",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ManagementAccountId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ManagementAccountId parameter must not be empty when using external pipeline account",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ManagementAccountRoleName",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ManagementAccountRoleName parameter must not be empty when using external pipeline account",
        },
      ],
    },
    "RequiredParametersForExistingRepo": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingConfigBucketKey",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "existingConfigBucketKey parameter must be provided when useExistingConfig is set to Yes",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingConfigBucketName",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "existingConfigBucketName parameter must be provided when useExistingRepository is set to Yes",
        },
      ],
      "RuleCondition": {
        "Fn::Equals": [
          "Yes",
          {
            "Ref": "UseExistingConfig",
          },
        ],
      },
    },
    "RequiredParametersForExistingVpc": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingVpcId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ExistingVpcId parameter must be provided when UseExistingVpc is set to Yes",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingSubnetId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ExistingSubnetId parameter must be provided when UseExistingVpc is set to Yes",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingSecurityGroupId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ExistingSecurityGroupId parameter must be provided when UseExistingVpc is set to Yes",
        },
      ],
      "RuleCondition": {
        "Fn::Equals": [
          "Yes",
          {
            "Ref": "UseExistingVpc",
          },
        ],
      },
    },
    "UniqueAccountEmails": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "ManagementAccountEmail",
                  },
                  {
                    "Ref": "LogArchiveAccountEmail",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "Management Account Email and Log Archive Account Email must be different",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "ManagementAccountEmail",
                  },
                  {
                    "Ref": "AuditAccountEmail",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "Management Account Email and Audit Account Email must be different",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "LogArchiveAccountEmail",
                  },
                  {
                    "Ref": "AuditAccountEmail",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "Log Archive Account Email and Audit Account Email must be different",
        },
      ],
    },
  },
}
`;

exports[`InstallerContainerStack > Construct(InstallerContainerStack): Single Account Mode Snapshot Test 1`] = `
{
  "Conditions": {
    "CreateConfigCondition": {
      "Fn::Equals": [
        "No",
        {
          "Ref": "UseExistingConfig",
        },
      ],
    },
    "CreateVpcCondition": {
      "Fn::Equals": [
        "No",
        {
          "Ref": "UseExistingVpc",
        },
      ],
    },
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "Source Configuration",
          },
          "Parameters": [
            "EcrUri",
          ],
        },
        {
          "Label": {
            "default": "Mandatory Accounts Configuration",
          },
          "Parameters": [
            "ManagementAccountEmail",
            "LogArchiveAccountEmail",
            "AuditAccountEmail",
          ],
        },
        {
          "Label": {
            "default": "Environment Configuration",
          },
          "Parameters": [
            "ControlTowerEnabled",
            "AcceleratorPrefix",
            "PythonRuntimeVersion",
            "LogLevel",
          ],
        },
        {
          "Label": {
            "default": "Config Bucket Configuration",
          },
          "Parameters": [
            "UseExistingConfig",
            "ExistingConfigBucketName",
            "ExistingConfigBucketKey",
          ],
        },
        {
          "Label": {
            "default": "Network Configuration",
          },
          "Parameters": [
            "VpcCidr",
            "UseExistingVpc",
            "ExistingVpcId",
            "ExistingSubnetId",
            "ExistingSecurityGroupId",
          ],
        },
      ],
      "ParameterLabels": {
        "AcceleratorPrefix": {
          "default": "Accelerator Resource name prefix",
        },
        "AuditAccountEmail": {
          "default": "Audit Account Email",
        },
        "ControlTowerEnabled": {
          "default": "Control Tower Environment",
        },
        "EcrUri": {
          "default": "ECR URI",
        },
        "ExistingSecurityGroupId": {
          "default": "Existing Security Group ID",
        },
        "ExistingSubnetId": {
          "default": "Existing Subnet ID",
        },
        "ExistingVpcId": {
          "default": "Existing VPC ID",
        },
        "LogArchiveAccountEmail": {
          "default": "Log Archive Account Email",
        },
        "LogLevel": {
          "default": "Log Level",
        },
        "ManagementAccountEmail": {
          "default": "Management Account Email",
        },
        "PythonRuntimeVersion": {
          "default": "Python Runtime Version (for SSM aws:executeScript)",
        },
        "UseExistingVpc": {
          "default": "Use Existing VPC",
        },
        "VpcCidr": {
          "default": "VPC CIDR Block",
        },
      },
    },
  },
  "Outputs": {
    "DeploySolutionDocumentOutput": {
      "Description": "SSM Document name that will be used to trigger automation for LZA engine using container",
      "Value": {
        "Ref": "DeploySolutionDocument",
      },
    },
  },
  "Parameters": {
    "AcceleratorPrefix": {
      "AllowedPattern": "[A-Za-z0-9-]+",
      "Default": "AWSAccelerator",
      "Description": "The prefix value for accelerator deployed resources. Leave the default value if using solution defined resource name prefix, the solution will use AWSAccelerator as resource name prefix. Note: Updating this value after initial installation will cause stack failure. Non-default value can not start with keyword "aws" or "ssm". Trailing dash (-) in non-default value will be ignored.",
      "MaxLength": 15,
      "Type": "String",
    },
    "AuditAccountEmail": {
      "AllowedPattern": "[^\\s@]+@[^\\s@]+\\.[^\\s@]+",
      "ConstraintDescription": "Must be a valid email address matching "[^\\s@]+@[^\\s@]+\\.[^\\s@]+"",
      "Description": "The security audit account (also referred to as the audit account)",
      "Type": "String",
    },
    "ControlTowerEnabled": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "Yes",
      "Description": "Select yes if deploying to a Control Tower environment.  Select no if using just Organizations. If no, you must first set up mandatory accounts.",
      "Type": "String",
    },
    "EcrUri": {
      "Description": "The Amazon Elastic Container Registry (Amazon ECR) repository, where Landing Zone Accelerator on AWS code is present.",
      "Type": "String",
    },
    "ExistingConfigBucketKey": {
      "Default": "",
      "Description": "Specify the branch name of the existing LZA configuration bucket key to pull the accelerator configuration from.",
      "Type": "String",
    },
    "ExistingConfigBucketName": {
      "Default": "",
      "Description": "The name of an existing LZA configuration bucket hosting the accelerator configuration.",
      "Type": "String",
    },
    "ExistingSecurityGroupId": {
      "Default": "",
      "Description": "The ID of an existing security group (required when UseExistingVpc is Yes)",
      "Type": "String",
    },
    "ExistingSubnetId": {
      "Default": "",
      "Description": "The ID of an existing subnet (required when UseExistingVpc is Yes)",
      "Type": "String",
    },
    "ExistingVpcId": {
      "Default": "",
      "Description": "The ID of an existing VPC (required when UseExistingVpc is Yes)",
      "Type": "String",
    },
    "LogArchiveAccountEmail": {
      "AllowedPattern": "[^\\s@]+@[^\\s@]+\\.[^\\s@]+",
      "ConstraintDescription": "Must be a valid email address matching "[^\\s@]+@[^\\s@]+\\.[^\\s@]+"",
      "Description": "The log archive account email",
      "Type": "String",
    },
    "LogLevel": {
      "AllowedValues": [
        "error",
        "info",
        "debug",
      ],
      "Default": "error",
      "Description": "The log level for LZA engine. Controls the verbosity of logs generated during deployment.",
      "Type": "String",
    },
    "ManagementAccountEmail": {
      "AllowedPattern": "[^\\s@]+@[^\\s@]+\\.[^\\s@]+",
      "ConstraintDescription": "Must be a valid email address matching "[^\\s@]+@[^\\s@]+\\.[^\\s@]+"",
      "Description": "The management (primary) account email - NOTE: This must match the address of the management account email as listed in AWS Organizations > AWS accounts.",
      "Type": "String",
    },
    "PythonRuntimeVersion": {
      "Default": "python3.11",
      "Description": "The Python runtime version for SSM Document aws:executeScript actions. Must match SSM supported runtimes (e.g., python3.8, python3.9, python3.10, python3.11).",
      "Type": "String",
    },
    "UseExistingConfig": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Select Yes if deploying the solution with an existing configuration. Leave the default value if using the solution-deployed bucket. If the AcceleratorPrefix parameter is set to the default value, the solution will deploy a bucket named "aws-accelerator-config-$account-$region." Otherwise, the solution-deployed bucket will be named "AcceleratorPrefix-config-$account-$region." Note: Updating this value after initial installation may cause adverse affects.",
      "Type": "String",
    },
    "UseExistingVpc": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Select Yes to use an existing VPC. If Yes, provide existing subnet and security group IDs.",
      "Type": "String",
    },
    "VpcCidr": {
      "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$",
      "Default": "10.0.0.0/16",
      "Description": "The CIDR block for the VPC (used when UseExistingVpc is No)",
      "Type": "String",
    },
  },
  "Resources": {
    "AcceleratorManagementKmsArnParameter1E6975BF": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/installer/kms/key-arn",
            ],
          ],
        },
        "Type": "String",
        "Value": {
          "Fn::GetAtt": [
            "InstallerKey2A6A8C6D",
            "Arn",
          ],
        },
      },
      "Type": "AWS::SSM::Parameter",
    },
    "ConfigBucket": {
      "Condition": "CreateConfigCondition",
      "DeletionPolicy": "Retain",
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "KMSMasterKeyID": {
                  "Fn::GetAtt": [
                    "InstallerKey2A6A8C6D",
                    "Arn",
                  ],
                },
                "SSEAlgorithm": "aws:kms",
              },
            },
          ],
        },
        "BucketName": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-config-",
              {
                "Ref": "AWS::AccountId",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
            ],
          ],
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "AbortIncompleteMultipartUpload": {
                "DaysAfterInitiation": 1,
              },
              "ExpirationInDays": 1825,
              "ExpiredObjectDeleteMarker": false,
              "Id": {
                "Fn::Join": [
                  "",
                  [
                    "LifecycleRule",
                    {
                      "Fn::GetAtt": [
                        "ResourceNamePrefixesGetPrefixResource96A10E6E",
                        "lowerCasePrefix",
                      ],
                    },
                    "-config-",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    "-",
                    {
                      "Ref": "AWS::Region",
                    },
                  ],
                ],
              },
              "NoncurrentVersionExpiration": {
                "NoncurrentDays": 1825,
              },
              "NoncurrentVersionTransitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 366,
                },
              ],
              "Status": "Enabled",
              "Transitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 365,
                },
              ],
            },
          ],
        },
        "LoggingConfiguration": {
          "DestinationBucketName": {
            "Ref": "InstallerAccessLogsBucket647700E9",
          },
          "LogFilePrefix": {
            "Fn::Join": [
              "",
              [
                {
                  "Fn::GetAtt": [
                    "ResourceNamePrefixesGetPrefixResource96A10E6E",
                    "lowerCasePrefix",
                  ],
                },
                "-config-",
                {
                  "Ref": "AWS::AccountId",
                },
                "-",
                {
                  "Ref": "AWS::Region",
                },
                "/",
              ],
            ],
          },
        },
        "OwnershipControls": {
          "Rules": [
            {
              "ObjectOwnership": "BucketOwnerPreferred",
            },
          ],
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true,
        },
        "VersioningConfiguration": {
          "Status": "Enabled",
        },
      },
      "Type": "AWS::S3::Bucket",
      "UpdateReplacePolicy": "Retain",
    },
    "ConfigBucketPolicy": {
      "Condition": "CreateConfigCondition",
      "Properties": {
        "Bucket": {
          "Ref": "ConfigBucket",
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:*",
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false",
                },
              },
              "Effect": "Deny",
              "Principal": {
                "AWS": "*",
              },
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "ConfigBucket",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "ConfigBucket",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
              "Sid": "deny-insecure-connections",
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::S3::BucketPolicy",
    },
    "DeploySolutionDocument": {
      "Properties": {
        "Content": {
          "assumeRole": "{{AutomationAssumeRole}}",
          "description": "Automation document to deploy Landing Zone Accelerator on AWS (LZA) solution by running ECS Fargate tasks in a private subnet",
          "mainSteps": [
            {
              "action": "aws:executeScript",
              "description": "Starts a new ECS task and returns task details with CloudWatch log URL",
              "inputs": {
                "Handler": "handler",
                "InputPayload": {
                  "Cluster": "{{Cluster}}",
                  "LogGroupName": {
                    "Ref": "LogGroup",
                  },
                  "Region": {
                    "Ref": "AWS::Region",
                  },
                  "SecurityGroupId": "{{SecurityGroupId}}",
                  "SolutionId": "AwsSolution/SO0199/1.15.0",
                  "SubnetId": "{{SubnetId}}",
                  "TaskDefinition": "{{TaskDefinition}}",
                },
                "Runtime": "{{PythonRuntime}}",
                "Script": "REPLACED-JSON-PATH.json",
              },
              "name": "RunTask",
              "outputs": [
                {
                  "Name": "ClusterName",
                  "Selector": "$.Payload.ClusterName",
                  "Type": "String",
                },
                {
                  "Name": "TaskArn",
                  "Selector": "$.Payload.TaskArn",
                  "Type": "String",
                },
                {
                  "Name": "LogGroupName",
                  "Selector": "$.Payload.LogGroupName",
                  "Type": "String",
                },
                {
                  "Name": "LogStreamName",
                  "Selector": "$.Payload.LogStreamName",
                  "Type": "String",
                },
              ],
              "timeoutSeconds": 600,
            },
            {
              "action": "aws:waitForAwsResourceProperty",
              "description": "Wait for ECS task to complete",
              "inputs": {
                "Api": "DescribeTasks",
                "DesiredValues": [
                  "STOPPED",
                ],
                "PropertySelector": "$.tasks[0].lastStatus",
                "Service": "ecs",
                "cluster": "{{RunTask.ClusterName}}",
                "tasks": [
                  "{{RunTask.TaskArn}}",
                ],
              },
              "name": "WaitForTaskCompletion",
              "outputs": [
                {
                  "Name": "TaskStatus",
                  "Selector": "$.tasks[0].lastStatus",
                  "Type": "String",
                },
              ],
              "timeoutSeconds": 43200,
            },
            {
              "action": "aws:executeScript",
              "description": "Verifies the container exit code after task completion and fails the automation if exit code is non-zero",
              "inputs": {
                "Handler": "handler",
                "InputPayload": {
                  "ClusterName": "{{RunTask.ClusterName}}",
                  "LogGroupName": "{{RunTask.LogGroupName}}",
                  "LogStreamName": "{{RunTask.LogStreamName}}",
                  "Region": {
                    "Ref": "AWS::Region",
                  },
                  "SolutionId": "AwsSolution/SO0199/1.15.0",
                  "TaskArn": "{{RunTask.TaskArn}}",
                },
                "Runtime": "{{PythonRuntime}}",
                "Script": "import boto3
from botocore.config import Config

def handler(event, context):
    config = Config(user_agent_extra=event['SolutionId']) 
    client = boto3.client('ecs', region_name=event['Region'], config=config)
    
    response = client.describe_tasks(
        cluster=event['ClusterName'],
        tasks=[event['TaskArn']]
    )
    
    if not response['tasks']:
        raise Exception(f"Task not found: {event['TaskArn']}")
    
    task = response['tasks'][0]
    containers = task.get('containers', [])
    
    if not containers:
        raise Exception(f"No containers found in task: {event['TaskArn']}")
    
    # Extract exit code from tasks[0].containers[0].exitCode
    container = containers[0]
    exit_code = container.get('exitCode')  # Can be 0, 1, 137, etc. or None if killed
    
    # Extract task-level stop information
    stop_code = task.get('stopCode', 'Unknown')  # e.g., "EssentialContainerExited"
    stop_reason = task.get('stoppedReason', 'Unknown')  # e.g., "Essential container in task exited"
    task_status = task.get('lastStatus', 'Unknown')
    
    result = {
        'ExitCode': exit_code if exit_code is not None else -1,
        'StopCode': stop_code,
        'StopReason': stop_reason,
        'TaskStatus': task_status,
        'LogStreamName': event['LogStreamName'],
        'LogGroupName': event['LogGroupName']
    }
    
    # Fail if exit code is non-zero or None (container was killed)
    if exit_code is None or exit_code != 0:
        error_msg = (
            f"ECS task failed with exit code {exit_code}. "
            f"Stop code: {stop_code}. "
            f"Stop reason: {stop_reason}. "
            f"Check CloudWatch logs: {event['LogGroupName']}/{event['LogStreamName']}"
        )
        raise Exception(error_msg)
    
    return result",
              },
              "name": "CheckTaskExitCode",
              "outputs": [
                {
                  "Name": "ExitCode",
                  "Selector": "$.Payload.ExitCode",
                  "Type": "Integer",
                },
                {
                  "Name": "StopCode",
                  "Selector": "$.Payload.StopCode",
                  "Type": "String",
                },
                {
                  "Name": "StopReason",
                  "Selector": "$.Payload.StopReason",
                  "Type": "String",
                },
                {
                  "Name": "TaskStatus",
                  "Selector": "$.Payload.TaskStatus",
                  "Type": "String",
                },
              ],
              "timeoutSeconds": 600,
            },
          ],
          "outputs": [
            "RunTask.TaskArn",
            "RunTask.ClusterName",
            "RunTask.LogGroupName",
            "RunTask.LogStreamName",
            "WaitForTaskCompletion.TaskStatus",
            "CheckTaskExitCode.ExitCode",
            "CheckTaskExitCode.StopCode",
            "CheckTaskExitCode.StopReason",
          ],
          "parameters": {
            "AutomationAssumeRole": {
              "default": {
                "Fn::GetAtt": [
                  "SsmAutomationRole",
                  "Arn",
                ],
              },
              "description": "The ARN of the IAM role that allows Systems Manager Automation to perform actions",
              "type": "String",
            },
            "Cluster": {
              "default": {
                "Ref": "EcsCluster",
              },
              "description": "The short name or full ARN of the cluster to run your task on",
              "type": "String",
            },
            "PythonRuntime": {
              "default": {
                "Ref": "PythonRuntimeVersion",
              },
              "description": "The Python runtime version for aws:executeScript actions",
              "type": "String",
            },
            "SecurityGroupId": {
              "default": {
                "Fn::If": [
                  "CreateVpcCondition",
                  {
                    "Ref": "SecurityGroup",
                  },
                  {
                    "Ref": "ExistingSecurityGroupId",
                  },
                ],
              },
              "description": "The security group used by the ECS task",
              "type": "String",
            },
            "SubnetId": {
              "default": {
                "Fn::If": [
                  "CreateVpcCondition",
                  {
                    "Ref": "PrivateSubnet0",
                  },
                  {
                    "Ref": "ExistingSubnetId",
                  },
                ],
              },
              "description": "The subnet where the ECS task will be placed",
              "type": "String",
            },
            "TaskDefinition": {
              "default": {
                "Ref": "TaskDefinition",
              },
              "description": "The family and revision or full ARN of the task definition to run",
              "type": "String",
            },
          },
          "schemaVersion": "0.3",
        },
        "DocumentType": "Automation",
        "Name": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "acceleratorPrefix",
                ],
              },
              "-RunEngine",
            ],
          ],
        },
        "UpdateMethod": "NewVersion",
      },
      "Type": "AWS::SSM::Document",
    },
    "EcsCluster": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-ECS4",
              "reason": "The ECS Cluster has CloudWatch Container Insights are not present in all partitions.",
            },
            {
              "id": "AwsSolutions-ECS7",
              "reason": "The ECS task definition used has logging enabled to CloudWatch logs.",
            },
          ],
        },
      },
      "Properties": {
        "ClusterName": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-ecs-cluster",
            ],
          ],
        },
      },
      "Type": "AWS::ECS::Cluster",
    },
    "EcsExecutionRole": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "The ECS task needs admin access to orchestrate the engine.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/AdministratorAccess",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "EcsTaskRole": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "The ECS task needs admin access to orchestrate LZA deployment and manage AWS resources.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/AdministratorAccess",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "InstallerAccessLogsBucket647700E9": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-S1",
              "reason": "AccessLogsBucket has server access logs disabled till the task for access logging completed.",
            },
          ],
        },
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W35",
              "reason": "This is an access logging bucket.",
            },
          ],
        },
      },
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256",
              },
            },
          ],
        },
        "BucketName": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-s3-logs-",
              {
                "Ref": "AWS::AccountId",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
            ],
          ],
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "AbortIncompleteMultipartUpload": {
                "DaysAfterInitiation": 1,
              },
              "ExpirationInDays": 1825,
              "ExpiredObjectDeleteMarker": false,
              "Id": {
                "Fn::Join": [
                  "",
                  [
                    "LifecycleRule",
                    {
                      "Fn::GetAtt": [
                        "ResourceNamePrefixesGetPrefixResource96A10E6E",
                        "lowerCasePrefix",
                      ],
                    },
                    "-s3-logs-",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    "-",
                    {
                      "Ref": "AWS::Region",
                    },
                  ],
                ],
              },
              "NoncurrentVersionExpiration": {
                "NoncurrentDays": 1825,
              },
              "NoncurrentVersionTransitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 366,
                },
              ],
              "Status": "Enabled",
              "Transitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 365,
                },
              ],
            },
          ],
        },
        "OwnershipControls": {
          "Rules": [
            {
              "ObjectOwnership": "BucketOwnerPreferred",
            },
          ],
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true,
        },
        "VersioningConfiguration": {
          "Status": "Enabled",
        },
      },
      "Type": "AWS::S3::Bucket",
      "UpdateReplacePolicy": "Retain",
    },
    "InstallerAccessLogsBucketName4F700F48": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/installer-access-logs-bucket-name",
            ],
          ],
        },
        "Type": "String",
        "Value": {
          "Ref": "InstallerAccessLogsBucket647700E9",
        },
      },
      "Type": "AWS::SSM::Parameter",
    },
    "InstallerAccessLogsBucketPolicy20D4E285": {
      "Properties": {
        "Bucket": {
          "Ref": "InstallerAccessLogsBucket647700E9",
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:*",
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false",
                },
              },
              "Effect": "Deny",
              "Principal": {
                "AWS": "*",
              },
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "InstallerAccessLogsBucket647700E9",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "InstallerAccessLogsBucket647700E9",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
              "Sid": "deny-insecure-connections",
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::S3::BucketPolicy",
    },
    "InstallerKey2A6A8C6D": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "F76",
              "reason": "KMS key using * principal with added arn condition",
            },
          ],
        },
      },
      "Properties": {
        "Description": "KMS key for encrypting LZA installer S3 configuration bucket in the management account",
        "EnableKeyRotation": true,
        "KeyPolicy": {
          "Statement": [
            {
              "Action": "kms:*",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":iam::",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":root",
                    ],
                  ],
                },
              },
              "Resource": "*",
            },
            {
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ],
              "Condition": {
                "ArnLike": {
                  "aws:PrincipalARN": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":iam::",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":role/",
                        {
                          "Fn::GetAtt": [
                            "ResourceNamePrefixesGetPrefixResource96A10E6E",
                            "acceleratorPrefix",
                          ],
                        },
                        "-*",
                      ],
                    ],
                  },
                },
              },
              "Effect": "Allow",
              "Principal": {
                "AWS": "*",
              },
              "Resource": "*",
              "Sid": "Allow Accelerator Role to use the encryption key",
            },
            {
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": "sns.amazonaws.com",
              },
              "Resource": "*",
              "Sid": "Allow SNS service to use the encryption key",
            },
            {
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ],
              "Condition": {
                "ArnLike": {
                  "kms:EncryptionContext:aws:logs:arn": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":logs:",
                        {
                          "Ref": "AWS::Region",
                        },
                        ":",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":log-group:*",
                      ],
                    ],
                  },
                },
              },
              "Effect": "Allow",
              "Principal": {
                "Service": {
                  "Fn::Join": [
                    "",
                    [
                      "logs.",
                      {
                        "Ref": "AWS::Region",
                      },
                      ".amazonaws.com",
                    ],
                  ],
                },
              },
              "Resource": "*",
              "Sid": "Allow Cloudwatch Logs service to use the encryption key",
            },
          ],
        },
      },
      "Type": "AWS::KMS::Key",
      "UpdateReplacePolicy": "Retain",
    },
    "InstallerKeyAliasD5C174F0": {
      "Properties": {
        "AliasName": {
          "Fn::Join": [
            "",
            [
              "alias/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/installer/kms/key",
            ],
          ],
        },
        "TargetKeyId": {
          "Fn::GetAtt": [
            "InstallerKey2A6A8C6D",
            "Arn",
          ],
        },
      },
      "Type": "AWS::KMS::Alias",
    },
    "InternetGateway": {
      "Condition": "CreateVpcCondition",
      "Type": "AWS::EC2::InternetGateway",
    },
    "LogGroup": {
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/ecs/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-lza-deployment",
            ],
          ],
        },
        "RetentionInDays": 365,
      },
      "Type": "AWS::Logs::LogGroup",
    },
    "NatEip0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "Domain": "vpc",
      },
      "Type": "AWS::EC2::EIP",
    },
    "NatEip1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "Domain": "vpc",
      },
      "Type": "AWS::EC2::EIP",
    },
    "NatGateway0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "NatEip0",
            "AllocationId",
          ],
        },
        "SubnetId": {
          "Ref": "PublicSubnet0",
        },
      },
      "Type": "AWS::EC2::NatGateway",
    },
    "NatGateway1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "NatEip1",
            "AllocationId",
          ],
        },
        "SubnetId": {
          "Ref": "PublicSubnet1",
        },
      },
      "Type": "AWS::EC2::NatGateway",
    },
    "PrivateRoute0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "NatGateway0",
        },
        "RouteTableId": {
          "Ref": "PrivateRouteTable0",
        },
      },
      "Type": "AWS::EC2::Route",
    },
    "PrivateRoute1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "NatGateway1",
        },
        "RouteTableId": {
          "Ref": "PrivateRouteTable1",
        },
      },
      "Type": "AWS::EC2::Route",
    },
    "PrivateRouteTable0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::RouteTable",
    },
    "PrivateRouteTable1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::RouteTable",
    },
    "PrivateSubnet0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            0,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.10.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PrivateSubnet1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            1,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.11.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PrivateSubnetRouteTableAssociation0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PrivateRouteTable0",
        },
        "SubnetId": {
          "Ref": "PrivateSubnet0",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "PrivateSubnetRouteTableAssociation1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PrivateRouteTable1",
        },
        "SubnetId": {
          "Ref": "PrivateSubnet1",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "PublicRoute": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "InternetGateway",
        },
        "RouteTableId": {
          "Ref": "PublicRouteTable",
        },
      },
      "Type": "AWS::EC2::Route",
    },
    "PublicRouteTable": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::RouteTable",
    },
    "PublicSubnet0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            0,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.0.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PublicSubnet1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            1,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.1.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PublicSubnetRouteTableAssociation0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PublicRouteTable",
        },
        "SubnetId": {
          "Ref": "PublicSubnet0",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "PublicSubnetRouteTableAssociation1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PublicRouteTable",
        },
        "SubnetId": {
          "Ref": "PublicSubnet1",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "ResourceNamePrefixesGetPrefixResource96A10E6E": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "ResourceNamePrefixesResourceNamePrefixesFunction138C66F1",
            "Arn",
          ],
        },
        "pipelineStackVersionSsmParamName": {
          "Fn::Join": [
            "",
            [
              "/accelerator/AWSAccelerator-PipelineStack-",
              {
                "Ref": "AWS::AccountId",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
              "/version",
            ],
          ],
        },
        "prefix": {
          "Ref": "AcceleratorPrefix",
        },
        "prefixParameterName": "/accelerator/lza-prefix",
      },
      "Type": "Custom::GetPrefixes",
      "UpdateReplacePolicy": "Delete",
    },
    "ResourceNamePrefixesResourceNamePrefixesFunction138C66F1": {
      "DependsOn": [
        "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRoleDefaultPolicyDC1CC159",
        "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2",
      ],
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "Needed to write to CWL group",
            },
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Needed to create SSM parameter for prefix",
            },
          ],
        },
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W58",
              "reason": "CloudWatch Logs are enabled in AWSLambdaBasicExecutionRole",
            },
            {
              "id": "W89",
              "reason": "This function supports infrastructure deployment and is not deployed inside a VPC.",
            },
            {
              "id": "W92",
              "reason": "This function supports infrastructure deployment and does not require setting ReservedConcurrentExecutions.",
            },
          ],
        },
      },
      "Properties": {
        "Code": {
          "ZipFile": "
          const response = require('cfn-response'); 
          const { SSMClient, DeleteParameterCommand, GetParameterCommand, ParameterNotFound, PutParameterCommand } = require("@aws-sdk/client-ssm");
          const { ConfiguredRetryStrategy } = require("@aws-sdk/util-retry");
          exports.handler = async function (event, context) { 
          console.log(JSON.stringify(event, null, 4)); 
          const prefix=event.ResourceProperties.prefix;
          const pipelineStackVersionSsmParamName=event.ResourceProperties.pipelineStackVersionSsmParamName;
          const lowerCasePrefix=prefix.toLowerCase();
          
          const ssm = new SSMClient({retryStrategy: new ConfiguredRetryStrategy(10, (attempt) => 100 + attempt * 1000)});
          
          let data = {};
          
          let paramName = event.ResourceProperties.prefixParameterName;
          
          if (lowerCasePrefix === 'awsaccelerator') {
              data['acceleratorPrefix'] = 'AWSAccelerator';
              data['lowerCasePrefix'] = 'aws-accelerator'; 
              data['oneWordPrefix'] = 'accelerator';               
          } else {
              data['acceleratorPrefix'] = prefix;
              data['lowerCasePrefix'] = lowerCasePrefix; 
              data['oneWordPrefix'] = prefix; 
          }
                  

          if (event.RequestType === 'Update'){

              var params = {
                Name: paramName,
              };
              try {
                  const ssmResponse = await ssm.send(new GetParameterCommand(params));
                  // Fail stack if prefix was changed during update
                  if (ssmResponse.Parameter.Value !== prefix) {
                      await response.send(event, context, response.FAILED, {'FailureReason': 'LZA does not allow changing AcceleratorPrefix parameter value after initial deploy !!! Existing prefix: ' + event.OldResourceProperties.prefix + ' New prefix: ' + prefix + '.' }, event.PhysicalResourceId);
                      return;
                  }
                  await response.send(event, context, response.SUCCESS, data, event.PhysicalResourceId);
              } catch (error) {
                  console.log(error);
                  if (error instanceof ParameterNotFound){
                      await response.send(event, context, response.FAILED, {'FailureReason': 'LZA prefix ssm parameter ' + paramName + ' not found!!! Recreate the parameter with existing AcceleratorPrefix parameter value to fix the issue'}, event.PhysicalResourceId);
                      return;
                  }
                  else {
                      await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while accessing LZA prefix ssm parameter ' + paramName }, event.PhysicalResourceId);
                      return;
                  }
              }          
          } 
          
          if (event.RequestType === 'Create') {
          
              if (lowerCasePrefix !== 'awsaccelerator') {
                  // Fail stack if prefix starts with aws or ssm
                  if (lowerCasePrefix.startsWith('aws') || lowerCasePrefix.startsWith('ssm')) { 
                      await response.send(event, context, response.FAILED, {'FailureReason': 'Accelerator prefix ' + prefix + ' can not be started with aws or ssm !!!'}, event.PhysicalResourceId);
                      return;
                  }

                  // Check if this is an existing deployment and prefix changed with initial deployment of custom resource
                  var versionParams = {
                    Name: pipelineStackVersionSsmParamName,
                  };
                  try {
                    await ssm.send(new GetParameterCommand(versionParams));
                    await response.send(event, context, response.FAILED, {'FailureReason': 'Can not change AcceleratorPrefix parameter for existing deployment, existing prefix value is AWSAccelerator, keep AcceleratorPrefix parameter value to default value for successfully stack update !!!'}, event.PhysicalResourceId);
                    return;
                  }
                  catch (error) {
                    console.log(error);
                    if (!(error instanceof ParameterNotFound)){
                      await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while accessing LZA ssm parameter ' + pipelineStackVersionSsmParamName }, event.PhysicalResourceId);
                      return;
                    }
                  }
              }
          
              // Create /accelerator/lza-prefix SSM parameter to store prefix value to protect updating prefix
              try {
                  var newParams = {
                        Name: paramName,
                        Value: prefix,
                        Description: 'LZA created SSM parameter for Accelerator prefix value, DO NOT MODIFY/DELETE this parameter',
                        Type: 'String',
                      };
                  await ssm.send(new PutParameterCommand(newParams));
                  await response.send(event, context, response.SUCCESS, data, event.PhysicalResourceId);
              }
              catch (error) {
                  console.log(error);
                  await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while creating LZA prefix ssm parameter ' + paramName }, event.PhysicalResourceId);
                  return;
              }
          }
          if (event.RequestType === 'Delete') {

            var deleteParams = {
              Name: paramName,
            };
            try {
              await ssm.send(new DeleteParameterCommand(deleteParams));
            }
            catch (error) {
              console.log(error);
              if (!(error instanceof ParameterNotFound)){
                await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while deleting LZA ssm parameter ' + paramName }, event.PhysicalResourceId);
                return;
              }
            }
            await response.send(event, context, response.SUCCESS, {'Status': 'Custom resource deleted successfully' }, event.PhysicalResourceId);
          }
          
          return;
      }",
        },
        "Description": "This function converts accelerator prefix parameter to lower case to name s3 buckets in installer stack",
        "Handler": "index.handler",
        "Role": {
          "Fn::GetAtt": [
            "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2",
            "Arn",
          ],
        },
        "Runtime": "nodejs22.x",
      },
      "Type": "AWS::Lambda::Function",
    },
    "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "Needed to write to CWL group",
            },
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Needed to create SSM parameter for prefix",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRoleDefaultPolicyDC1CC159": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "Needed to write to CWL group",
            },
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Needed to create SSM parameter for prefix",
            },
          ],
        },
      },
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "ssm:GetParameters",
                "ssm:GetParameter",
                "ssm:PutParameter",
                "ssm:DeleteParameter",
              ],
              "Condition": {
                "StringEquals": {
                  "aws:PrincipalAccount": {
                    "Ref": "AWS::AccountId",
                  },
                },
              },
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":ssm:",
                      {
                        "Ref": "AWS::Region",
                      },
                      ":",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":parameter/accelerator/lza-prefix",
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":ssm:",
                      {
                        "Ref": "AWS::Region",
                      },
                      ":",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":parameter/accelerator/AWSAccelerator-PipelineStack-",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      "-",
                      {
                        "Ref": "AWS::Region",
                      },
                      "/version",
                    ],
                  ],
                },
              ],
              "Sid": "SsmReadParameterAccess",
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRoleDefaultPolicyDC1CC159",
        "Roles": [
          {
            "Ref": "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "SecurityGroup": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "GroupDescription": "Security group for VPC",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::SecurityGroup",
    },
    "SsmAutomationRole": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Wild card permissions are needed on describe and run task calls.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ssm.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "ecs:RunTask",
                    "ecs:DescribeTasks",
                  ],
                  "Effect": "Allow",
                  "Resource": "*",
                },
                {
                  "Action": [
                    "iam:PassRole",
                  ],
                  "Effect": "Allow",
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "EcsExecutionRole",
                        "Arn",
                      ],
                    },
                    {
                      "Fn::GetAtt": [
                        "EcsTaskRole",
                        "Arn",
                      ],
                    },
                  ],
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "EcsRunTaskPolicy",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "SsmParamAcceleratorVersionFF83282D": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/TestInstallerContainerStackSingleAccount/version",
            ],
          ],
        },
        "Type": "String",
        "Value": "1.15.0",
      },
      "Type": "AWS::SSM::Parameter",
    },
    "SsmParamStackId521A78D3": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/TestInstallerContainerStackSingleAccount/stack-id",
            ],
          ],
        },
        "Type": "String",
        "Value": {
          "Ref": "AWS::StackId",
        },
      },
      "Type": "AWS::SSM::Parameter",
    },
    "TaskDefinition": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-ECS2",
              "reason": "Environment variables are needed to turn off features made for services relying on CodePipeline and CodeBuild",
            },
          ],
        },
      },
      "Properties": {
        "ContainerDefinitions": [
          {
            "Command": [
              "/landing-zone-accelerator-on-aws/scripts/run-lza.sh deploy",
            ],
            "EntryPoint": [
              "sh",
              "-c",
            ],
            "Environment": [
              {
                "Name": "ENABLE_DIAGNOSTICS_PACK",
                "Value": "No",
              },
              {
                "Name": "SkipPipelinePrerequisites",
                "Value": "true",
              },
              {
                "Name": "SkipAcceleratorPrerequisites",
                "Value": "true",
              },
              {
                "Name": "AWS_REGION",
                "Value": {
                  "Ref": "AWS::Region",
                },
              },
              {
                "Name": "CONFIG_S3_PATH",
                "Value": {
                  "Fn::If": [
                    "CreateConfigCondition",
                    {
                      "Fn::Join": [
                        "",
                        [
                          "s3://",
                          {
                            "Fn::GetAtt": [
                              "ResourceNamePrefixesGetPrefixResource96A10E6E",
                              "lowerCasePrefix",
                            ],
                          },
                          "-config-",
                          {
                            "Ref": "AWS::AccountId",
                          },
                          "-",
                          {
                            "Ref": "AWS::Region",
                          },
                          "/lza/aws-accelerator-config.zip",
                        ],
                      ],
                    },
                    {
                      "Fn::Join": [
                        "",
                        [
                          "s3://",
                          {
                            "Ref": "ExistingConfigBucketName",
                          },
                          "/",
                          {
                            "Ref": "ExistingConfigBucketKey",
                          },
                        ],
                      ],
                    },
                  ],
                },
              },
              {
                "Name": "CONFIG_S3_BUCKET",
                "Value": {
                  "Fn::If": [
                    "CreateConfigCondition",
                    {
                      "Fn::Join": [
                        "",
                        [
                          {
                            "Fn::GetAtt": [
                              "ResourceNamePrefixesGetPrefixResource96A10E6E",
                              "lowerCasePrefix",
                            ],
                          },
                          "-config-",
                          {
                            "Ref": "AWS::AccountId",
                          },
                          "-",
                          {
                            "Ref": "AWS::Region",
                          },
                        ],
                      ],
                    },
                    {
                      "Ref": "ExistingConfigBucketName",
                    },
                  ],
                },
              },
              {
                "Name": "CONFIG_S3_KEY",
                "Value": {
                  "Fn::If": [
                    "CreateConfigCondition",
                    "lza/aws-accelerator-config.zip",
                    {
                      "Ref": "ExistingConfigBucketKey",
                    },
                  ],
                },
              },
              {
                "Name": "CONFIG_BUCKET_NAME",
                "Value": {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "ResourceNamePrefixesGetPrefixResource96A10E6E",
                          "lowerCasePrefix",
                        ],
                      },
                      "-config-",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      "-",
                      {
                        "Ref": "AWS::Region",
                      },
                    ],
                  ],
                },
              },
              {
                "Name": "MANAGEMENT_ACCOUNT_EMAIL",
                "Value": {
                  "Ref": "ManagementAccountEmail",
                },
              },
              {
                "Name": "LOG_ARCHIVE_ACCOUNT_EMAIL",
                "Value": {
                  "Ref": "LogArchiveAccountEmail",
                },
              },
              {
                "Name": "AUDIT_ACCOUNT_EMAIL",
                "Value": {
                  "Ref": "AuditAccountEmail",
                },
              },
              {
                "Name": "CONTROL_TOWER_ENABLED",
                "Value": {
                  "Ref": "ControlTowerEnabled",
                },
              },
              {
                "Name": "ACCELERATOR_PREFIX",
                "Value": {
                  "Fn::GetAtt": [
                    "ResourceNamePrefixesGetPrefixResource96A10E6E",
                    "acceleratorPrefix",
                  ],
                },
              },
              {
                "Name": "INSTALLER_STACK_NAME",
                "Value": {
                  "Fn::Sub": "\${AWS::StackName}",
                },
              },
              {
                "Name": "PARTITION",
                "Value": {
                  "Fn::Sub": "\${AWS::Partition}",
                },
              },
              {
                "Name": "PIPELINE_ACCOUNT_ID",
                "Value": {
                  "Ref": "AWS::AccountId",
                },
              },
              {
                "Name": "LOG_LEVEL",
                "Value": {
                  "Ref": "LogLevel",
                },
              },
              {
                "Name": "ACCELERATOR_ENABLE_SINGLE_ACCOUNT_MODE",
                "Value": "true",
              },
              {
                "Name": "SINGLE_ACCOUNT_MODE",
                "Value": "true",
              },
            ],
            "Image": {
              "Ref": "EcrUri",
            },
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-group": {
                  "Ref": "LogGroup",
                },
                "awslogs-region": {
                  "Ref": "AWS::Region",
                },
                "awslogs-stream-prefix": "ecs",
              },
            },
            "Name": "lza-deployment-container",
          },
        ],
        "Cpu": "8192",
        "ExecutionRoleArn": {
          "Fn::GetAtt": [
            "EcsExecutionRole",
            "Arn",
          ],
        },
        "Family": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-lza-deployment-task",
            ],
          ],
        },
        "Memory": "32768",
        "NetworkMode": "awsvpc",
        "RequiresCompatibilities": [
          "EC2",
          "FARGATE",
        ],
        "TaskRoleArn": {
          "Fn::GetAtt": [
            "EcsTaskRole",
            "Arn",
          ],
        },
      },
      "Type": "AWS::ECS::TaskDefinition",
    },
    "Vpc": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "CidrBlock": {
          "Ref": "VpcCidr",
        },
        "EnableDnsHostnames": true,
        "EnableDnsSupport": true,
        "InstanceTenancy": "default",
      },
      "Type": "AWS::EC2::VPC",
    },
    "VpcFlowLog": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DeliverLogsPermissionArn": {
          "Fn::GetAtt": [
            "VpcFlowLogRole",
            "Arn",
          ],
        },
        "LogDestinationType": "cloud-watch-logs",
        "LogGroupName": {
          "Ref": "VpcFlowLogGroup",
        },
        "ResourceId": {
          "Ref": "Vpc",
        },
        "ResourceType": "VPC",
        "TrafficType": "ALL",
      },
      "Type": "AWS::EC2::FlowLog",
    },
    "VpcFlowLogGroup": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/aws/vpc/flowlogs/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
            ],
          ],
        },
        "RetentionInDays": 365,
      },
      "Type": "AWS::Logs::LogGroup",
    },
    "VpcFlowLogRole": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "vpc-flow-logs.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "logs:CreateLogStream",
                    "logs:PutLogEvents",
                    "logs:DescribeLogGroups",
                    "logs:DescribeLogStreams",
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::GetAtt": [
                      "VpcFlowLogGroup",
                      "Arn",
                    ],
                  },
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "CloudWatchLogPolicy",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "VpcGatewayAttachment": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "InternetGatewayId": {
          "Ref": "InternetGateway",
        },
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::VPCGatewayAttachment",
    },
  },
  "Rules": {
    "RequiredParametersForExistingRepo": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingConfigBucketKey",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "existingConfigBucketKey parameter must be provided when useExistingConfig is set to Yes",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingConfigBucketName",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "existingConfigBucketName parameter must be provided when useExistingRepository is set to Yes",
        },
      ],
      "RuleCondition": {
        "Fn::Equals": [
          "Yes",
          {
            "Ref": "UseExistingConfig",
          },
        ],
      },
    },
    "RequiredParametersForExistingVpc": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingVpcId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ExistingVpcId parameter must be provided when UseExistingVpc is set to Yes",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingSubnetId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ExistingSubnetId parameter must be provided when UseExistingVpc is set to Yes",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingSecurityGroupId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ExistingSecurityGroupId parameter must be provided when UseExistingVpc is set to Yes",
        },
      ],
      "RuleCondition": {
        "Fn::Equals": [
          "Yes",
          {
            "Ref": "UseExistingVpc",
          },
        ],
      },
    },
    "UniqueAccountEmails": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "ManagementAccountEmail",
                  },
                  {
                    "Ref": "LogArchiveAccountEmail",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "Management Account Email and Log Archive Account Email must be different",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "ManagementAccountEmail",
                  },
                  {
                    "Ref": "AuditAccountEmail",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "Management Account Email and Audit Account Email must be different",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "LogArchiveAccountEmail",
                  },
                  {
                    "Ref": "AuditAccountEmail",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "Log Archive Account Email and Audit Account Email must be different",
        },
      ],
    },
  },
}
`;

exports[`InstallerContainerStack > Construct(InstallerContainerStack): With External Pipeline Account Snapshot Test 1`] = `
{
  "Conditions": {
    "CreateConfigCondition": {
      "Fn::Equals": [
        "No",
        {
          "Ref": "UseExistingConfig",
        },
      ],
    },
    "CreateVpcCondition": {
      "Fn::Equals": [
        "No",
        {
          "Ref": "UseExistingVpc",
        },
      ],
    },
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "Source Configuration",
          },
          "Parameters": [
            "EcrUri",
          ],
        },
        {
          "Label": {
            "default": "Mandatory Accounts Configuration",
          },
          "Parameters": [
            "ManagementAccountEmail",
            "LogArchiveAccountEmail",
            "AuditAccountEmail",
          ],
        },
        {
          "Label": {
            "default": "Environment Configuration",
          },
          "Parameters": [
            "ControlTowerEnabled",
            "AcceleratorPrefix",
            "PythonRuntimeVersion",
            "LogLevel",
          ],
        },
        {
          "Label": {
            "default": "Config Bucket Configuration",
          },
          "Parameters": [
            "UseExistingConfig",
            "ExistingConfigBucketName",
            "ExistingConfigBucketKey",
          ],
        },
        {
          "Label": {
            "default": "Network Configuration",
          },
          "Parameters": [
            "VpcCidr",
            "UseExistingVpc",
            "ExistingVpcId",
            "ExistingSubnetId",
            "ExistingSecurityGroupId",
          ],
        },
        {
          "Label": {
            "default": "Target Environment Configuration",
          },
          "Parameters": [
            "AcceleratorQualifier",
            "ManagementAccountId",
            "ManagementAccountRoleName",
          ],
        },
      ],
      "ParameterLabels": {
        "AcceleratorPrefix": {
          "default": "Accelerator Resource name prefix",
        },
        "AcceleratorQualifier": {
          "default": "Accelerator Qualifier",
        },
        "AuditAccountEmail": {
          "default": "Audit Account Email",
        },
        "ControlTowerEnabled": {
          "default": "Control Tower Environment",
        },
        "EcrUri": {
          "default": "ECR URI",
        },
        "ExistingSecurityGroupId": {
          "default": "Existing Security Group ID",
        },
        "ExistingSubnetId": {
          "default": "Existing Subnet ID",
        },
        "ExistingVpcId": {
          "default": "Existing VPC ID",
        },
        "LogArchiveAccountEmail": {
          "default": "Log Archive Account Email",
        },
        "LogLevel": {
          "default": "Log Level",
        },
        "ManagementAccountEmail": {
          "default": "Management Account Email",
        },
        "ManagementAccountId": {
          "default": "Management Account ID",
        },
        "ManagementAccountRoleName": {
          "default": "Management Account Role Name",
        },
        "PythonRuntimeVersion": {
          "default": "Python Runtime Version (for SSM aws:executeScript)",
        },
        "UseExistingVpc": {
          "default": "Use Existing VPC",
        },
        "VpcCidr": {
          "default": "VPC CIDR Block",
        },
      },
    },
  },
  "Outputs": {
    "DeploySolutionDocumentOutput": {
      "Description": "SSM Document name that will be used to trigger automation for LZA engine using container",
      "Value": {
        "Ref": "DeploySolutionDocument",
      },
    },
  },
  "Parameters": {
    "AcceleratorPrefix": {
      "AllowedPattern": "[A-Za-z0-9-]+",
      "Default": "AWSAccelerator",
      "Description": "The prefix value for accelerator deployed resources. Leave the default value if using solution defined resource name prefix, the solution will use AWSAccelerator as resource name prefix. Note: Updating this value after initial installation will cause stack failure. Non-default value can not start with keyword "aws" or "ssm". Trailing dash (-) in non-default value will be ignored.",
      "MaxLength": 15,
      "Type": "String",
    },
    "AcceleratorQualifier": {
      "AllowedPattern": "^[a-z]+[a-z0-9-]{1,61}[a-z0-9]+$",
      "ConstraintDescription": "Qualifier must include lowercase letters and numbers only and cannot be aws-accelerator",
      "Description": "Names the resources in the external deployment account. This must be unique for each LZA pipeline created in a single external deployment account, for example "env2" or "app1." Do not use "aws-accelerator" or a similar value that could be confused with the prefix."",
      "Type": "String",
    },
    "AuditAccountEmail": {
      "AllowedPattern": "[^\\s@]+@[^\\s@]+\\.[^\\s@]+",
      "ConstraintDescription": "Must be a valid email address matching "[^\\s@]+@[^\\s@]+\\.[^\\s@]+"",
      "Description": "The security audit account (also referred to as the audit account)",
      "Type": "String",
    },
    "ControlTowerEnabled": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "Yes",
      "Description": "Select yes if deploying to a Control Tower environment.  Select no if using just Organizations. If no, you must first set up mandatory accounts.",
      "Type": "String",
    },
    "EcrUri": {
      "Description": "The Amazon Elastic Container Registry (Amazon ECR) repository, where Landing Zone Accelerator on AWS code is present.",
      "Type": "String",
    },
    "ExistingConfigBucketKey": {
      "Default": "",
      "Description": "Specify the branch name of the existing LZA configuration bucket key to pull the accelerator configuration from.",
      "Type": "String",
    },
    "ExistingConfigBucketName": {
      "Default": "",
      "Description": "The name of an existing LZA configuration bucket hosting the accelerator configuration.",
      "Type": "String",
    },
    "ExistingSecurityGroupId": {
      "Default": "",
      "Description": "The ID of an existing security group (required when UseExistingVpc is Yes)",
      "Type": "String",
    },
    "ExistingSubnetId": {
      "Default": "",
      "Description": "The ID of an existing subnet (required when UseExistingVpc is Yes)",
      "Type": "String",
    },
    "ExistingVpcId": {
      "Default": "",
      "Description": "The ID of an existing VPC (required when UseExistingVpc is Yes)",
      "Type": "String",
    },
    "LogArchiveAccountEmail": {
      "AllowedPattern": "[^\\s@]+@[^\\s@]+\\.[^\\s@]+",
      "ConstraintDescription": "Must be a valid email address matching "[^\\s@]+@[^\\s@]+\\.[^\\s@]+"",
      "Description": "The log archive account email",
      "Type": "String",
    },
    "LogLevel": {
      "AllowedValues": [
        "error",
        "info",
        "debug",
      ],
      "Default": "error",
      "Description": "The log level for LZA engine. Controls the verbosity of logs generated during deployment.",
      "Type": "String",
    },
    "ManagementAccountEmail": {
      "AllowedPattern": "[^\\s@]+@[^\\s@]+\\.[^\\s@]+",
      "ConstraintDescription": "Must be a valid email address matching "[^\\s@]+@[^\\s@]+\\.[^\\s@]+"",
      "Description": "The management (primary) account email - NOTE: This must match the address of the management account email as listed in AWS Organizations > AWS accounts.",
      "Type": "String",
    },
    "ManagementAccountId": {
      "Description": "Target management account id",
      "Type": "String",
    },
    "ManagementAccountRoleName": {
      "Description": "Target management account role name",
      "Type": "String",
    },
    "PythonRuntimeVersion": {
      "Default": "python3.11",
      "Description": "The Python runtime version for SSM Document aws:executeScript actions. Must match SSM supported runtimes (e.g., python3.8, python3.9, python3.10, python3.11).",
      "Type": "String",
    },
    "UseExistingConfig": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Select Yes if deploying the solution with an existing configuration. Leave the default value if using the solution-deployed bucket. If the AcceleratorPrefix parameter is set to the default value, the solution will deploy a bucket named "aws-accelerator-config-$account-$region." Otherwise, the solution-deployed bucket will be named "AcceleratorPrefix-config-$account-$region." Note: Updating this value after initial installation may cause adverse affects.",
      "Type": "String",
    },
    "UseExistingVpc": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Select Yes to use an existing VPC. If Yes, provide existing subnet and security group IDs.",
      "Type": "String",
    },
    "VpcCidr": {
      "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$",
      "Default": "10.0.0.0/16",
      "Description": "The CIDR block for the VPC (used when UseExistingVpc is No)",
      "Type": "String",
    },
  },
  "Resources": {
    "AcceleratorManagementKmsArnParameter1E6975BF": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/",
              {
                "Ref": "AcceleratorQualifier",
              },
              "/installer/kms/key-arn",
            ],
          ],
        },
        "Type": "String",
        "Value": {
          "Fn::GetAtt": [
            "InstallerKey2A6A8C6D",
            "Arn",
          ],
        },
      },
      "Type": "AWS::SSM::Parameter",
    },
    "ConfigBucket": {
      "Condition": "CreateConfigCondition",
      "DeletionPolicy": "Retain",
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "KMSMasterKeyID": {
                  "Fn::GetAtt": [
                    "InstallerKey2A6A8C6D",
                    "Arn",
                  ],
                },
                "SSEAlgorithm": "aws:kms",
              },
            },
          ],
        },
        "BucketName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AcceleratorQualifier",
              },
              "-config-",
              {
                "Ref": "AWS::AccountId",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
            ],
          ],
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "AbortIncompleteMultipartUpload": {
                "DaysAfterInitiation": 1,
              },
              "ExpirationInDays": 1825,
              "ExpiredObjectDeleteMarker": false,
              "Id": {
                "Fn::Join": [
                  "",
                  [
                    "LifecycleRule",
                    {
                      "Ref": "AcceleratorQualifier",
                    },
                    "-config-",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    "-",
                    {
                      "Ref": "AWS::Region",
                    },
                  ],
                ],
              },
              "NoncurrentVersionExpiration": {
                "NoncurrentDays": 1825,
              },
              "NoncurrentVersionTransitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 366,
                },
              ],
              "Status": "Enabled",
              "Transitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 365,
                },
              ],
            },
          ],
        },
        "LoggingConfiguration": {
          "DestinationBucketName": {
            "Ref": "InstallerAccessLogsBucket647700E9",
          },
          "LogFilePrefix": {
            "Fn::Join": [
              "",
              [
                {
                  "Ref": "AcceleratorQualifier",
                },
                "-config-",
                {
                  "Ref": "AWS::AccountId",
                },
                "-",
                {
                  "Ref": "AWS::Region",
                },
                "/",
              ],
            ],
          },
        },
        "OwnershipControls": {
          "Rules": [
            {
              "ObjectOwnership": "BucketOwnerPreferred",
            },
          ],
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true,
        },
        "VersioningConfiguration": {
          "Status": "Enabled",
        },
      },
      "Type": "AWS::S3::Bucket",
      "UpdateReplacePolicy": "Retain",
    },
    "ConfigBucketPolicy": {
      "Condition": "CreateConfigCondition",
      "Properties": {
        "Bucket": {
          "Ref": "ConfigBucket",
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:*",
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false",
                },
              },
              "Effect": "Deny",
              "Principal": {
                "AWS": "*",
              },
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "ConfigBucket",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "ConfigBucket",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
              "Sid": "deny-insecure-connections",
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::S3::BucketPolicy",
    },
    "DeploySolutionDocument": {
      "Properties": {
        "Content": {
          "assumeRole": "{{AutomationAssumeRole}}",
          "description": "Automation document to deploy Landing Zone Accelerator on AWS (LZA) solution by running ECS Fargate tasks in a private subnet",
          "mainSteps": [
            {
              "action": "aws:executeScript",
              "description": "Starts a new ECS task and returns task details with CloudWatch log URL",
              "inputs": {
                "Handler": "handler",
                "InputPayload": {
                  "Cluster": "{{Cluster}}",
                  "LogGroupName": {
                    "Ref": "LogGroup",
                  },
                  "Region": {
                    "Ref": "AWS::Region",
                  },
                  "SecurityGroupId": "{{SecurityGroupId}}",
                  "SolutionId": "AwsSolution/SO0199/1.15.0",
                  "SubnetId": "{{SubnetId}}",
                  "TaskDefinition": "{{TaskDefinition}}",
                },
                "Runtime": "{{PythonRuntime}}",
                "Script": "REPLACED-JSON-PATH.json",
              },
              "name": "RunTask",
              "outputs": [
                {
                  "Name": "ClusterName",
                  "Selector": "$.Payload.ClusterName",
                  "Type": "String",
                },
                {
                  "Name": "TaskArn",
                  "Selector": "$.Payload.TaskArn",
                  "Type": "String",
                },
                {
                  "Name": "LogGroupName",
                  "Selector": "$.Payload.LogGroupName",
                  "Type": "String",
                },
                {
                  "Name": "LogStreamName",
                  "Selector": "$.Payload.LogStreamName",
                  "Type": "String",
                },
              ],
              "timeoutSeconds": 600,
            },
            {
              "action": "aws:waitForAwsResourceProperty",
              "description": "Wait for ECS task to complete",
              "inputs": {
                "Api": "DescribeTasks",
                "DesiredValues": [
                  "STOPPED",
                ],
                "PropertySelector": "$.tasks[0].lastStatus",
                "Service": "ecs",
                "cluster": "{{RunTask.ClusterName}}",
                "tasks": [
                  "{{RunTask.TaskArn}}",
                ],
              },
              "name": "WaitForTaskCompletion",
              "outputs": [
                {
                  "Name": "TaskStatus",
                  "Selector": "$.tasks[0].lastStatus",
                  "Type": "String",
                },
              ],
              "timeoutSeconds": 43200,
            },
            {
              "action": "aws:executeScript",
              "description": "Verifies the container exit code after task completion and fails the automation if exit code is non-zero",
              "inputs": {
                "Handler": "handler",
                "InputPayload": {
                  "ClusterName": "{{RunTask.ClusterName}}",
                  "LogGroupName": "{{RunTask.LogGroupName}}",
                  "LogStreamName": "{{RunTask.LogStreamName}}",
                  "Region": {
                    "Ref": "AWS::Region",
                  },
                  "SolutionId": "AwsSolution/SO0199/1.15.0",
                  "TaskArn": "{{RunTask.TaskArn}}",
                },
                "Runtime": "{{PythonRuntime}}",
                "Script": "import boto3
from botocore.config import Config

def handler(event, context):
    config = Config(user_agent_extra=event['SolutionId']) 
    client = boto3.client('ecs', region_name=event['Region'], config=config)
    
    response = client.describe_tasks(
        cluster=event['ClusterName'],
        tasks=[event['TaskArn']]
    )
    
    if not response['tasks']:
        raise Exception(f"Task not found: {event['TaskArn']}")
    
    task = response['tasks'][0]
    containers = task.get('containers', [])
    
    if not containers:
        raise Exception(f"No containers found in task: {event['TaskArn']}")
    
    # Extract exit code from tasks[0].containers[0].exitCode
    container = containers[0]
    exit_code = container.get('exitCode')  # Can be 0, 1, 137, etc. or None if killed
    
    # Extract task-level stop information
    stop_code = task.get('stopCode', 'Unknown')  # e.g., "EssentialContainerExited"
    stop_reason = task.get('stoppedReason', 'Unknown')  # e.g., "Essential container in task exited"
    task_status = task.get('lastStatus', 'Unknown')
    
    result = {
        'ExitCode': exit_code if exit_code is not None else -1,
        'StopCode': stop_code,
        'StopReason': stop_reason,
        'TaskStatus': task_status,
        'LogStreamName': event['LogStreamName'],
        'LogGroupName': event['LogGroupName']
    }
    
    # Fail if exit code is non-zero or None (container was killed)
    if exit_code is None or exit_code != 0:
        error_msg = (
            f"ECS task failed with exit code {exit_code}. "
            f"Stop code: {stop_code}. "
            f"Stop reason: {stop_reason}. "
            f"Check CloudWatch logs: {event['LogGroupName']}/{event['LogStreamName']}"
        )
        raise Exception(error_msg)
    
    return result",
              },
              "name": "CheckTaskExitCode",
              "outputs": [
                {
                  "Name": "ExitCode",
                  "Selector": "$.Payload.ExitCode",
                  "Type": "Integer",
                },
                {
                  "Name": "StopCode",
                  "Selector": "$.Payload.StopCode",
                  "Type": "String",
                },
                {
                  "Name": "StopReason",
                  "Selector": "$.Payload.StopReason",
                  "Type": "String",
                },
                {
                  "Name": "TaskStatus",
                  "Selector": "$.Payload.TaskStatus",
                  "Type": "String",
                },
              ],
              "timeoutSeconds": 600,
            },
          ],
          "outputs": [
            "RunTask.TaskArn",
            "RunTask.ClusterName",
            "RunTask.LogGroupName",
            "RunTask.LogStreamName",
            "WaitForTaskCompletion.TaskStatus",
            "CheckTaskExitCode.ExitCode",
            "CheckTaskExitCode.StopCode",
            "CheckTaskExitCode.StopReason",
          ],
          "parameters": {
            "AutomationAssumeRole": {
              "default": {
                "Fn::GetAtt": [
                  "SsmAutomationRole",
                  "Arn",
                ],
              },
              "description": "The ARN of the IAM role that allows Systems Manager Automation to perform actions",
              "type": "String",
            },
            "Cluster": {
              "default": {
                "Ref": "EcsCluster",
              },
              "description": "The short name or full ARN of the cluster to run your task on",
              "type": "String",
            },
            "PythonRuntime": {
              "default": {
                "Ref": "PythonRuntimeVersion",
              },
              "description": "The Python runtime version for aws:executeScript actions",
              "type": "String",
            },
            "SecurityGroupId": {
              "default": {
                "Fn::If": [
                  "CreateVpcCondition",
                  {
                    "Ref": "SecurityGroup",
                  },
                  {
                    "Ref": "ExistingSecurityGroupId",
                  },
                ],
              },
              "description": "The security group used by the ECS task",
              "type": "String",
            },
            "SubnetId": {
              "default": {
                "Fn::If": [
                  "CreateVpcCondition",
                  {
                    "Ref": "PrivateSubnet0",
                  },
                  {
                    "Ref": "ExistingSubnetId",
                  },
                ],
              },
              "description": "The subnet where the ECS task will be placed",
              "type": "String",
            },
            "TaskDefinition": {
              "default": {
                "Ref": "TaskDefinition",
              },
              "description": "The family and revision or full ARN of the task definition to run",
              "type": "String",
            },
          },
          "schemaVersion": "0.3",
        },
        "DocumentType": "Automation",
        "Name": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AcceleratorQualifier",
              },
              "-RunEngine",
            ],
          ],
        },
        "UpdateMethod": "NewVersion",
      },
      "Type": "AWS::SSM::Document",
    },
    "EcsCluster": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-ECS4",
              "reason": "The ECS Cluster has CloudWatch Container Insights are not present in all partitions.",
            },
            {
              "id": "AwsSolutions-ECS7",
              "reason": "The ECS task definition used has logging enabled to CloudWatch logs.",
            },
          ],
        },
      },
      "Properties": {
        "ClusterName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AcceleratorQualifier",
              },
              "-ecs-cluster",
            ],
          ],
        },
      },
      "Type": "AWS::ECS::Cluster",
    },
    "EcsExecutionRole": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "The ECS task needs admin access to orchestrate the engine.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/AdministratorAccess",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "EcsTaskRole": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "The ECS task needs admin access to orchestrate LZA deployment and manage AWS resources.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/AdministratorAccess",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "InstallerAccessLogsBucket647700E9": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-S1",
              "reason": "AccessLogsBucket has server access logs disabled till the task for access logging completed.",
            },
          ],
        },
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W35",
              "reason": "This is an access logging bucket.",
            },
          ],
        },
      },
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256",
              },
            },
          ],
        },
        "BucketName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AcceleratorQualifier",
              },
              "-s3-logs-",
              {
                "Ref": "AWS::AccountId",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
            ],
          ],
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "AbortIncompleteMultipartUpload": {
                "DaysAfterInitiation": 1,
              },
              "ExpirationInDays": 1825,
              "ExpiredObjectDeleteMarker": false,
              "Id": {
                "Fn::Join": [
                  "",
                  [
                    "LifecycleRule",
                    {
                      "Ref": "AcceleratorQualifier",
                    },
                    "-s3-logs-",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    "-",
                    {
                      "Ref": "AWS::Region",
                    },
                  ],
                ],
              },
              "NoncurrentVersionExpiration": {
                "NoncurrentDays": 1825,
              },
              "NoncurrentVersionTransitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 366,
                },
              ],
              "Status": "Enabled",
              "Transitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 365,
                },
              ],
            },
          ],
        },
        "OwnershipControls": {
          "Rules": [
            {
              "ObjectOwnership": "BucketOwnerPreferred",
            },
          ],
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true,
        },
        "VersioningConfiguration": {
          "Status": "Enabled",
        },
      },
      "Type": "AWS::S3::Bucket",
      "UpdateReplacePolicy": "Retain",
    },
    "InstallerAccessLogsBucketName4F700F48": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/",
              {
                "Ref": "AcceleratorQualifier",
              },
              "/installer-access-logs-bucket-name",
            ],
          ],
        },
        "Type": "String",
        "Value": {
          "Ref": "InstallerAccessLogsBucket647700E9",
        },
      },
      "Type": "AWS::SSM::Parameter",
    },
    "InstallerAccessLogsBucketPolicy20D4E285": {
      "Properties": {
        "Bucket": {
          "Ref": "InstallerAccessLogsBucket647700E9",
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:*",
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false",
                },
              },
              "Effect": "Deny",
              "Principal": {
                "AWS": "*",
              },
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "InstallerAccessLogsBucket647700E9",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "InstallerAccessLogsBucket647700E9",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
              "Sid": "deny-insecure-connections",
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::S3::BucketPolicy",
    },
    "InstallerKey2A6A8C6D": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "F76",
              "reason": "KMS key using * principal with added arn condition",
            },
          ],
        },
      },
      "Properties": {
        "Description": "KMS key for encrypting LZA installer S3 configuration bucket in the management account",
        "EnableKeyRotation": true,
        "KeyPolicy": {
          "Statement": [
            {
              "Action": "kms:*",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":iam::",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":root",
                    ],
                  ],
                },
              },
              "Resource": "*",
            },
            {
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ],
              "Condition": {
                "ArnLike": {
                  "aws:PrincipalARN": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":iam::",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":role/",
                        {
                          "Ref": "AcceleratorQualifier",
                        },
                        "-*",
                      ],
                    ],
                  },
                },
              },
              "Effect": "Allow",
              "Principal": {
                "AWS": "*",
              },
              "Resource": "*",
              "Sid": "Allow Accelerator Role to use the encryption key",
            },
            {
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": "sns.amazonaws.com",
              },
              "Resource": "*",
              "Sid": "Allow SNS service to use the encryption key",
            },
            {
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ],
              "Condition": {
                "ArnLike": {
                  "kms:EncryptionContext:aws:logs:arn": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":logs:",
                        {
                          "Ref": "AWS::Region",
                        },
                        ":",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":log-group:*",
                      ],
                    ],
                  },
                },
              },
              "Effect": "Allow",
              "Principal": {
                "Service": {
                  "Fn::Join": [
                    "",
                    [
                      "logs.",
                      {
                        "Ref": "AWS::Region",
                      },
                      ".amazonaws.com",
                    ],
                  ],
                },
              },
              "Resource": "*",
              "Sid": "Allow Cloudwatch Logs service to use the encryption key",
            },
          ],
        },
      },
      "Type": "AWS::KMS::Key",
      "UpdateReplacePolicy": "Retain",
    },
    "InstallerKeyAliasD5C174F0": {
      "Properties": {
        "AliasName": {
          "Fn::Join": [
            "",
            [
              "alias/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/",
              {
                "Ref": "AcceleratorQualifier",
              },
              "/installer/kms/key",
            ],
          ],
        },
        "TargetKeyId": {
          "Fn::GetAtt": [
            "InstallerKey2A6A8C6D",
            "Arn",
          ],
        },
      },
      "Type": "AWS::KMS::Alias",
    },
    "InternetGateway": {
      "Condition": "CreateVpcCondition",
      "Type": "AWS::EC2::InternetGateway",
    },
    "LogGroup": {
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/ecs/",
              {
                "Ref": "AcceleratorQualifier",
              },
              "-lza-deployment",
            ],
          ],
        },
        "RetentionInDays": 365,
      },
      "Type": "AWS::Logs::LogGroup",
    },
    "NatEip0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "Domain": "vpc",
      },
      "Type": "AWS::EC2::EIP",
    },
    "NatEip1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "Domain": "vpc",
      },
      "Type": "AWS::EC2::EIP",
    },
    "NatGateway0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "NatEip0",
            "AllocationId",
          ],
        },
        "SubnetId": {
          "Ref": "PublicSubnet0",
        },
      },
      "Type": "AWS::EC2::NatGateway",
    },
    "NatGateway1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "NatEip1",
            "AllocationId",
          ],
        },
        "SubnetId": {
          "Ref": "PublicSubnet1",
        },
      },
      "Type": "AWS::EC2::NatGateway",
    },
    "PrivateRoute0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "NatGateway0",
        },
        "RouteTableId": {
          "Ref": "PrivateRouteTable0",
        },
      },
      "Type": "AWS::EC2::Route",
    },
    "PrivateRoute1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "NatGateway1",
        },
        "RouteTableId": {
          "Ref": "PrivateRouteTable1",
        },
      },
      "Type": "AWS::EC2::Route",
    },
    "PrivateRouteTable0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::RouteTable",
    },
    "PrivateRouteTable1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::RouteTable",
    },
    "PrivateSubnet0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            0,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.10.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PrivateSubnet1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            1,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.11.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PrivateSubnetRouteTableAssociation0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PrivateRouteTable0",
        },
        "SubnetId": {
          "Ref": "PrivateSubnet0",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "PrivateSubnetRouteTableAssociation1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PrivateRouteTable1",
        },
        "SubnetId": {
          "Ref": "PrivateSubnet1",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "PublicRoute": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "InternetGateway",
        },
        "RouteTableId": {
          "Ref": "PublicRouteTable",
        },
      },
      "Type": "AWS::EC2::Route",
    },
    "PublicRouteTable": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::RouteTable",
    },
    "PublicSubnet0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            0,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.0.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PublicSubnet1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            1,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.1.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PublicSubnetRouteTableAssociation0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PublicRouteTable",
        },
        "SubnetId": {
          "Ref": "PublicSubnet0",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "PublicSubnetRouteTableAssociation1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PublicRouteTable",
        },
        "SubnetId": {
          "Ref": "PublicSubnet1",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "ResourceNamePrefixesGetPrefixResource96A10E6E": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "ResourceNamePrefixesResourceNamePrefixesFunction138C66F1",
            "Arn",
          ],
        },
        "pipelineStackVersionSsmParamName": {
          "Fn::Join": [
            "",
            [
              "/accelerator/",
              {
                "Ref": "AcceleratorQualifier",
              },
              "-pipeline-stack-",
              {
                "Ref": "AWS::AccountId",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
              "/version",
            ],
          ],
        },
        "prefix": {
          "Ref": "AcceleratorPrefix",
        },
        "prefixParameterName": {
          "Fn::Join": [
            "",
            [
              "/accelerator/",
              {
                "Ref": "AcceleratorQualifier",
              },
              "/lza-prefix",
            ],
          ],
        },
      },
      "Type": "Custom::GetPrefixes",
      "UpdateReplacePolicy": "Delete",
    },
    "ResourceNamePrefixesResourceNamePrefixesFunction138C66F1": {
      "DependsOn": [
        "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRoleDefaultPolicyDC1CC159",
        "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2",
      ],
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "Needed to write to CWL group",
            },
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Needed to create SSM parameter for prefix",
            },
          ],
        },
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W58",
              "reason": "CloudWatch Logs are enabled in AWSLambdaBasicExecutionRole",
            },
            {
              "id": "W89",
              "reason": "This function supports infrastructure deployment and is not deployed inside a VPC.",
            },
            {
              "id": "W92",
              "reason": "This function supports infrastructure deployment and does not require setting ReservedConcurrentExecutions.",
            },
          ],
        },
      },
      "Properties": {
        "Code": {
          "ZipFile": "
          const response = require('cfn-response'); 
          const { SSMClient, DeleteParameterCommand, GetParameterCommand, ParameterNotFound, PutParameterCommand } = require("@aws-sdk/client-ssm");
          const { ConfiguredRetryStrategy } = require("@aws-sdk/util-retry");
          exports.handler = async function (event, context) { 
          console.log(JSON.stringify(event, null, 4)); 
          const prefix=event.ResourceProperties.prefix;
          const pipelineStackVersionSsmParamName=event.ResourceProperties.pipelineStackVersionSsmParamName;
          const lowerCasePrefix=prefix.toLowerCase();
          
          const ssm = new SSMClient({retryStrategy: new ConfiguredRetryStrategy(10, (attempt) => 100 + attempt * 1000)});
          
          let data = {};
          
          let paramName = event.ResourceProperties.prefixParameterName;
          
          if (lowerCasePrefix === 'awsaccelerator') {
              data['acceleratorPrefix'] = 'AWSAccelerator';
              data['lowerCasePrefix'] = 'aws-accelerator'; 
              data['oneWordPrefix'] = 'accelerator';               
          } else {
              data['acceleratorPrefix'] = prefix;
              data['lowerCasePrefix'] = lowerCasePrefix; 
              data['oneWordPrefix'] = prefix; 
          }
                  

          if (event.RequestType === 'Update'){

              var params = {
                Name: paramName,
              };
              try {
                  const ssmResponse = await ssm.send(new GetParameterCommand(params));
                  // Fail stack if prefix was changed during update
                  if (ssmResponse.Parameter.Value !== prefix) {
                      await response.send(event, context, response.FAILED, {'FailureReason': 'LZA does not allow changing AcceleratorPrefix parameter value after initial deploy !!! Existing prefix: ' + event.OldResourceProperties.prefix + ' New prefix: ' + prefix + '.' }, event.PhysicalResourceId);
                      return;
                  }
                  await response.send(event, context, response.SUCCESS, data, event.PhysicalResourceId);
              } catch (error) {
                  console.log(error);
                  if (error instanceof ParameterNotFound){
                      await response.send(event, context, response.FAILED, {'FailureReason': 'LZA prefix ssm parameter ' + paramName + ' not found!!! Recreate the parameter with existing AcceleratorPrefix parameter value to fix the issue'}, event.PhysicalResourceId);
                      return;
                  }
                  else {
                      await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while accessing LZA prefix ssm parameter ' + paramName }, event.PhysicalResourceId);
                      return;
                  }
              }          
          } 
          
          if (event.RequestType === 'Create') {
          
              if (lowerCasePrefix !== 'awsaccelerator') {
                  // Fail stack if prefix starts with aws or ssm
                  if (lowerCasePrefix.startsWith('aws') || lowerCasePrefix.startsWith('ssm')) { 
                      await response.send(event, context, response.FAILED, {'FailureReason': 'Accelerator prefix ' + prefix + ' can not be started with aws or ssm !!!'}, event.PhysicalResourceId);
                      return;
                  }

                  // Check if this is an existing deployment and prefix changed with initial deployment of custom resource
                  var versionParams = {
                    Name: pipelineStackVersionSsmParamName,
                  };
                  try {
                    await ssm.send(new GetParameterCommand(versionParams));
                    await response.send(event, context, response.FAILED, {'FailureReason': 'Can not change AcceleratorPrefix parameter for existing deployment, existing prefix value is AWSAccelerator, keep AcceleratorPrefix parameter value to default value for successfully stack update !!!'}, event.PhysicalResourceId);
                    return;
                  }
                  catch (error) {
                    console.log(error);
                    if (!(error instanceof ParameterNotFound)){
                      await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while accessing LZA ssm parameter ' + pipelineStackVersionSsmParamName }, event.PhysicalResourceId);
                      return;
                    }
                  }
              }
          
              // Create /accelerator/lza-prefix SSM parameter to store prefix value to protect updating prefix
              try {
                  var newParams = {
                        Name: paramName,
                        Value: prefix,
                        Description: 'LZA created SSM parameter for Accelerator prefix value, DO NOT MODIFY/DELETE this parameter',
                        Type: 'String',
                      };
                  await ssm.send(new PutParameterCommand(newParams));
                  await response.send(event, context, response.SUCCESS, data, event.PhysicalResourceId);
              }
              catch (error) {
                  console.log(error);
                  await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while creating LZA prefix ssm parameter ' + paramName }, event.PhysicalResourceId);
                  return;
              }
          }
          if (event.RequestType === 'Delete') {

            var deleteParams = {
              Name: paramName,
            };
            try {
              await ssm.send(new DeleteParameterCommand(deleteParams));
            }
            catch (error) {
              console.log(error);
              if (!(error instanceof ParameterNotFound)){
                await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while deleting LZA ssm parameter ' + paramName }, event.PhysicalResourceId);
                return;
              }
            }
            await response.send(event, context, response.SUCCESS, {'Status': 'Custom resource deleted successfully' }, event.PhysicalResourceId);
          }
          
          return;
      }",
        },
        "Description": "This function converts accelerator prefix parameter to lower case to name s3 buckets in installer stack",
        "Handler": "index.handler",
        "Role": {
          "Fn::GetAtt": [
            "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2",
            "Arn",
          ],
        },
        "Runtime": "nodejs22.x",
      },
      "Type": "AWS::Lambda::Function",
    },
    "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "Needed to write to CWL group",
            },
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Needed to create SSM parameter for prefix",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRoleDefaultPolicyDC1CC159": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "Needed to write to CWL group",
            },
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Needed to create SSM parameter for prefix",
            },
          ],
        },
      },
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "ssm:GetParameters",
                "ssm:GetParameter",
                "ssm:PutParameter",
                "ssm:DeleteParameter",
              ],
              "Condition": {
                "StringEquals": {
                  "aws:PrincipalAccount": {
                    "Ref": "AWS::AccountId",
                  },
                },
              },
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":ssm:",
                      {
                        "Ref": "AWS::Region",
                      },
                      ":",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":parameter/accelerator/",
                      {
                        "Ref": "AcceleratorQualifier",
                      },
                      "/lza-prefix",
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":ssm:",
                      {
                        "Ref": "AWS::Region",
                      },
                      ":",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":parameter/accelerator/",
                      {
                        "Ref": "AcceleratorQualifier",
                      },
                      "-pipeline-stack-",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      "-",
                      {
                        "Ref": "AWS::Region",
                      },
                      "/version",
                    ],
                  ],
                },
              ],
              "Sid": "SsmReadParameterAccess",
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRoleDefaultPolicyDC1CC159",
        "Roles": [
          {
            "Ref": "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "SecurityGroup": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "GroupDescription": "Security group for VPC",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::SecurityGroup",
    },
    "SsmAutomationRole": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Wild card permissions are needed on describe and run task calls.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ssm.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "ecs:RunTask",
                    "ecs:DescribeTasks",
                  ],
                  "Effect": "Allow",
                  "Resource": "*",
                },
                {
                  "Action": [
                    "iam:PassRole",
                  ],
                  "Effect": "Allow",
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "EcsExecutionRole",
                        "Arn",
                      ],
                    },
                    {
                      "Fn::GetAtt": [
                        "EcsTaskRole",
                        "Arn",
                      ],
                    },
                  ],
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "EcsRunTaskPolicy",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "SsmParamAcceleratorVersionFF83282D": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/",
              {
                "Ref": "AcceleratorQualifier",
              },
              "/TestInstallerContainerStackExternal/version",
            ],
          ],
        },
        "Type": "String",
        "Value": "1.15.0",
      },
      "Type": "AWS::SSM::Parameter",
    },
    "SsmParamStackId521A78D3": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/",
              {
                "Ref": "AcceleratorQualifier",
              },
              "/TestInstallerContainerStackExternal/stack-id",
            ],
          ],
        },
        "Type": "String",
        "Value": {
          "Ref": "AWS::StackId",
        },
      },
      "Type": "AWS::SSM::Parameter",
    },
    "TaskDefinition": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-ECS2",
              "reason": "Environment variables are needed to turn off features made for services relying on CodePipeline and CodeBuild",
            },
          ],
        },
      },
      "Properties": {
        "ContainerDefinitions": [
          {
            "Command": [
              "/landing-zone-accelerator-on-aws/scripts/run-lza.sh deploy",
            ],
            "EntryPoint": [
              "sh",
              "-c",
            ],
            "Environment": [
              {
                "Name": "ENABLE_DIAGNOSTICS_PACK",
                "Value": "No",
              },
              {
                "Name": "SkipPipelinePrerequisites",
                "Value": "true",
              },
              {
                "Name": "SkipAcceleratorPrerequisites",
                "Value": "true",
              },
              {
                "Name": "AWS_REGION",
                "Value": {
                  "Ref": "AWS::Region",
                },
              },
              {
                "Name": "CONFIG_S3_PATH",
                "Value": {
                  "Fn::If": [
                    "CreateConfigCondition",
                    {
                      "Fn::Join": [
                        "",
                        [
                          "s3://",
                          {
                            "Ref": "AcceleratorQualifier",
                          },
                          "-config-",
                          {
                            "Ref": "AWS::AccountId",
                          },
                          "-",
                          {
                            "Ref": "AWS::Region",
                          },
                          "/lza/aws-accelerator-config.zip",
                        ],
                      ],
                    },
                    {
                      "Fn::Join": [
                        "",
                        [
                          "s3://",
                          {
                            "Ref": "ExistingConfigBucketName",
                          },
                          "/",
                          {
                            "Ref": "ExistingConfigBucketKey",
                          },
                        ],
                      ],
                    },
                  ],
                },
              },
              {
                "Name": "CONFIG_S3_BUCKET",
                "Value": {
                  "Fn::If": [
                    "CreateConfigCondition",
                    {
                      "Fn::Join": [
                        "",
                        [
                          {
                            "Ref": "AcceleratorQualifier",
                          },
                          "-config-",
                          {
                            "Ref": "AWS::AccountId",
                          },
                          "-",
                          {
                            "Ref": "AWS::Region",
                          },
                        ],
                      ],
                    },
                    {
                      "Ref": "ExistingConfigBucketName",
                    },
                  ],
                },
              },
              {
                "Name": "CONFIG_S3_KEY",
                "Value": {
                  "Fn::If": [
                    "CreateConfigCondition",
                    "lza/aws-accelerator-config.zip",
                    {
                      "Ref": "ExistingConfigBucketKey",
                    },
                  ],
                },
              },
              {
                "Name": "CONFIG_BUCKET_NAME",
                "Value": {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Ref": "AcceleratorQualifier",
                      },
                      "-config-",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      "-",
                      {
                        "Ref": "AWS::Region",
                      },
                    ],
                  ],
                },
              },
              {
                "Name": "MANAGEMENT_ACCOUNT_EMAIL",
                "Value": {
                  "Ref": "ManagementAccountEmail",
                },
              },
              {
                "Name": "LOG_ARCHIVE_ACCOUNT_EMAIL",
                "Value": {
                  "Ref": "LogArchiveAccountEmail",
                },
              },
              {
                "Name": "AUDIT_ACCOUNT_EMAIL",
                "Value": {
                  "Ref": "AuditAccountEmail",
                },
              },
              {
                "Name": "CONTROL_TOWER_ENABLED",
                "Value": {
                  "Ref": "ControlTowerEnabled",
                },
              },
              {
                "Name": "ACCELERATOR_PREFIX",
                "Value": {
                  "Fn::GetAtt": [
                    "ResourceNamePrefixesGetPrefixResource96A10E6E",
                    "acceleratorPrefix",
                  ],
                },
              },
              {
                "Name": "INSTALLER_STACK_NAME",
                "Value": {
                  "Fn::Sub": "\${AWS::StackName}",
                },
              },
              {
                "Name": "PARTITION",
                "Value": {
                  "Fn::Sub": "\${AWS::Partition}",
                },
              },
              {
                "Name": "PIPELINE_ACCOUNT_ID",
                "Value": {
                  "Ref": "AWS::AccountId",
                },
              },
              {
                "Name": "LOG_LEVEL",
                "Value": {
                  "Ref": "LogLevel",
                },
              },
              {
                "Name": "MANAGEMENT_ACCOUNT_ID",
                "Value": {
                  "Ref": "ManagementAccountId",
                },
              },
              {
                "Name": "MANAGEMENT_ACCOUNT_ROLE_NAME",
                "Value": {
                  "Ref": "ManagementAccountRoleName",
                },
              },
              {
                "Name": "ACCELERATOR_QUALIFIER",
                "Value": {
                  "Ref": "AcceleratorQualifier",
                },
              },
            ],
            "Image": {
              "Ref": "EcrUri",
            },
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-group": {
                  "Ref": "LogGroup",
                },
                "awslogs-region": {
                  "Ref": "AWS::Region",
                },
                "awslogs-stream-prefix": "ecs",
              },
            },
            "Name": "lza-deployment-container",
          },
        ],
        "Cpu": "8192",
        "ExecutionRoleArn": {
          "Fn::GetAtt": [
            "EcsExecutionRole",
            "Arn",
          ],
        },
        "Family": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AcceleratorQualifier",
              },
              "-lza-deployment-task",
            ],
          ],
        },
        "Memory": "32768",
        "NetworkMode": "awsvpc",
        "RequiresCompatibilities": [
          "EC2",
          "FARGATE",
        ],
        "TaskRoleArn": {
          "Fn::GetAtt": [
            "EcsTaskRole",
            "Arn",
          ],
        },
      },
      "Type": "AWS::ECS::TaskDefinition",
    },
    "Vpc": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "CidrBlock": {
          "Ref": "VpcCidr",
        },
        "EnableDnsHostnames": true,
        "EnableDnsSupport": true,
        "InstanceTenancy": "default",
      },
      "Type": "AWS::EC2::VPC",
    },
    "VpcFlowLog": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DeliverLogsPermissionArn": {
          "Fn::GetAtt": [
            "VpcFlowLogRole",
            "Arn",
          ],
        },
        "LogDestinationType": "cloud-watch-logs",
        "LogGroupName": {
          "Ref": "VpcFlowLogGroup",
        },
        "ResourceId": {
          "Ref": "Vpc",
        },
        "ResourceType": "VPC",
        "TrafficType": "ALL",
      },
      "Type": "AWS::EC2::FlowLog",
    },
    "VpcFlowLogGroup": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/aws/vpc/flowlogs/",
              {
                "Ref": "AcceleratorQualifier",
              },
            ],
          ],
        },
        "RetentionInDays": 365,
      },
      "Type": "AWS::Logs::LogGroup",
    },
    "VpcFlowLogRole": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "vpc-flow-logs.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "logs:CreateLogStream",
                    "logs:PutLogEvents",
                    "logs:DescribeLogGroups",
                    "logs:DescribeLogStreams",
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::GetAtt": [
                      "VpcFlowLogGroup",
                      "Arn",
                    ],
                  },
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "CloudWatchLogPolicy",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "VpcGatewayAttachment": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "InternetGatewayId": {
          "Ref": "InternetGateway",
        },
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::VPCGatewayAttachment",
    },
  },
  "Rules": {
    "ExternalPipelineParameterValidation": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "AcceleratorQualifier",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "AcceleratorQualifier parameter must not be empty when using external pipeline account",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ManagementAccountId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ManagementAccountId parameter must not be empty when using external pipeline account",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ManagementAccountRoleName",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ManagementAccountRoleName parameter must not be empty when using external pipeline account",
        },
      ],
    },
    "RequiredParametersForExistingRepo": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingConfigBucketKey",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "existingConfigBucketKey parameter must be provided when useExistingConfig is set to Yes",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingConfigBucketName",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "existingConfigBucketName parameter must be provided when useExistingRepository is set to Yes",
        },
      ],
      "RuleCondition": {
        "Fn::Equals": [
          "Yes",
          {
            "Ref": "UseExistingConfig",
          },
        ],
      },
    },
    "RequiredParametersForExistingVpc": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingVpcId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ExistingVpcId parameter must be provided when UseExistingVpc is set to Yes",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingSubnetId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ExistingSubnetId parameter must be provided when UseExistingVpc is set to Yes",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingSecurityGroupId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ExistingSecurityGroupId parameter must be provided when UseExistingVpc is set to Yes",
        },
      ],
      "RuleCondition": {
        "Fn::Equals": [
          "Yes",
          {
            "Ref": "UseExistingVpc",
          },
        ],
      },
    },
    "UniqueAccountEmails": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "ManagementAccountEmail",
                  },
                  {
                    "Ref": "LogArchiveAccountEmail",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "Management Account Email and Log Archive Account Email must be different",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "ManagementAccountEmail",
                  },
                  {
                    "Ref": "AuditAccountEmail",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "Management Account Email and Audit Account Email must be different",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "LogArchiveAccountEmail",
                  },
                  {
                    "Ref": "AuditAccountEmail",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "Log Archive Account Email and Audit Account Email must be different",
        },
      ],
    },
  },
}
`;

exports[`InstallerContainerStack > Construct(InstallerContainerStack): With Permission Boundary Snapshot Test 1`] = `
{
  "Conditions": {
    "CreateConfigCondition": {
      "Fn::Equals": [
        "No",
        {
          "Ref": "UseExistingConfig",
        },
      ],
    },
    "CreateVpcCondition": {
      "Fn::Equals": [
        "No",
        {
          "Ref": "UseExistingVpc",
        },
      ],
    },
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "Source Configuration",
          },
          "Parameters": [
            "EcrUri",
          ],
        },
        {
          "Label": {
            "default": "Mandatory Accounts Configuration",
          },
          "Parameters": [
            "ManagementAccountEmail",
            "LogArchiveAccountEmail",
            "AuditAccountEmail",
          ],
        },
        {
          "Label": {
            "default": "Environment Configuration",
          },
          "Parameters": [
            "ControlTowerEnabled",
            "AcceleratorPrefix",
            "PythonRuntimeVersion",
            "LogLevel",
          ],
        },
        {
          "Label": {
            "default": "Config Bucket Configuration",
          },
          "Parameters": [
            "UseExistingConfig",
            "ExistingConfigBucketName",
            "ExistingConfigBucketKey",
          ],
        },
        {
          "Label": {
            "default": "Network Configuration",
          },
          "Parameters": [
            "VpcCidr",
            "UseExistingVpc",
            "ExistingVpcId",
            "ExistingSubnetId",
            "ExistingSecurityGroupId",
          ],
        },
        {
          "Label": {
            "default": "Permission Boundary Configuration",
          },
          "Parameters": [
            "PermissionBoundaryPolicyName",
          ],
        },
      ],
      "ParameterLabels": {
        "AcceleratorPrefix": {
          "default": "Accelerator Resource name prefix",
        },
        "AuditAccountEmail": {
          "default": "Audit Account Email",
        },
        "ControlTowerEnabled": {
          "default": "Control Tower Environment",
        },
        "EcrUri": {
          "default": "ECR URI",
        },
        "ExistingSecurityGroupId": {
          "default": "Existing Security Group ID",
        },
        "ExistingSubnetId": {
          "default": "Existing Subnet ID",
        },
        "ExistingVpcId": {
          "default": "Existing VPC ID",
        },
        "LogArchiveAccountEmail": {
          "default": "Log Archive Account Email",
        },
        "LogLevel": {
          "default": "Log Level",
        },
        "ManagementAccountEmail": {
          "default": "Management Account Email",
        },
        "PermissionBoundaryPolicyName": {
          "default": "Permission Boundary Policy Name",
        },
        "PythonRuntimeVersion": {
          "default": "Python Runtime Version (for SSM aws:executeScript)",
        },
        "UseExistingVpc": {
          "default": "Use Existing VPC",
        },
        "VpcCidr": {
          "default": "VPC CIDR Block",
        },
      },
    },
  },
  "Outputs": {
    "DeploySolutionDocumentOutput": {
      "Description": "SSM Document name that will be used to trigger automation for LZA engine using container",
      "Value": {
        "Ref": "DeploySolutionDocument",
      },
    },
  },
  "Parameters": {
    "AcceleratorPrefix": {
      "AllowedPattern": "[A-Za-z0-9-]+",
      "Default": "AWSAccelerator",
      "Description": "The prefix value for accelerator deployed resources. Leave the default value if using solution defined resource name prefix, the solution will use AWSAccelerator as resource name prefix. Note: Updating this value after initial installation will cause stack failure. Non-default value can not start with keyword "aws" or "ssm". Trailing dash (-) in non-default value will be ignored.",
      "MaxLength": 15,
      "Type": "String",
    },
    "AuditAccountEmail": {
      "AllowedPattern": "[^\\s@]+@[^\\s@]+\\.[^\\s@]+",
      "ConstraintDescription": "Must be a valid email address matching "[^\\s@]+@[^\\s@]+\\.[^\\s@]+"",
      "Description": "The security audit account (also referred to as the audit account)",
      "Type": "String",
    },
    "ControlTowerEnabled": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "Yes",
      "Description": "Select yes if deploying to a Control Tower environment.  Select no if using just Organizations. If no, you must first set up mandatory accounts.",
      "Type": "String",
    },
    "EcrUri": {
      "Description": "The Amazon Elastic Container Registry (Amazon ECR) repository, where Landing Zone Accelerator on AWS code is present.",
      "Type": "String",
    },
    "ExistingConfigBucketKey": {
      "Default": "",
      "Description": "Specify the branch name of the existing LZA configuration bucket key to pull the accelerator configuration from.",
      "Type": "String",
    },
    "ExistingConfigBucketName": {
      "Default": "",
      "Description": "The name of an existing LZA configuration bucket hosting the accelerator configuration.",
      "Type": "String",
    },
    "ExistingSecurityGroupId": {
      "Default": "",
      "Description": "The ID of an existing security group (required when UseExistingVpc is Yes)",
      "Type": "String",
    },
    "ExistingSubnetId": {
      "Default": "",
      "Description": "The ID of an existing subnet (required when UseExistingVpc is Yes)",
      "Type": "String",
    },
    "ExistingVpcId": {
      "Default": "",
      "Description": "The ID of an existing VPC (required when UseExistingVpc is Yes)",
      "Type": "String",
    },
    "LogArchiveAccountEmail": {
      "AllowedPattern": "[^\\s@]+@[^\\s@]+\\.[^\\s@]+",
      "ConstraintDescription": "Must be a valid email address matching "[^\\s@]+@[^\\s@]+\\.[^\\s@]+"",
      "Description": "The log archive account email",
      "Type": "String",
    },
    "LogLevel": {
      "AllowedValues": [
        "error",
        "info",
        "debug",
      ],
      "Default": "error",
      "Description": "The log level for LZA engine. Controls the verbosity of logs generated during deployment.",
      "Type": "String",
    },
    "ManagementAccountEmail": {
      "AllowedPattern": "[^\\s@]+@[^\\s@]+\\.[^\\s@]+",
      "ConstraintDescription": "Must be a valid email address matching "[^\\s@]+@[^\\s@]+\\.[^\\s@]+"",
      "Description": "The management (primary) account email - NOTE: This must match the address of the management account email as listed in AWS Organizations > AWS accounts.",
      "Type": "String",
    },
    "PermissionBoundaryPolicyName": {
      "Description": "Permission boundary Policy Name which is valid only for management account",
      "Type": "String",
    },
    "PythonRuntimeVersion": {
      "Default": "python3.11",
      "Description": "The Python runtime version for SSM Document aws:executeScript actions. Must match SSM supported runtimes (e.g., python3.8, python3.9, python3.10, python3.11).",
      "Type": "String",
    },
    "UseExistingConfig": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Select Yes if deploying the solution with an existing configuration. Leave the default value if using the solution-deployed bucket. If the AcceleratorPrefix parameter is set to the default value, the solution will deploy a bucket named "aws-accelerator-config-$account-$region." Otherwise, the solution-deployed bucket will be named "AcceleratorPrefix-config-$account-$region." Note: Updating this value after initial installation may cause adverse affects.",
      "Type": "String",
    },
    "UseExistingVpc": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Select Yes to use an existing VPC. If Yes, provide existing subnet and security group IDs.",
      "Type": "String",
    },
    "VpcCidr": {
      "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$",
      "Default": "10.0.0.0/16",
      "Description": "The CIDR block for the VPC (used when UseExistingVpc is No)",
      "Type": "String",
    },
  },
  "Resources": {
    "AcceleratorManagementKmsArnParameter1E6975BF": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/installer/kms/key-arn",
            ],
          ],
        },
        "Type": "String",
        "Value": {
          "Fn::GetAtt": [
            "InstallerKey2A6A8C6D",
            "Arn",
          ],
        },
      },
      "Type": "AWS::SSM::Parameter",
    },
    "ConfigBucket": {
      "Condition": "CreateConfigCondition",
      "DeletionPolicy": "Retain",
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "KMSMasterKeyID": {
                  "Fn::GetAtt": [
                    "InstallerKey2A6A8C6D",
                    "Arn",
                  ],
                },
                "SSEAlgorithm": "aws:kms",
              },
            },
          ],
        },
        "BucketName": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-config-",
              {
                "Ref": "AWS::AccountId",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
            ],
          ],
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "AbortIncompleteMultipartUpload": {
                "DaysAfterInitiation": 1,
              },
              "ExpirationInDays": 1825,
              "ExpiredObjectDeleteMarker": false,
              "Id": {
                "Fn::Join": [
                  "",
                  [
                    "LifecycleRule",
                    {
                      "Fn::GetAtt": [
                        "ResourceNamePrefixesGetPrefixResource96A10E6E",
                        "lowerCasePrefix",
                      ],
                    },
                    "-config-",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    "-",
                    {
                      "Ref": "AWS::Region",
                    },
                  ],
                ],
              },
              "NoncurrentVersionExpiration": {
                "NoncurrentDays": 1825,
              },
              "NoncurrentVersionTransitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 366,
                },
              ],
              "Status": "Enabled",
              "Transitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 365,
                },
              ],
            },
          ],
        },
        "LoggingConfiguration": {
          "DestinationBucketName": {
            "Ref": "InstallerAccessLogsBucket647700E9",
          },
          "LogFilePrefix": {
            "Fn::Join": [
              "",
              [
                {
                  "Fn::GetAtt": [
                    "ResourceNamePrefixesGetPrefixResource96A10E6E",
                    "lowerCasePrefix",
                  ],
                },
                "-config-",
                {
                  "Ref": "AWS::AccountId",
                },
                "-",
                {
                  "Ref": "AWS::Region",
                },
                "/",
              ],
            ],
          },
        },
        "OwnershipControls": {
          "Rules": [
            {
              "ObjectOwnership": "BucketOwnerPreferred",
            },
          ],
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true,
        },
        "VersioningConfiguration": {
          "Status": "Enabled",
        },
      },
      "Type": "AWS::S3::Bucket",
      "UpdateReplacePolicy": "Retain",
    },
    "ConfigBucketPolicy": {
      "Condition": "CreateConfigCondition",
      "Properties": {
        "Bucket": {
          "Ref": "ConfigBucket",
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:*",
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false",
                },
              },
              "Effect": "Deny",
              "Principal": {
                "AWS": "*",
              },
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "ConfigBucket",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "ConfigBucket",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
              "Sid": "deny-insecure-connections",
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::S3::BucketPolicy",
    },
    "DeploySolutionDocument": {
      "Properties": {
        "Content": {
          "assumeRole": "{{AutomationAssumeRole}}",
          "description": "Automation document to deploy Landing Zone Accelerator on AWS (LZA) solution by running ECS Fargate tasks in a private subnet",
          "mainSteps": [
            {
              "action": "aws:executeScript",
              "description": "Starts a new ECS task and returns task details with CloudWatch log URL",
              "inputs": {
                "Handler": "handler",
                "InputPayload": {
                  "Cluster": "{{Cluster}}",
                  "LogGroupName": {
                    "Ref": "LogGroup",
                  },
                  "Region": {
                    "Ref": "AWS::Region",
                  },
                  "SecurityGroupId": "{{SecurityGroupId}}",
                  "SolutionId": "AwsSolution/SO0199/1.15.0",
                  "SubnetId": "{{SubnetId}}",
                  "TaskDefinition": "{{TaskDefinition}}",
                },
                "Runtime": "{{PythonRuntime}}",
                "Script": "REPLACED-JSON-PATH.json",
              },
              "name": "RunTask",
              "outputs": [
                {
                  "Name": "ClusterName",
                  "Selector": "$.Payload.ClusterName",
                  "Type": "String",
                },
                {
                  "Name": "TaskArn",
                  "Selector": "$.Payload.TaskArn",
                  "Type": "String",
                },
                {
                  "Name": "LogGroupName",
                  "Selector": "$.Payload.LogGroupName",
                  "Type": "String",
                },
                {
                  "Name": "LogStreamName",
                  "Selector": "$.Payload.LogStreamName",
                  "Type": "String",
                },
              ],
              "timeoutSeconds": 600,
            },
            {
              "action": "aws:waitForAwsResourceProperty",
              "description": "Wait for ECS task to complete",
              "inputs": {
                "Api": "DescribeTasks",
                "DesiredValues": [
                  "STOPPED",
                ],
                "PropertySelector": "$.tasks[0].lastStatus",
                "Service": "ecs",
                "cluster": "{{RunTask.ClusterName}}",
                "tasks": [
                  "{{RunTask.TaskArn}}",
                ],
              },
              "name": "WaitForTaskCompletion",
              "outputs": [
                {
                  "Name": "TaskStatus",
                  "Selector": "$.tasks[0].lastStatus",
                  "Type": "String",
                },
              ],
              "timeoutSeconds": 43200,
            },
            {
              "action": "aws:executeScript",
              "description": "Verifies the container exit code after task completion and fails the automation if exit code is non-zero",
              "inputs": {
                "Handler": "handler",
                "InputPayload": {
                  "ClusterName": "{{RunTask.ClusterName}}",
                  "LogGroupName": "{{RunTask.LogGroupName}}",
                  "LogStreamName": "{{RunTask.LogStreamName}}",
                  "Region": {
                    "Ref": "AWS::Region",
                  },
                  "SolutionId": "AwsSolution/SO0199/1.15.0",
                  "TaskArn": "{{RunTask.TaskArn}}",
                },
                "Runtime": "{{PythonRuntime}}",
                "Script": "import boto3
from botocore.config import Config

def handler(event, context):
    config = Config(user_agent_extra=event['SolutionId']) 
    client = boto3.client('ecs', region_name=event['Region'], config=config)
    
    response = client.describe_tasks(
        cluster=event['ClusterName'],
        tasks=[event['TaskArn']]
    )
    
    if not response['tasks']:
        raise Exception(f"Task not found: {event['TaskArn']}")
    
    task = response['tasks'][0]
    containers = task.get('containers', [])
    
    if not containers:
        raise Exception(f"No containers found in task: {event['TaskArn']}")
    
    # Extract exit code from tasks[0].containers[0].exitCode
    container = containers[0]
    exit_code = container.get('exitCode')  # Can be 0, 1, 137, etc. or None if killed
    
    # Extract task-level stop information
    stop_code = task.get('stopCode', 'Unknown')  # e.g., "EssentialContainerExited"
    stop_reason = task.get('stoppedReason', 'Unknown')  # e.g., "Essential container in task exited"
    task_status = task.get('lastStatus', 'Unknown')
    
    result = {
        'ExitCode': exit_code if exit_code is not None else -1,
        'StopCode': stop_code,
        'StopReason': stop_reason,
        'TaskStatus': task_status,
        'LogStreamName': event['LogStreamName'],
        'LogGroupName': event['LogGroupName']
    }
    
    # Fail if exit code is non-zero or None (container was killed)
    if exit_code is None or exit_code != 0:
        error_msg = (
            f"ECS task failed with exit code {exit_code}. "
            f"Stop code: {stop_code}. "
            f"Stop reason: {stop_reason}. "
            f"Check CloudWatch logs: {event['LogGroupName']}/{event['LogStreamName']}"
        )
        raise Exception(error_msg)
    
    return result",
              },
              "name": "CheckTaskExitCode",
              "outputs": [
                {
                  "Name": "ExitCode",
                  "Selector": "$.Payload.ExitCode",
                  "Type": "Integer",
                },
                {
                  "Name": "StopCode",
                  "Selector": "$.Payload.StopCode",
                  "Type": "String",
                },
                {
                  "Name": "StopReason",
                  "Selector": "$.Payload.StopReason",
                  "Type": "String",
                },
                {
                  "Name": "TaskStatus",
                  "Selector": "$.Payload.TaskStatus",
                  "Type": "String",
                },
              ],
              "timeoutSeconds": 600,
            },
          ],
          "outputs": [
            "RunTask.TaskArn",
            "RunTask.ClusterName",
            "RunTask.LogGroupName",
            "RunTask.LogStreamName",
            "WaitForTaskCompletion.TaskStatus",
            "CheckTaskExitCode.ExitCode",
            "CheckTaskExitCode.StopCode",
            "CheckTaskExitCode.StopReason",
          ],
          "parameters": {
            "AutomationAssumeRole": {
              "default": {
                "Fn::GetAtt": [
                  "SsmAutomationRole",
                  "Arn",
                ],
              },
              "description": "The ARN of the IAM role that allows Systems Manager Automation to perform actions",
              "type": "String",
            },
            "Cluster": {
              "default": {
                "Ref": "EcsCluster",
              },
              "description": "The short name or full ARN of the cluster to run your task on",
              "type": "String",
            },
            "PythonRuntime": {
              "default": {
                "Ref": "PythonRuntimeVersion",
              },
              "description": "The Python runtime version for aws:executeScript actions",
              "type": "String",
            },
            "SecurityGroupId": {
              "default": {
                "Fn::If": [
                  "CreateVpcCondition",
                  {
                    "Ref": "SecurityGroup",
                  },
                  {
                    "Ref": "ExistingSecurityGroupId",
                  },
                ],
              },
              "description": "The security group used by the ECS task",
              "type": "String",
            },
            "SubnetId": {
              "default": {
                "Fn::If": [
                  "CreateVpcCondition",
                  {
                    "Ref": "PrivateSubnet0",
                  },
                  {
                    "Ref": "ExistingSubnetId",
                  },
                ],
              },
              "description": "The subnet where the ECS task will be placed",
              "type": "String",
            },
            "TaskDefinition": {
              "default": {
                "Ref": "TaskDefinition",
              },
              "description": "The family and revision or full ARN of the task definition to run",
              "type": "String",
            },
          },
          "schemaVersion": "0.3",
        },
        "DocumentType": "Automation",
        "Name": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "acceleratorPrefix",
                ],
              },
              "-RunEngine",
            ],
          ],
        },
        "UpdateMethod": "NewVersion",
      },
      "Type": "AWS::SSM::Document",
    },
    "EcsCluster": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-ECS4",
              "reason": "The ECS Cluster has CloudWatch Container Insights are not present in all partitions.",
            },
            {
              "id": "AwsSolutions-ECS7",
              "reason": "The ECS task definition used has logging enabled to CloudWatch logs.",
            },
          ],
        },
      },
      "Properties": {
        "ClusterName": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-ecs-cluster",
            ],
          ],
        },
      },
      "Type": "AWS::ECS::Cluster",
    },
    "EcsExecutionRole": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "The ECS task needs admin access to orchestrate the engine.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/AdministratorAccess",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "EcsTaskRole": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "The ECS task needs admin access to orchestrate LZA deployment and manage AWS resources.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/AdministratorAccess",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "InstallerAccessLogsBucket647700E9": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-S1",
              "reason": "AccessLogsBucket has server access logs disabled till the task for access logging completed.",
            },
          ],
        },
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W35",
              "reason": "This is an access logging bucket.",
            },
          ],
        },
      },
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256",
              },
            },
          ],
        },
        "BucketName": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-s3-logs-",
              {
                "Ref": "AWS::AccountId",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
            ],
          ],
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "AbortIncompleteMultipartUpload": {
                "DaysAfterInitiation": 1,
              },
              "ExpirationInDays": 1825,
              "ExpiredObjectDeleteMarker": false,
              "Id": {
                "Fn::Join": [
                  "",
                  [
                    "LifecycleRule",
                    {
                      "Fn::GetAtt": [
                        "ResourceNamePrefixesGetPrefixResource96A10E6E",
                        "lowerCasePrefix",
                      ],
                    },
                    "-s3-logs-",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    "-",
                    {
                      "Ref": "AWS::Region",
                    },
                  ],
                ],
              },
              "NoncurrentVersionExpiration": {
                "NoncurrentDays": 1825,
              },
              "NoncurrentVersionTransitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 366,
                },
              ],
              "Status": "Enabled",
              "Transitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 365,
                },
              ],
            },
          ],
        },
        "OwnershipControls": {
          "Rules": [
            {
              "ObjectOwnership": "BucketOwnerPreferred",
            },
          ],
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true,
        },
        "VersioningConfiguration": {
          "Status": "Enabled",
        },
      },
      "Type": "AWS::S3::Bucket",
      "UpdateReplacePolicy": "Retain",
    },
    "InstallerAccessLogsBucketName4F700F48": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/installer-access-logs-bucket-name",
            ],
          ],
        },
        "Type": "String",
        "Value": {
          "Ref": "InstallerAccessLogsBucket647700E9",
        },
      },
      "Type": "AWS::SSM::Parameter",
    },
    "InstallerAccessLogsBucketPolicy20D4E285": {
      "Properties": {
        "Bucket": {
          "Ref": "InstallerAccessLogsBucket647700E9",
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:*",
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false",
                },
              },
              "Effect": "Deny",
              "Principal": {
                "AWS": "*",
              },
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "InstallerAccessLogsBucket647700E9",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "InstallerAccessLogsBucket647700E9",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
              "Sid": "deny-insecure-connections",
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::S3::BucketPolicy",
    },
    "InstallerKey2A6A8C6D": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "F76",
              "reason": "KMS key using * principal with added arn condition",
            },
          ],
        },
      },
      "Properties": {
        "Description": "KMS key for encrypting LZA installer S3 configuration bucket in the management account",
        "EnableKeyRotation": true,
        "KeyPolicy": {
          "Statement": [
            {
              "Action": "kms:*",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":iam::",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":root",
                    ],
                  ],
                },
              },
              "Resource": "*",
            },
            {
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ],
              "Condition": {
                "ArnLike": {
                  "aws:PrincipalARN": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":iam::",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":role/",
                        {
                          "Fn::GetAtt": [
                            "ResourceNamePrefixesGetPrefixResource96A10E6E",
                            "acceleratorPrefix",
                          ],
                        },
                        "-*",
                      ],
                    ],
                  },
                },
              },
              "Effect": "Allow",
              "Principal": {
                "AWS": "*",
              },
              "Resource": "*",
              "Sid": "Allow Accelerator Role to use the encryption key",
            },
            {
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": "sns.amazonaws.com",
              },
              "Resource": "*",
              "Sid": "Allow SNS service to use the encryption key",
            },
            {
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ],
              "Condition": {
                "ArnLike": {
                  "kms:EncryptionContext:aws:logs:arn": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":logs:",
                        {
                          "Ref": "AWS::Region",
                        },
                        ":",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":log-group:*",
                      ],
                    ],
                  },
                },
              },
              "Effect": "Allow",
              "Principal": {
                "Service": {
                  "Fn::Join": [
                    "",
                    [
                      "logs.",
                      {
                        "Ref": "AWS::Region",
                      },
                      ".amazonaws.com",
                    ],
                  ],
                },
              },
              "Resource": "*",
              "Sid": "Allow Cloudwatch Logs service to use the encryption key",
            },
          ],
        },
      },
      "Type": "AWS::KMS::Key",
      "UpdateReplacePolicy": "Retain",
    },
    "InstallerKeyAliasD5C174F0": {
      "Properties": {
        "AliasName": {
          "Fn::Join": [
            "",
            [
              "alias/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/installer/kms/key",
            ],
          ],
        },
        "TargetKeyId": {
          "Fn::GetAtt": [
            "InstallerKey2A6A8C6D",
            "Arn",
          ],
        },
      },
      "Type": "AWS::KMS::Alias",
    },
    "InternetGateway": {
      "Condition": "CreateVpcCondition",
      "Type": "AWS::EC2::InternetGateway",
    },
    "LogGroup": {
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/ecs/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-lza-deployment",
            ],
          ],
        },
        "RetentionInDays": 365,
      },
      "Type": "AWS::Logs::LogGroup",
    },
    "NatEip0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "Domain": "vpc",
      },
      "Type": "AWS::EC2::EIP",
    },
    "NatEip1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "Domain": "vpc",
      },
      "Type": "AWS::EC2::EIP",
    },
    "NatGateway0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "NatEip0",
            "AllocationId",
          ],
        },
        "SubnetId": {
          "Ref": "PublicSubnet0",
        },
      },
      "Type": "AWS::EC2::NatGateway",
    },
    "NatGateway1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "NatEip1",
            "AllocationId",
          ],
        },
        "SubnetId": {
          "Ref": "PublicSubnet1",
        },
      },
      "Type": "AWS::EC2::NatGateway",
    },
    "PrivateRoute0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "NatGateway0",
        },
        "RouteTableId": {
          "Ref": "PrivateRouteTable0",
        },
      },
      "Type": "AWS::EC2::Route",
    },
    "PrivateRoute1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "NatGateway1",
        },
        "RouteTableId": {
          "Ref": "PrivateRouteTable1",
        },
      },
      "Type": "AWS::EC2::Route",
    },
    "PrivateRouteTable0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::RouteTable",
    },
    "PrivateRouteTable1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::RouteTable",
    },
    "PrivateSubnet0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            0,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.10.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PrivateSubnet1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            1,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.11.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PrivateSubnetRouteTableAssociation0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PrivateRouteTable0",
        },
        "SubnetId": {
          "Ref": "PrivateSubnet0",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "PrivateSubnetRouteTableAssociation1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PrivateRouteTable1",
        },
        "SubnetId": {
          "Ref": "PrivateSubnet1",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "PublicRoute": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "InternetGateway",
        },
        "RouteTableId": {
          "Ref": "PublicRouteTable",
        },
      },
      "Type": "AWS::EC2::Route",
    },
    "PublicRouteTable": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::RouteTable",
    },
    "PublicSubnet0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            0,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.0.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PublicSubnet1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            1,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.1.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PublicSubnetRouteTableAssociation0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PublicRouteTable",
        },
        "SubnetId": {
          "Ref": "PublicSubnet0",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "PublicSubnetRouteTableAssociation1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PublicRouteTable",
        },
        "SubnetId": {
          "Ref": "PublicSubnet1",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "ResourceNamePrefixesGetPrefixResource96A10E6E": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "ResourceNamePrefixesResourceNamePrefixesFunction138C66F1",
            "Arn",
          ],
        },
        "pipelineStackVersionSsmParamName": {
          "Fn::Join": [
            "",
            [
              "/accelerator/AWSAccelerator-PipelineStack-",
              {
                "Ref": "AWS::AccountId",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
              "/version",
            ],
          ],
        },
        "prefix": {
          "Ref": "AcceleratorPrefix",
        },
        "prefixParameterName": "/accelerator/lza-prefix",
      },
      "Type": "Custom::GetPrefixes",
      "UpdateReplacePolicy": "Delete",
    },
    "ResourceNamePrefixesResourceNamePrefixesFunction138C66F1": {
      "DependsOn": [
        "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRoleDefaultPolicyDC1CC159",
        "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2",
      ],
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "Needed to write to CWL group",
            },
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Needed to create SSM parameter for prefix",
            },
          ],
        },
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W58",
              "reason": "CloudWatch Logs are enabled in AWSLambdaBasicExecutionRole",
            },
            {
              "id": "W89",
              "reason": "This function supports infrastructure deployment and is not deployed inside a VPC.",
            },
            {
              "id": "W92",
              "reason": "This function supports infrastructure deployment and does not require setting ReservedConcurrentExecutions.",
            },
          ],
        },
      },
      "Properties": {
        "Code": {
          "ZipFile": "
          const response = require('cfn-response'); 
          const { SSMClient, DeleteParameterCommand, GetParameterCommand, ParameterNotFound, PutParameterCommand } = require("@aws-sdk/client-ssm");
          const { ConfiguredRetryStrategy } = require("@aws-sdk/util-retry");
          exports.handler = async function (event, context) { 
          console.log(JSON.stringify(event, null, 4)); 
          const prefix=event.ResourceProperties.prefix;
          const pipelineStackVersionSsmParamName=event.ResourceProperties.pipelineStackVersionSsmParamName;
          const lowerCasePrefix=prefix.toLowerCase();
          
          const ssm = new SSMClient({retryStrategy: new ConfiguredRetryStrategy(10, (attempt) => 100 + attempt * 1000)});
          
          let data = {};
          
          let paramName = event.ResourceProperties.prefixParameterName;
          
          if (lowerCasePrefix === 'awsaccelerator') {
              data['acceleratorPrefix'] = 'AWSAccelerator';
              data['lowerCasePrefix'] = 'aws-accelerator'; 
              data['oneWordPrefix'] = 'accelerator';               
          } else {
              data['acceleratorPrefix'] = prefix;
              data['lowerCasePrefix'] = lowerCasePrefix; 
              data['oneWordPrefix'] = prefix; 
          }
                  

          if (event.RequestType === 'Update'){

              var params = {
                Name: paramName,
              };
              try {
                  const ssmResponse = await ssm.send(new GetParameterCommand(params));
                  // Fail stack if prefix was changed during update
                  if (ssmResponse.Parameter.Value !== prefix) {
                      await response.send(event, context, response.FAILED, {'FailureReason': 'LZA does not allow changing AcceleratorPrefix parameter value after initial deploy !!! Existing prefix: ' + event.OldResourceProperties.prefix + ' New prefix: ' + prefix + '.' }, event.PhysicalResourceId);
                      return;
                  }
                  await response.send(event, context, response.SUCCESS, data, event.PhysicalResourceId);
              } catch (error) {
                  console.log(error);
                  if (error instanceof ParameterNotFound){
                      await response.send(event, context, response.FAILED, {'FailureReason': 'LZA prefix ssm parameter ' + paramName + ' not found!!! Recreate the parameter with existing AcceleratorPrefix parameter value to fix the issue'}, event.PhysicalResourceId);
                      return;
                  }
                  else {
                      await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while accessing LZA prefix ssm parameter ' + paramName }, event.PhysicalResourceId);
                      return;
                  }
              }          
          } 
          
          if (event.RequestType === 'Create') {
          
              if (lowerCasePrefix !== 'awsaccelerator') {
                  // Fail stack if prefix starts with aws or ssm
                  if (lowerCasePrefix.startsWith('aws') || lowerCasePrefix.startsWith('ssm')) { 
                      await response.send(event, context, response.FAILED, {'FailureReason': 'Accelerator prefix ' + prefix + ' can not be started with aws or ssm !!!'}, event.PhysicalResourceId);
                      return;
                  }

                  // Check if this is an existing deployment and prefix changed with initial deployment of custom resource
                  var versionParams = {
                    Name: pipelineStackVersionSsmParamName,
                  };
                  try {
                    await ssm.send(new GetParameterCommand(versionParams));
                    await response.send(event, context, response.FAILED, {'FailureReason': 'Can not change AcceleratorPrefix parameter for existing deployment, existing prefix value is AWSAccelerator, keep AcceleratorPrefix parameter value to default value for successfully stack update !!!'}, event.PhysicalResourceId);
                    return;
                  }
                  catch (error) {
                    console.log(error);
                    if (!(error instanceof ParameterNotFound)){
                      await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while accessing LZA ssm parameter ' + pipelineStackVersionSsmParamName }, event.PhysicalResourceId);
                      return;
                    }
                  }
              }
          
              // Create /accelerator/lza-prefix SSM parameter to store prefix value to protect updating prefix
              try {
                  var newParams = {
                        Name: paramName,
                        Value: prefix,
                        Description: 'LZA created SSM parameter for Accelerator prefix value, DO NOT MODIFY/DELETE this parameter',
                        Type: 'String',
                      };
                  await ssm.send(new PutParameterCommand(newParams));
                  await response.send(event, context, response.SUCCESS, data, event.PhysicalResourceId);
              }
              catch (error) {
                  console.log(error);
                  await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while creating LZA prefix ssm parameter ' + paramName }, event.PhysicalResourceId);
                  return;
              }
          }
          if (event.RequestType === 'Delete') {

            var deleteParams = {
              Name: paramName,
            };
            try {
              await ssm.send(new DeleteParameterCommand(deleteParams));
            }
            catch (error) {
              console.log(error);
              if (!(error instanceof ParameterNotFound)){
                await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while deleting LZA ssm parameter ' + paramName }, event.PhysicalResourceId);
                return;
              }
            }
            await response.send(event, context, response.SUCCESS, {'Status': 'Custom resource deleted successfully' }, event.PhysicalResourceId);
          }
          
          return;
      }",
        },
        "Description": "This function converts accelerator prefix parameter to lower case to name s3 buckets in installer stack",
        "Handler": "index.handler",
        "Role": {
          "Fn::GetAtt": [
            "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2",
            "Arn",
          ],
        },
        "Runtime": "nodejs22.x",
      },
      "Type": "AWS::Lambda::Function",
    },
    "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "Needed to write to CWL group",
            },
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Needed to create SSM parameter for prefix",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRoleDefaultPolicyDC1CC159": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "Needed to write to CWL group",
            },
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Needed to create SSM parameter for prefix",
            },
          ],
        },
      },
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "ssm:GetParameters",
                "ssm:GetParameter",
                "ssm:PutParameter",
                "ssm:DeleteParameter",
              ],
              "Condition": {
                "StringEquals": {
                  "aws:PrincipalAccount": {
                    "Ref": "AWS::AccountId",
                  },
                },
              },
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":ssm:",
                      {
                        "Ref": "AWS::Region",
                      },
                      ":",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":parameter/accelerator/lza-prefix",
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":ssm:",
                      {
                        "Ref": "AWS::Region",
                      },
                      ":",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":parameter/accelerator/AWSAccelerator-PipelineStack-",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      "-",
                      {
                        "Ref": "AWS::Region",
                      },
                      "/version",
                    ],
                  ],
                },
              ],
              "Sid": "SsmReadParameterAccess",
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRoleDefaultPolicyDC1CC159",
        "Roles": [
          {
            "Ref": "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "SecurityGroup": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "GroupDescription": "Security group for VPC",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::SecurityGroup",
    },
    "SsmAutomationRole": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Wild card permissions are needed on describe and run task calls.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ssm.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "ecs:RunTask",
                    "ecs:DescribeTasks",
                  ],
                  "Effect": "Allow",
                  "Resource": "*",
                },
                {
                  "Action": [
                    "iam:PassRole",
                  ],
                  "Effect": "Allow",
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "EcsExecutionRole",
                        "Arn",
                      ],
                    },
                    {
                      "Fn::GetAtt": [
                        "EcsTaskRole",
                        "Arn",
                      ],
                    },
                  ],
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "EcsRunTaskPolicy",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "SsmParamAcceleratorVersionFF83282D": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/TestInstallerContainerStackPermBoundary/version",
            ],
          ],
        },
        "Type": "String",
        "Value": "1.15.0",
      },
      "Type": "AWS::SSM::Parameter",
    },
    "SsmParamStackId521A78D3": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/TestInstallerContainerStackPermBoundary/stack-id",
            ],
          ],
        },
        "Type": "String",
        "Value": {
          "Ref": "AWS::StackId",
        },
      },
      "Type": "AWS::SSM::Parameter",
    },
    "TaskDefinition": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-ECS2",
              "reason": "Environment variables are needed to turn off features made for services relying on CodePipeline and CodeBuild",
            },
          ],
        },
      },
      "Properties": {
        "ContainerDefinitions": [
          {
            "Command": [
              "/landing-zone-accelerator-on-aws/scripts/run-lza.sh deploy",
            ],
            "EntryPoint": [
              "sh",
              "-c",
            ],
            "Environment": [
              {
                "Name": "ENABLE_DIAGNOSTICS_PACK",
                "Value": "No",
              },
              {
                "Name": "SkipPipelinePrerequisites",
                "Value": "true",
              },
              {
                "Name": "SkipAcceleratorPrerequisites",
                "Value": "true",
              },
              {
                "Name": "AWS_REGION",
                "Value": {
                  "Ref": "AWS::Region",
                },
              },
              {
                "Name": "CONFIG_S3_PATH",
                "Value": {
                  "Fn::If": [
                    "CreateConfigCondition",
                    {
                      "Fn::Join": [
                        "",
                        [
                          "s3://",
                          {
                            "Fn::GetAtt": [
                              "ResourceNamePrefixesGetPrefixResource96A10E6E",
                              "lowerCasePrefix",
                            ],
                          },
                          "-config-",
                          {
                            "Ref": "AWS::AccountId",
                          },
                          "-",
                          {
                            "Ref": "AWS::Region",
                          },
                          "/lza/aws-accelerator-config.zip",
                        ],
                      ],
                    },
                    {
                      "Fn::Join": [
                        "",
                        [
                          "s3://",
                          {
                            "Ref": "ExistingConfigBucketName",
                          },
                          "/",
                          {
                            "Ref": "ExistingConfigBucketKey",
                          },
                        ],
                      ],
                    },
                  ],
                },
              },
              {
                "Name": "CONFIG_S3_BUCKET",
                "Value": {
                  "Fn::If": [
                    "CreateConfigCondition",
                    {
                      "Fn::Join": [
                        "",
                        [
                          {
                            "Fn::GetAtt": [
                              "ResourceNamePrefixesGetPrefixResource96A10E6E",
                              "lowerCasePrefix",
                            ],
                          },
                          "-config-",
                          {
                            "Ref": "AWS::AccountId",
                          },
                          "-",
                          {
                            "Ref": "AWS::Region",
                          },
                        ],
                      ],
                    },
                    {
                      "Ref": "ExistingConfigBucketName",
                    },
                  ],
                },
              },
              {
                "Name": "CONFIG_S3_KEY",
                "Value": {
                  "Fn::If": [
                    "CreateConfigCondition",
                    "lza/aws-accelerator-config.zip",
                    {
                      "Ref": "ExistingConfigBucketKey",
                    },
                  ],
                },
              },
              {
                "Name": "CONFIG_BUCKET_NAME",
                "Value": {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "ResourceNamePrefixesGetPrefixResource96A10E6E",
                          "lowerCasePrefix",
                        ],
                      },
                      "-config-",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      "-",
                      {
                        "Ref": "AWS::Region",
                      },
                    ],
                  ],
                },
              },
              {
                "Name": "MANAGEMENT_ACCOUNT_EMAIL",
                "Value": {
                  "Ref": "ManagementAccountEmail",
                },
              },
              {
                "Name": "LOG_ARCHIVE_ACCOUNT_EMAIL",
                "Value": {
                  "Ref": "LogArchiveAccountEmail",
                },
              },
              {
                "Name": "AUDIT_ACCOUNT_EMAIL",
                "Value": {
                  "Ref": "AuditAccountEmail",
                },
              },
              {
                "Name": "CONTROL_TOWER_ENABLED",
                "Value": {
                  "Ref": "ControlTowerEnabled",
                },
              },
              {
                "Name": "ACCELERATOR_PREFIX",
                "Value": {
                  "Fn::GetAtt": [
                    "ResourceNamePrefixesGetPrefixResource96A10E6E",
                    "acceleratorPrefix",
                  ],
                },
              },
              {
                "Name": "INSTALLER_STACK_NAME",
                "Value": {
                  "Fn::Sub": "\${AWS::StackName}",
                },
              },
              {
                "Name": "PARTITION",
                "Value": {
                  "Fn::Sub": "\${AWS::Partition}",
                },
              },
              {
                "Name": "PIPELINE_ACCOUNT_ID",
                "Value": {
                  "Ref": "AWS::AccountId",
                },
              },
              {
                "Name": "LOG_LEVEL",
                "Value": {
                  "Ref": "LogLevel",
                },
              },
              {
                "Name": "ACCELERATOR_PERMISSION_BOUNDARY",
                "Value": {
                  "Ref": "PermissionBoundaryPolicyName",
                },
              },
            ],
            "Image": {
              "Ref": "EcrUri",
            },
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-group": {
                  "Ref": "LogGroup",
                },
                "awslogs-region": {
                  "Ref": "AWS::Region",
                },
                "awslogs-stream-prefix": "ecs",
              },
            },
            "Name": "lza-deployment-container",
          },
        ],
        "Cpu": "8192",
        "ExecutionRoleArn": {
          "Fn::GetAtt": [
            "EcsExecutionRole",
            "Arn",
          ],
        },
        "Family": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-lza-deployment-task",
            ],
          ],
        },
        "Memory": "32768",
        "NetworkMode": "awsvpc",
        "RequiresCompatibilities": [
          "EC2",
          "FARGATE",
        ],
        "TaskRoleArn": {
          "Fn::GetAtt": [
            "EcsTaskRole",
            "Arn",
          ],
        },
      },
      "Type": "AWS::ECS::TaskDefinition",
    },
    "Vpc": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "CidrBlock": {
          "Ref": "VpcCidr",
        },
        "EnableDnsHostnames": true,
        "EnableDnsSupport": true,
        "InstanceTenancy": "default",
      },
      "Type": "AWS::EC2::VPC",
    },
    "VpcFlowLog": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DeliverLogsPermissionArn": {
          "Fn::GetAtt": [
            "VpcFlowLogRole",
            "Arn",
          ],
        },
        "LogDestinationType": "cloud-watch-logs",
        "LogGroupName": {
          "Ref": "VpcFlowLogGroup",
        },
        "ResourceId": {
          "Ref": "Vpc",
        },
        "ResourceType": "VPC",
        "TrafficType": "ALL",
      },
      "Type": "AWS::EC2::FlowLog",
    },
    "VpcFlowLogGroup": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/aws/vpc/flowlogs/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
            ],
          ],
        },
        "RetentionInDays": 365,
      },
      "Type": "AWS::Logs::LogGroup",
    },
    "VpcFlowLogRole": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "vpc-flow-logs.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "logs:CreateLogStream",
                    "logs:PutLogEvents",
                    "logs:DescribeLogGroups",
                    "logs:DescribeLogStreams",
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::GetAtt": [
                      "VpcFlowLogGroup",
                      "Arn",
                    ],
                  },
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "CloudWatchLogPolicy",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "VpcGatewayAttachment": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "InternetGatewayId": {
          "Ref": "InternetGateway",
        },
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::VPCGatewayAttachment",
    },
  },
  "Rules": {
    "RequiredParametersForExistingRepo": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingConfigBucketKey",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "existingConfigBucketKey parameter must be provided when useExistingConfig is set to Yes",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingConfigBucketName",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "existingConfigBucketName parameter must be provided when useExistingRepository is set to Yes",
        },
      ],
      "RuleCondition": {
        "Fn::Equals": [
          "Yes",
          {
            "Ref": "UseExistingConfig",
          },
        ],
      },
    },
    "RequiredParametersForExistingVpc": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingVpcId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ExistingVpcId parameter must be provided when UseExistingVpc is set to Yes",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingSubnetId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ExistingSubnetId parameter must be provided when UseExistingVpc is set to Yes",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingSecurityGroupId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ExistingSecurityGroupId parameter must be provided when UseExistingVpc is set to Yes",
        },
      ],
      "RuleCondition": {
        "Fn::Equals": [
          "Yes",
          {
            "Ref": "UseExistingVpc",
          },
        ],
      },
    },
    "UniqueAccountEmails": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "ManagementAccountEmail",
                  },
                  {
                    "Ref": "LogArchiveAccountEmail",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "Management Account Email and Log Archive Account Email must be different",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "ManagementAccountEmail",
                  },
                  {
                    "Ref": "AuditAccountEmail",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "Management Account Email and Audit Account Email must be different",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "LogArchiveAccountEmail",
                  },
                  {
                    "Ref": "AuditAccountEmail",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "Log Archive Account Email and Audit Account Email must be different",
        },
      ],
    },
  },
}
`;

exports[`InstallerContainerStack > Construct(InstallerContainerStack): With S3 Source Snapshot Test 1`] = `
{
  "Conditions": {
    "CreateConfigCondition": {
      "Fn::Equals": [
        "No",
        {
          "Ref": "UseExistingConfig",
        },
      ],
    },
    "CreateVpcCondition": {
      "Fn::Equals": [
        "No",
        {
          "Ref": "UseExistingVpc",
        },
      ],
    },
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "Source Configuration",
          },
          "Parameters": [
            "EcrUri",
          ],
        },
        {
          "Label": {
            "default": "Mandatory Accounts Configuration",
          },
          "Parameters": [
            "ManagementAccountEmail",
            "LogArchiveAccountEmail",
            "AuditAccountEmail",
          ],
        },
        {
          "Label": {
            "default": "Environment Configuration",
          },
          "Parameters": [
            "ControlTowerEnabled",
            "AcceleratorPrefix",
            "PythonRuntimeVersion",
            "LogLevel",
          ],
        },
        {
          "Label": {
            "default": "Config Bucket Configuration",
          },
          "Parameters": [
            "UseExistingConfig",
            "ExistingConfigBucketName",
            "ExistingConfigBucketKey",
          ],
        },
        {
          "Label": {
            "default": "Network Configuration",
          },
          "Parameters": [
            "VpcCidr",
            "UseExistingVpc",
            "ExistingVpcId",
            "ExistingSubnetId",
            "ExistingSecurityGroupId",
          ],
        },
      ],
      "ParameterLabels": {
        "AcceleratorPrefix": {
          "default": "Accelerator Resource name prefix",
        },
        "AuditAccountEmail": {
          "default": "Audit Account Email",
        },
        "ControlTowerEnabled": {
          "default": "Control Tower Environment",
        },
        "EcrUri": {
          "default": "ECR URI",
        },
        "ExistingSecurityGroupId": {
          "default": "Existing Security Group ID",
        },
        "ExistingSubnetId": {
          "default": "Existing Subnet ID",
        },
        "ExistingVpcId": {
          "default": "Existing VPC ID",
        },
        "LogArchiveAccountEmail": {
          "default": "Log Archive Account Email",
        },
        "LogLevel": {
          "default": "Log Level",
        },
        "ManagementAccountEmail": {
          "default": "Management Account Email",
        },
        "PythonRuntimeVersion": {
          "default": "Python Runtime Version (for SSM aws:executeScript)",
        },
        "UseExistingVpc": {
          "default": "Use Existing VPC",
        },
        "VpcCidr": {
          "default": "VPC CIDR Block",
        },
      },
    },
  },
  "Outputs": {
    "DeploySolutionDocumentOutput": {
      "Description": "SSM Document name that will be used to trigger automation for LZA engine using container",
      "Value": {
        "Ref": "DeploySolutionDocument",
      },
    },
  },
  "Parameters": {
    "AcceleratorPrefix": {
      "AllowedPattern": "[A-Za-z0-9-]+",
      "Default": "AWSAccelerator",
      "Description": "The prefix value for accelerator deployed resources. Leave the default value if using solution defined resource name prefix, the solution will use AWSAccelerator as resource name prefix. Note: Updating this value after initial installation will cause stack failure. Non-default value can not start with keyword "aws" or "ssm". Trailing dash (-) in non-default value will be ignored.",
      "MaxLength": 15,
      "Type": "String",
    },
    "AuditAccountEmail": {
      "AllowedPattern": "[^\\s@]+@[^\\s@]+\\.[^\\s@]+",
      "ConstraintDescription": "Must be a valid email address matching "[^\\s@]+@[^\\s@]+\\.[^\\s@]+"",
      "Description": "The security audit account (also referred to as the audit account)",
      "Type": "String",
    },
    "ControlTowerEnabled": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "Yes",
      "Description": "Select yes if deploying to a Control Tower environment.  Select no if using just Organizations. If no, you must first set up mandatory accounts.",
      "Type": "String",
    },
    "EcrUri": {
      "Description": "The Amazon Elastic Container Registry (Amazon ECR) repository, where Landing Zone Accelerator on AWS code is present.",
      "Type": "String",
    },
    "ExistingConfigBucketKey": {
      "Default": "",
      "Description": "Specify the branch name of the existing LZA configuration bucket key to pull the accelerator configuration from.",
      "Type": "String",
    },
    "ExistingConfigBucketName": {
      "Default": "",
      "Description": "The name of an existing LZA configuration bucket hosting the accelerator configuration.",
      "Type": "String",
    },
    "ExistingSecurityGroupId": {
      "Default": "",
      "Description": "The ID of an existing security group (required when UseExistingVpc is Yes)",
      "Type": "String",
    },
    "ExistingSubnetId": {
      "Default": "",
      "Description": "The ID of an existing subnet (required when UseExistingVpc is Yes)",
      "Type": "String",
    },
    "ExistingVpcId": {
      "Default": "",
      "Description": "The ID of an existing VPC (required when UseExistingVpc is Yes)",
      "Type": "String",
    },
    "LogArchiveAccountEmail": {
      "AllowedPattern": "[^\\s@]+@[^\\s@]+\\.[^\\s@]+",
      "ConstraintDescription": "Must be a valid email address matching "[^\\s@]+@[^\\s@]+\\.[^\\s@]+"",
      "Description": "The log archive account email",
      "Type": "String",
    },
    "LogLevel": {
      "AllowedValues": [
        "error",
        "info",
        "debug",
      ],
      "Default": "error",
      "Description": "The log level for LZA engine. Controls the verbosity of logs generated during deployment.",
      "Type": "String",
    },
    "ManagementAccountEmail": {
      "AllowedPattern": "[^\\s@]+@[^\\s@]+\\.[^\\s@]+",
      "ConstraintDescription": "Must be a valid email address matching "[^\\s@]+@[^\\s@]+\\.[^\\s@]+"",
      "Description": "The management (primary) account email - NOTE: This must match the address of the management account email as listed in AWS Organizations > AWS accounts.",
      "Type": "String",
    },
    "PythonRuntimeVersion": {
      "Default": "python3.11",
      "Description": "The Python runtime version for SSM Document aws:executeScript actions. Must match SSM supported runtimes (e.g., python3.8, python3.9, python3.10, python3.11).",
      "Type": "String",
    },
    "UseExistingConfig": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Select Yes if deploying the solution with an existing configuration. Leave the default value if using the solution-deployed bucket. If the AcceleratorPrefix parameter is set to the default value, the solution will deploy a bucket named "aws-accelerator-config-$account-$region." Otherwise, the solution-deployed bucket will be named "AcceleratorPrefix-config-$account-$region." Note: Updating this value after initial installation may cause adverse affects.",
      "Type": "String",
    },
    "UseExistingVpc": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Select Yes to use an existing VPC. If Yes, provide existing subnet and security group IDs.",
      "Type": "String",
    },
    "VpcCidr": {
      "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$",
      "Default": "10.0.0.0/16",
      "Description": "The CIDR block for the VPC (used when UseExistingVpc is No)",
      "Type": "String",
    },
  },
  "Resources": {
    "AcceleratorManagementKmsArnParameter1E6975BF": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/installer/kms/key-arn",
            ],
          ],
        },
        "Type": "String",
        "Value": {
          "Fn::GetAtt": [
            "InstallerKey2A6A8C6D",
            "Arn",
          ],
        },
      },
      "Type": "AWS::SSM::Parameter",
    },
    "ConfigBucket": {
      "Condition": "CreateConfigCondition",
      "DeletionPolicy": "Retain",
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "KMSMasterKeyID": {
                  "Fn::GetAtt": [
                    "InstallerKey2A6A8C6D",
                    "Arn",
                  ],
                },
                "SSEAlgorithm": "aws:kms",
              },
            },
          ],
        },
        "BucketName": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-config-",
              {
                "Ref": "AWS::AccountId",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
            ],
          ],
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "AbortIncompleteMultipartUpload": {
                "DaysAfterInitiation": 1,
              },
              "ExpirationInDays": 1825,
              "ExpiredObjectDeleteMarker": false,
              "Id": {
                "Fn::Join": [
                  "",
                  [
                    "LifecycleRule",
                    {
                      "Fn::GetAtt": [
                        "ResourceNamePrefixesGetPrefixResource96A10E6E",
                        "lowerCasePrefix",
                      ],
                    },
                    "-config-",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    "-",
                    {
                      "Ref": "AWS::Region",
                    },
                  ],
                ],
              },
              "NoncurrentVersionExpiration": {
                "NoncurrentDays": 1825,
              },
              "NoncurrentVersionTransitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 366,
                },
              ],
              "Status": "Enabled",
              "Transitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 365,
                },
              ],
            },
          ],
        },
        "LoggingConfiguration": {
          "DestinationBucketName": {
            "Ref": "InstallerAccessLogsBucket647700E9",
          },
          "LogFilePrefix": {
            "Fn::Join": [
              "",
              [
                {
                  "Fn::GetAtt": [
                    "ResourceNamePrefixesGetPrefixResource96A10E6E",
                    "lowerCasePrefix",
                  ],
                },
                "-config-",
                {
                  "Ref": "AWS::AccountId",
                },
                "-",
                {
                  "Ref": "AWS::Region",
                },
                "/",
              ],
            ],
          },
        },
        "OwnershipControls": {
          "Rules": [
            {
              "ObjectOwnership": "BucketOwnerPreferred",
            },
          ],
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true,
        },
        "VersioningConfiguration": {
          "Status": "Enabled",
        },
      },
      "Type": "AWS::S3::Bucket",
      "UpdateReplacePolicy": "Retain",
    },
    "ConfigBucketPolicy": {
      "Condition": "CreateConfigCondition",
      "Properties": {
        "Bucket": {
          "Ref": "ConfigBucket",
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:*",
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false",
                },
              },
              "Effect": "Deny",
              "Principal": {
                "AWS": "*",
              },
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "ConfigBucket",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "ConfigBucket",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
              "Sid": "deny-insecure-connections",
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::S3::BucketPolicy",
    },
    "DeploySolutionDocument": {
      "Properties": {
        "Content": {
          "assumeRole": "{{AutomationAssumeRole}}",
          "description": "Automation document to deploy Landing Zone Accelerator on AWS (LZA) solution by running ECS Fargate tasks in a private subnet",
          "mainSteps": [
            {
              "action": "aws:executeScript",
              "description": "Starts a new ECS task and returns task details with CloudWatch log URL",
              "inputs": {
                "Handler": "handler",
                "InputPayload": {
                  "Cluster": "{{Cluster}}",
                  "LogGroupName": {
                    "Ref": "LogGroup",
                  },
                  "Region": {
                    "Ref": "AWS::Region",
                  },
                  "SecurityGroupId": "{{SecurityGroupId}}",
                  "SolutionId": "AwsSolution/SO0199/1.15.0",
                  "SubnetId": "{{SubnetId}}",
                  "TaskDefinition": "{{TaskDefinition}}",
                },
                "Runtime": "{{PythonRuntime}}",
                "Script": "REPLACED-JSON-PATH.json",
              },
              "name": "RunTask",
              "outputs": [
                {
                  "Name": "ClusterName",
                  "Selector": "$.Payload.ClusterName",
                  "Type": "String",
                },
                {
                  "Name": "TaskArn",
                  "Selector": "$.Payload.TaskArn",
                  "Type": "String",
                },
                {
                  "Name": "LogGroupName",
                  "Selector": "$.Payload.LogGroupName",
                  "Type": "String",
                },
                {
                  "Name": "LogStreamName",
                  "Selector": "$.Payload.LogStreamName",
                  "Type": "String",
                },
              ],
              "timeoutSeconds": 600,
            },
            {
              "action": "aws:waitForAwsResourceProperty",
              "description": "Wait for ECS task to complete",
              "inputs": {
                "Api": "DescribeTasks",
                "DesiredValues": [
                  "STOPPED",
                ],
                "PropertySelector": "$.tasks[0].lastStatus",
                "Service": "ecs",
                "cluster": "{{RunTask.ClusterName}}",
                "tasks": [
                  "{{RunTask.TaskArn}}",
                ],
              },
              "name": "WaitForTaskCompletion",
              "outputs": [
                {
                  "Name": "TaskStatus",
                  "Selector": "$.tasks[0].lastStatus",
                  "Type": "String",
                },
              ],
              "timeoutSeconds": 43200,
            },
            {
              "action": "aws:executeScript",
              "description": "Verifies the container exit code after task completion and fails the automation if exit code is non-zero",
              "inputs": {
                "Handler": "handler",
                "InputPayload": {
                  "ClusterName": "{{RunTask.ClusterName}}",
                  "LogGroupName": "{{RunTask.LogGroupName}}",
                  "LogStreamName": "{{RunTask.LogStreamName}}",
                  "Region": {
                    "Ref": "AWS::Region",
                  },
                  "SolutionId": "AwsSolution/SO0199/1.15.0",
                  "TaskArn": "{{RunTask.TaskArn}}",
                },
                "Runtime": "{{PythonRuntime}}",
                "Script": "import boto3
from botocore.config import Config

def handler(event, context):
    config = Config(user_agent_extra=event['SolutionId']) 
    client = boto3.client('ecs', region_name=event['Region'], config=config)
    
    response = client.describe_tasks(
        cluster=event['ClusterName'],
        tasks=[event['TaskArn']]
    )
    
    if not response['tasks']:
        raise Exception(f"Task not found: {event['TaskArn']}")
    
    task = response['tasks'][0]
    containers = task.get('containers', [])
    
    if not containers:
        raise Exception(f"No containers found in task: {event['TaskArn']}")
    
    # Extract exit code from tasks[0].containers[0].exitCode
    container = containers[0]
    exit_code = container.get('exitCode')  # Can be 0, 1, 137, etc. or None if killed
    
    # Extract task-level stop information
    stop_code = task.get('stopCode', 'Unknown')  # e.g., "EssentialContainerExited"
    stop_reason = task.get('stoppedReason', 'Unknown')  # e.g., "Essential container in task exited"
    task_status = task.get('lastStatus', 'Unknown')
    
    result = {
        'ExitCode': exit_code if exit_code is not None else -1,
        'StopCode': stop_code,
        'StopReason': stop_reason,
        'TaskStatus': task_status,
        'LogStreamName': event['LogStreamName'],
        'LogGroupName': event['LogGroupName']
    }
    
    # Fail if exit code is non-zero or None (container was killed)
    if exit_code is None or exit_code != 0:
        error_msg = (
            f"ECS task failed with exit code {exit_code}. "
            f"Stop code: {stop_code}. "
            f"Stop reason: {stop_reason}. "
            f"Check CloudWatch logs: {event['LogGroupName']}/{event['LogStreamName']}"
        )
        raise Exception(error_msg)
    
    return result",
              },
              "name": "CheckTaskExitCode",
              "outputs": [
                {
                  "Name": "ExitCode",
                  "Selector": "$.Payload.ExitCode",
                  "Type": "Integer",
                },
                {
                  "Name": "StopCode",
                  "Selector": "$.Payload.StopCode",
                  "Type": "String",
                },
                {
                  "Name": "StopReason",
                  "Selector": "$.Payload.StopReason",
                  "Type": "String",
                },
                {
                  "Name": "TaskStatus",
                  "Selector": "$.Payload.TaskStatus",
                  "Type": "String",
                },
              ],
              "timeoutSeconds": 600,
            },
          ],
          "outputs": [
            "RunTask.TaskArn",
            "RunTask.ClusterName",
            "RunTask.LogGroupName",
            "RunTask.LogStreamName",
            "WaitForTaskCompletion.TaskStatus",
            "CheckTaskExitCode.ExitCode",
            "CheckTaskExitCode.StopCode",
            "CheckTaskExitCode.StopReason",
          ],
          "parameters": {
            "AutomationAssumeRole": {
              "default": {
                "Fn::GetAtt": [
                  "SsmAutomationRole",
                  "Arn",
                ],
              },
              "description": "The ARN of the IAM role that allows Systems Manager Automation to perform actions",
              "type": "String",
            },
            "Cluster": {
              "default": {
                "Ref": "EcsCluster",
              },
              "description": "The short name or full ARN of the cluster to run your task on",
              "type": "String",
            },
            "PythonRuntime": {
              "default": {
                "Ref": "PythonRuntimeVersion",
              },
              "description": "The Python runtime version for aws:executeScript actions",
              "type": "String",
            },
            "SecurityGroupId": {
              "default": {
                "Fn::If": [
                  "CreateVpcCondition",
                  {
                    "Ref": "SecurityGroup",
                  },
                  {
                    "Ref": "ExistingSecurityGroupId",
                  },
                ],
              },
              "description": "The security group used by the ECS task",
              "type": "String",
            },
            "SubnetId": {
              "default": {
                "Fn::If": [
                  "CreateVpcCondition",
                  {
                    "Ref": "PrivateSubnet0",
                  },
                  {
                    "Ref": "ExistingSubnetId",
                  },
                ],
              },
              "description": "The subnet where the ECS task will be placed",
              "type": "String",
            },
            "TaskDefinition": {
              "default": {
                "Ref": "TaskDefinition",
              },
              "description": "The family and revision or full ARN of the task definition to run",
              "type": "String",
            },
          },
          "schemaVersion": "0.3",
        },
        "DocumentType": "Automation",
        "Name": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "acceleratorPrefix",
                ],
              },
              "-RunEngine",
            ],
          ],
        },
        "UpdateMethod": "NewVersion",
      },
      "Type": "AWS::SSM::Document",
    },
    "EcsCluster": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-ECS4",
              "reason": "The ECS Cluster has CloudWatch Container Insights are not present in all partitions.",
            },
            {
              "id": "AwsSolutions-ECS7",
              "reason": "The ECS task definition used has logging enabled to CloudWatch logs.",
            },
          ],
        },
      },
      "Properties": {
        "ClusterName": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-ecs-cluster",
            ],
          ],
        },
      },
      "Type": "AWS::ECS::Cluster",
    },
    "EcsExecutionRole": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "The ECS task needs admin access to orchestrate the engine.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/AdministratorAccess",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "EcsTaskRole": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "The ECS task needs admin access to orchestrate LZA deployment and manage AWS resources.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/AdministratorAccess",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "InstallerAccessLogsBucket647700E9": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-S1",
              "reason": "AccessLogsBucket has server access logs disabled till the task for access logging completed.",
            },
          ],
        },
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W35",
              "reason": "This is an access logging bucket.",
            },
          ],
        },
      },
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256",
              },
            },
          ],
        },
        "BucketName": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-s3-logs-",
              {
                "Ref": "AWS::AccountId",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
            ],
          ],
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "AbortIncompleteMultipartUpload": {
                "DaysAfterInitiation": 1,
              },
              "ExpirationInDays": 1825,
              "ExpiredObjectDeleteMarker": false,
              "Id": {
                "Fn::Join": [
                  "",
                  [
                    "LifecycleRule",
                    {
                      "Fn::GetAtt": [
                        "ResourceNamePrefixesGetPrefixResource96A10E6E",
                        "lowerCasePrefix",
                      ],
                    },
                    "-s3-logs-",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    "-",
                    {
                      "Ref": "AWS::Region",
                    },
                  ],
                ],
              },
              "NoncurrentVersionExpiration": {
                "NoncurrentDays": 1825,
              },
              "NoncurrentVersionTransitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 366,
                },
              ],
              "Status": "Enabled",
              "Transitions": [
                {
                  "StorageClass": "DEEP_ARCHIVE",
                  "TransitionInDays": 365,
                },
              ],
            },
          ],
        },
        "OwnershipControls": {
          "Rules": [
            {
              "ObjectOwnership": "BucketOwnerPreferred",
            },
          ],
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true,
        },
        "VersioningConfiguration": {
          "Status": "Enabled",
        },
      },
      "Type": "AWS::S3::Bucket",
      "UpdateReplacePolicy": "Retain",
    },
    "InstallerAccessLogsBucketName4F700F48": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/installer-access-logs-bucket-name",
            ],
          ],
        },
        "Type": "String",
        "Value": {
          "Ref": "InstallerAccessLogsBucket647700E9",
        },
      },
      "Type": "AWS::SSM::Parameter",
    },
    "InstallerAccessLogsBucketPolicy20D4E285": {
      "Properties": {
        "Bucket": {
          "Ref": "InstallerAccessLogsBucket647700E9",
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:*",
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false",
                },
              },
              "Effect": "Deny",
              "Principal": {
                "AWS": "*",
              },
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "InstallerAccessLogsBucket647700E9",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "InstallerAccessLogsBucket647700E9",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
              "Sid": "deny-insecure-connections",
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::S3::BucketPolicy",
    },
    "InstallerKey2A6A8C6D": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "F76",
              "reason": "KMS key using * principal with added arn condition",
            },
          ],
        },
      },
      "Properties": {
        "Description": "KMS key for encrypting LZA installer S3 configuration bucket in the management account",
        "EnableKeyRotation": true,
        "KeyPolicy": {
          "Statement": [
            {
              "Action": "kms:*",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":iam::",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":root",
                    ],
                  ],
                },
              },
              "Resource": "*",
            },
            {
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ],
              "Condition": {
                "ArnLike": {
                  "aws:PrincipalARN": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":iam::",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":role/",
                        {
                          "Fn::GetAtt": [
                            "ResourceNamePrefixesGetPrefixResource96A10E6E",
                            "acceleratorPrefix",
                          ],
                        },
                        "-*",
                      ],
                    ],
                  },
                },
              },
              "Effect": "Allow",
              "Principal": {
                "AWS": "*",
              },
              "Resource": "*",
              "Sid": "Allow Accelerator Role to use the encryption key",
            },
            {
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": "sns.amazonaws.com",
              },
              "Resource": "*",
              "Sid": "Allow SNS service to use the encryption key",
            },
            {
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
              ],
              "Condition": {
                "ArnLike": {
                  "kms:EncryptionContext:aws:logs:arn": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":logs:",
                        {
                          "Ref": "AWS::Region",
                        },
                        ":",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":log-group:*",
                      ],
                    ],
                  },
                },
              },
              "Effect": "Allow",
              "Principal": {
                "Service": {
                  "Fn::Join": [
                    "",
                    [
                      "logs.",
                      {
                        "Ref": "AWS::Region",
                      },
                      ".amazonaws.com",
                    ],
                  ],
                },
              },
              "Resource": "*",
              "Sid": "Allow Cloudwatch Logs service to use the encryption key",
            },
          ],
        },
      },
      "Type": "AWS::KMS::Key",
      "UpdateReplacePolicy": "Retain",
    },
    "InstallerKeyAliasD5C174F0": {
      "Properties": {
        "AliasName": {
          "Fn::Join": [
            "",
            [
              "alias/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/installer/kms/key",
            ],
          ],
        },
        "TargetKeyId": {
          "Fn::GetAtt": [
            "InstallerKey2A6A8C6D",
            "Arn",
          ],
        },
      },
      "Type": "AWS::KMS::Alias",
    },
    "InternetGateway": {
      "Condition": "CreateVpcCondition",
      "Type": "AWS::EC2::InternetGateway",
    },
    "LogGroup": {
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/ecs/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-lza-deployment",
            ],
          ],
        },
        "RetentionInDays": 365,
      },
      "Type": "AWS::Logs::LogGroup",
    },
    "NatEip0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "Domain": "vpc",
      },
      "Type": "AWS::EC2::EIP",
    },
    "NatEip1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "Domain": "vpc",
      },
      "Type": "AWS::EC2::EIP",
    },
    "NatGateway0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "NatEip0",
            "AllocationId",
          ],
        },
        "SubnetId": {
          "Ref": "PublicSubnet0",
        },
      },
      "Type": "AWS::EC2::NatGateway",
    },
    "NatGateway1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "NatEip1",
            "AllocationId",
          ],
        },
        "SubnetId": {
          "Ref": "PublicSubnet1",
        },
      },
      "Type": "AWS::EC2::NatGateway",
    },
    "PrivateRoute0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "NatGateway0",
        },
        "RouteTableId": {
          "Ref": "PrivateRouteTable0",
        },
      },
      "Type": "AWS::EC2::Route",
    },
    "PrivateRoute1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "NatGateway1",
        },
        "RouteTableId": {
          "Ref": "PrivateRouteTable1",
        },
      },
      "Type": "AWS::EC2::Route",
    },
    "PrivateRouteTable0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::RouteTable",
    },
    "PrivateRouteTable1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::RouteTable",
    },
    "PrivateSubnet0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            0,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.10.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PrivateSubnet1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            1,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.11.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PrivateSubnetRouteTableAssociation0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PrivateRouteTable0",
        },
        "SubnetId": {
          "Ref": "PrivateSubnet0",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "PrivateSubnetRouteTableAssociation1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PrivateRouteTable1",
        },
        "SubnetId": {
          "Ref": "PrivateSubnet1",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "PublicRoute": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "InternetGateway",
        },
        "RouteTableId": {
          "Ref": "PublicRouteTable",
        },
      },
      "Type": "AWS::EC2::Route",
    },
    "PublicRouteTable": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::RouteTable",
    },
    "PublicSubnet0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            0,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.0.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PublicSubnet1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [
            1,
            {
              "Fn::GetAZs": "",
            },
          ],
        },
        "CidrBlock": "10.0.1.0/24",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::Subnet",
    },
    "PublicSubnetRouteTableAssociation0": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PublicRouteTable",
        },
        "SubnetId": {
          "Ref": "PublicSubnet0",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "PublicSubnetRouteTableAssociation1": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "RouteTableId": {
          "Ref": "PublicRouteTable",
        },
        "SubnetId": {
          "Ref": "PublicSubnet1",
        },
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
    },
    "ResourceNamePrefixesGetPrefixResource96A10E6E": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "ResourceNamePrefixesResourceNamePrefixesFunction138C66F1",
            "Arn",
          ],
        },
        "pipelineStackVersionSsmParamName": {
          "Fn::Join": [
            "",
            [
              "/accelerator/AWSAccelerator-PipelineStack-",
              {
                "Ref": "AWS::AccountId",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
              "/version",
            ],
          ],
        },
        "prefix": {
          "Ref": "AcceleratorPrefix",
        },
        "prefixParameterName": "/accelerator/lza-prefix",
      },
      "Type": "Custom::GetPrefixes",
      "UpdateReplacePolicy": "Delete",
    },
    "ResourceNamePrefixesResourceNamePrefixesFunction138C66F1": {
      "DependsOn": [
        "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRoleDefaultPolicyDC1CC159",
        "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2",
      ],
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "Needed to write to CWL group",
            },
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Needed to create SSM parameter for prefix",
            },
          ],
        },
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W58",
              "reason": "CloudWatch Logs are enabled in AWSLambdaBasicExecutionRole",
            },
            {
              "id": "W89",
              "reason": "This function supports infrastructure deployment and is not deployed inside a VPC.",
            },
            {
              "id": "W92",
              "reason": "This function supports infrastructure deployment and does not require setting ReservedConcurrentExecutions.",
            },
          ],
        },
      },
      "Properties": {
        "Code": {
          "ZipFile": "
          const response = require('cfn-response'); 
          const { SSMClient, DeleteParameterCommand, GetParameterCommand, ParameterNotFound, PutParameterCommand } = require("@aws-sdk/client-ssm");
          const { ConfiguredRetryStrategy } = require("@aws-sdk/util-retry");
          exports.handler = async function (event, context) { 
          console.log(JSON.stringify(event, null, 4)); 
          const prefix=event.ResourceProperties.prefix;
          const pipelineStackVersionSsmParamName=event.ResourceProperties.pipelineStackVersionSsmParamName;
          const lowerCasePrefix=prefix.toLowerCase();
          
          const ssm = new SSMClient({retryStrategy: new ConfiguredRetryStrategy(10, (attempt) => 100 + attempt * 1000)});
          
          let data = {};
          
          let paramName = event.ResourceProperties.prefixParameterName;
          
          if (lowerCasePrefix === 'awsaccelerator') {
              data['acceleratorPrefix'] = 'AWSAccelerator';
              data['lowerCasePrefix'] = 'aws-accelerator'; 
              data['oneWordPrefix'] = 'accelerator';               
          } else {
              data['acceleratorPrefix'] = prefix;
              data['lowerCasePrefix'] = lowerCasePrefix; 
              data['oneWordPrefix'] = prefix; 
          }
                  

          if (event.RequestType === 'Update'){

              var params = {
                Name: paramName,
              };
              try {
                  const ssmResponse = await ssm.send(new GetParameterCommand(params));
                  // Fail stack if prefix was changed during update
                  if (ssmResponse.Parameter.Value !== prefix) {
                      await response.send(event, context, response.FAILED, {'FailureReason': 'LZA does not allow changing AcceleratorPrefix parameter value after initial deploy !!! Existing prefix: ' + event.OldResourceProperties.prefix + ' New prefix: ' + prefix + '.' }, event.PhysicalResourceId);
                      return;
                  }
                  await response.send(event, context, response.SUCCESS, data, event.PhysicalResourceId);
              } catch (error) {
                  console.log(error);
                  if (error instanceof ParameterNotFound){
                      await response.send(event, context, response.FAILED, {'FailureReason': 'LZA prefix ssm parameter ' + paramName + ' not found!!! Recreate the parameter with existing AcceleratorPrefix parameter value to fix the issue'}, event.PhysicalResourceId);
                      return;
                  }
                  else {
                      await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while accessing LZA prefix ssm parameter ' + paramName }, event.PhysicalResourceId);
                      return;
                  }
              }          
          } 
          
          if (event.RequestType === 'Create') {
          
              if (lowerCasePrefix !== 'awsaccelerator') {
                  // Fail stack if prefix starts with aws or ssm
                  if (lowerCasePrefix.startsWith('aws') || lowerCasePrefix.startsWith('ssm')) { 
                      await response.send(event, context, response.FAILED, {'FailureReason': 'Accelerator prefix ' + prefix + ' can not be started with aws or ssm !!!'}, event.PhysicalResourceId);
                      return;
                  }

                  // Check if this is an existing deployment and prefix changed with initial deployment of custom resource
                  var versionParams = {
                    Name: pipelineStackVersionSsmParamName,
                  };
                  try {
                    await ssm.send(new GetParameterCommand(versionParams));
                    await response.send(event, context, response.FAILED, {'FailureReason': 'Can not change AcceleratorPrefix parameter for existing deployment, existing prefix value is AWSAccelerator, keep AcceleratorPrefix parameter value to default value for successfully stack update !!!'}, event.PhysicalResourceId);
                    return;
                  }
                  catch (error) {
                    console.log(error);
                    if (!(error instanceof ParameterNotFound)){
                      await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while accessing LZA ssm parameter ' + pipelineStackVersionSsmParamName }, event.PhysicalResourceId);
                      return;
                    }
                  }
              }
          
              // Create /accelerator/lza-prefix SSM parameter to store prefix value to protect updating prefix
              try {
                  var newParams = {
                        Name: paramName,
                        Value: prefix,
                        Description: 'LZA created SSM parameter for Accelerator prefix value, DO NOT MODIFY/DELETE this parameter',
                        Type: 'String',
                      };
                  await ssm.send(new PutParameterCommand(newParams));
                  await response.send(event, context, response.SUCCESS, data, event.PhysicalResourceId);
              }
              catch (error) {
                  console.log(error);
                  await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while creating LZA prefix ssm parameter ' + paramName }, event.PhysicalResourceId);
                  return;
              }
          }
          if (event.RequestType === 'Delete') {

            var deleteParams = {
              Name: paramName,
            };
            try {
              await ssm.send(new DeleteParameterCommand(deleteParams));
            }
            catch (error) {
              console.log(error);
              if (!(error instanceof ParameterNotFound)){
                await response.send(event, context, response.FAILED, {'FailureReason': error.code + ' error occurred while deleting LZA ssm parameter ' + paramName }, event.PhysicalResourceId);
                return;
              }
            }
            await response.send(event, context, response.SUCCESS, {'Status': 'Custom resource deleted successfully' }, event.PhysicalResourceId);
          }
          
          return;
      }",
        },
        "Description": "This function converts accelerator prefix parameter to lower case to name s3 buckets in installer stack",
        "Handler": "index.handler",
        "Role": {
          "Fn::GetAtt": [
            "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2",
            "Arn",
          ],
        },
        "Runtime": "nodejs22.x",
      },
      "Type": "AWS::Lambda::Function",
    },
    "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "Needed to write to CWL group",
            },
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Needed to create SSM parameter for prefix",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRoleDefaultPolicyDC1CC159": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM4",
              "reason": "Needed to write to CWL group",
            },
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Needed to create SSM parameter for prefix",
            },
          ],
        },
      },
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "ssm:GetParameters",
                "ssm:GetParameter",
                "ssm:PutParameter",
                "ssm:DeleteParameter",
              ],
              "Condition": {
                "StringEquals": {
                  "aws:PrincipalAccount": {
                    "Ref": "AWS::AccountId",
                  },
                },
              },
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":ssm:",
                      {
                        "Ref": "AWS::Region",
                      },
                      ":",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":parameter/accelerator/lza-prefix",
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":ssm:",
                      {
                        "Ref": "AWS::Region",
                      },
                      ":",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      ":parameter/accelerator/AWSAccelerator-PipelineStack-",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      "-",
                      {
                        "Ref": "AWS::Region",
                      },
                      "/version",
                    ],
                  ],
                },
              ],
              "Sid": "SsmReadParameterAccess",
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRoleDefaultPolicyDC1CC159",
        "Roles": [
          {
            "Ref": "ResourceNamePrefixesResourceNamePrefixesFunctionServiceRole17DDBBF2",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "SecurityGroup": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "GroupDescription": "Security group for VPC",
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::SecurityGroup",
    },
    "SsmAutomationRole": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-IAM5",
              "reason": "Wild card permissions are needed on describe and run task calls.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ssm.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "ecs:RunTask",
                    "ecs:DescribeTasks",
                  ],
                  "Effect": "Allow",
                  "Resource": "*",
                },
                {
                  "Action": [
                    "iam:PassRole",
                  ],
                  "Effect": "Allow",
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "EcsExecutionRole",
                        "Arn",
                      ],
                    },
                    {
                      "Fn::GetAtt": [
                        "EcsTaskRole",
                        "Arn",
                      ],
                    },
                  ],
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "EcsRunTaskPolicy",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "SsmParamAcceleratorVersionFF83282D": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/TestInstallerContainerStackS3/version",
            ],
          ],
        },
        "Type": "String",
        "Value": "1.15.0",
      },
      "Type": "AWS::SSM::Parameter",
    },
    "SsmParamStackId521A78D3": {
      "Properties": {
        "Name": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "oneWordPrefix",
                ],
              },
              "/TestInstallerContainerStackS3/stack-id",
            ],
          ],
        },
        "Type": "String",
        "Value": {
          "Ref": "AWS::StackId",
        },
      },
      "Type": "AWS::SSM::Parameter",
    },
    "TaskDefinition": {
      "Metadata": {
        "cdk_nag": {
          "rules_to_suppress": [
            {
              "id": "AwsSolutions-ECS2",
              "reason": "Environment variables are needed to turn off features made for services relying on CodePipeline and CodeBuild",
            },
          ],
        },
      },
      "Properties": {
        "ContainerDefinitions": [
          {
            "Command": [
              "/landing-zone-accelerator-on-aws/scripts/run-lza.sh deploy",
            ],
            "EntryPoint": [
              "sh",
              "-c",
            ],
            "Environment": [
              {
                "Name": "ENABLE_DIAGNOSTICS_PACK",
                "Value": "No",
              },
              {
                "Name": "SkipPipelinePrerequisites",
                "Value": "true",
              },
              {
                "Name": "SkipAcceleratorPrerequisites",
                "Value": "true",
              },
              {
                "Name": "AWS_REGION",
                "Value": {
                  "Ref": "AWS::Region",
                },
              },
              {
                "Name": "CONFIG_S3_PATH",
                "Value": {
                  "Fn::If": [
                    "CreateConfigCondition",
                    {
                      "Fn::Join": [
                        "",
                        [
                          "s3://",
                          {
                            "Fn::GetAtt": [
                              "ResourceNamePrefixesGetPrefixResource96A10E6E",
                              "lowerCasePrefix",
                            ],
                          },
                          "-config-",
                          {
                            "Ref": "AWS::AccountId",
                          },
                          "-",
                          {
                            "Ref": "AWS::Region",
                          },
                          "/lza/aws-accelerator-config.zip",
                        ],
                      ],
                    },
                    {
                      "Fn::Join": [
                        "",
                        [
                          "s3://",
                          {
                            "Ref": "ExistingConfigBucketName",
                          },
                          "/",
                          {
                            "Ref": "ExistingConfigBucketKey",
                          },
                        ],
                      ],
                    },
                  ],
                },
              },
              {
                "Name": "CONFIG_S3_BUCKET",
                "Value": {
                  "Fn::If": [
                    "CreateConfigCondition",
                    {
                      "Fn::Join": [
                        "",
                        [
                          {
                            "Fn::GetAtt": [
                              "ResourceNamePrefixesGetPrefixResource96A10E6E",
                              "lowerCasePrefix",
                            ],
                          },
                          "-config-",
                          {
                            "Ref": "AWS::AccountId",
                          },
                          "-",
                          {
                            "Ref": "AWS::Region",
                          },
                        ],
                      ],
                    },
                    {
                      "Ref": "ExistingConfigBucketName",
                    },
                  ],
                },
              },
              {
                "Name": "CONFIG_S3_KEY",
                "Value": {
                  "Fn::If": [
                    "CreateConfigCondition",
                    "lza/aws-accelerator-config.zip",
                    {
                      "Ref": "ExistingConfigBucketKey",
                    },
                  ],
                },
              },
              {
                "Name": "CONFIG_BUCKET_NAME",
                "Value": {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "ResourceNamePrefixesGetPrefixResource96A10E6E",
                          "lowerCasePrefix",
                        ],
                      },
                      "-config-",
                      {
                        "Ref": "AWS::AccountId",
                      },
                      "-",
                      {
                        "Ref": "AWS::Region",
                      },
                    ],
                  ],
                },
              },
              {
                "Name": "MANAGEMENT_ACCOUNT_EMAIL",
                "Value": {
                  "Ref": "ManagementAccountEmail",
                },
              },
              {
                "Name": "LOG_ARCHIVE_ACCOUNT_EMAIL",
                "Value": {
                  "Ref": "LogArchiveAccountEmail",
                },
              },
              {
                "Name": "AUDIT_ACCOUNT_EMAIL",
                "Value": {
                  "Ref": "AuditAccountEmail",
                },
              },
              {
                "Name": "CONTROL_TOWER_ENABLED",
                "Value": {
                  "Ref": "ControlTowerEnabled",
                },
              },
              {
                "Name": "ACCELERATOR_PREFIX",
                "Value": {
                  "Fn::GetAtt": [
                    "ResourceNamePrefixesGetPrefixResource96A10E6E",
                    "acceleratorPrefix",
                  ],
                },
              },
              {
                "Name": "INSTALLER_STACK_NAME",
                "Value": {
                  "Fn::Sub": "\${AWS::StackName}",
                },
              },
              {
                "Name": "PARTITION",
                "Value": {
                  "Fn::Sub": "\${AWS::Partition}",
                },
              },
              {
                "Name": "PIPELINE_ACCOUNT_ID",
                "Value": {
                  "Ref": "AWS::AccountId",
                },
              },
              {
                "Name": "LOG_LEVEL",
                "Value": {
                  "Ref": "LogLevel",
                },
              },
            ],
            "Image": {
              "Ref": "EcrUri",
            },
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-group": {
                  "Ref": "LogGroup",
                },
                "awslogs-region": {
                  "Ref": "AWS::Region",
                },
                "awslogs-stream-prefix": "ecs",
              },
            },
            "Name": "lza-deployment-container",
          },
        ],
        "Cpu": "8192",
        "ExecutionRoleArn": {
          "Fn::GetAtt": [
            "EcsExecutionRole",
            "Arn",
          ],
        },
        "Family": {
          "Fn::Join": [
            "",
            [
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
              "-lza-deployment-task",
            ],
          ],
        },
        "Memory": "32768",
        "NetworkMode": "awsvpc",
        "RequiresCompatibilities": [
          "EC2",
          "FARGATE",
        ],
        "TaskRoleArn": {
          "Fn::GetAtt": [
            "EcsTaskRole",
            "Arn",
          ],
        },
      },
      "Type": "AWS::ECS::TaskDefinition",
    },
    "Vpc": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "CidrBlock": {
          "Ref": "VpcCidr",
        },
        "EnableDnsHostnames": true,
        "EnableDnsSupport": true,
        "InstanceTenancy": "default",
      },
      "Type": "AWS::EC2::VPC",
    },
    "VpcFlowLog": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "DeliverLogsPermissionArn": {
          "Fn::GetAtt": [
            "VpcFlowLogRole",
            "Arn",
          ],
        },
        "LogDestinationType": "cloud-watch-logs",
        "LogGroupName": {
          "Ref": "VpcFlowLogGroup",
        },
        "ResourceId": {
          "Ref": "Vpc",
        },
        "ResourceType": "VPC",
        "TrafficType": "ALL",
      },
      "Type": "AWS::EC2::FlowLog",
    },
    "VpcFlowLogGroup": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/aws/vpc/flowlogs/",
              {
                "Fn::GetAtt": [
                  "ResourceNamePrefixesGetPrefixResource96A10E6E",
                  "lowerCasePrefix",
                ],
              },
            ],
          ],
        },
        "RetentionInDays": 365,
      },
      "Type": "AWS::Logs::LogGroup",
    },
    "VpcFlowLogRole": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "vpc-flow-logs.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "logs:CreateLogStream",
                    "logs:PutLogEvents",
                    "logs:DescribeLogGroups",
                    "logs:DescribeLogStreams",
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::GetAtt": [
                      "VpcFlowLogGroup",
                      "Arn",
                    ],
                  },
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "CloudWatchLogPolicy",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "VpcGatewayAttachment": {
      "Condition": "CreateVpcCondition",
      "Properties": {
        "InternetGatewayId": {
          "Ref": "InternetGateway",
        },
        "VpcId": {
          "Ref": "Vpc",
        },
      },
      "Type": "AWS::EC2::VPCGatewayAttachment",
    },
  },
  "Rules": {
    "RequiredParametersForExistingRepo": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingConfigBucketKey",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "existingConfigBucketKey parameter must be provided when useExistingConfig is set to Yes",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingConfigBucketName",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "existingConfigBucketName parameter must be provided when useExistingRepository is set to Yes",
        },
      ],
      "RuleCondition": {
        "Fn::Equals": [
          "Yes",
          {
            "Ref": "UseExistingConfig",
          },
        ],
      },
    },
    "RequiredParametersForExistingVpc": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingVpcId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ExistingVpcId parameter must be provided when UseExistingVpc is set to Yes",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingSubnetId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ExistingSubnetId parameter must be provided when UseExistingVpc is set to Yes",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  "",
                  {
                    "Ref": "ExistingSecurityGroupId",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "ExistingSecurityGroupId parameter must be provided when UseExistingVpc is set to Yes",
        },
      ],
      "RuleCondition": {
        "Fn::Equals": [
          "Yes",
          {
            "Ref": "UseExistingVpc",
          },
        ],
      },
    },
    "UniqueAccountEmails": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "ManagementAccountEmail",
                  },
                  {
                    "Ref": "LogArchiveAccountEmail",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "Management Account Email and Log Archive Account Email must be different",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "ManagementAccountEmail",
                  },
                  {
                    "Ref": "AuditAccountEmail",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "Management Account Email and Audit Account Email must be different",
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "LogArchiveAccountEmail",
                  },
                  {
                    "Ref": "AuditAccountEmail",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "Log Archive Account Email and Audit Account Email must be different",
        },
      ],
    },
  },
}
`;
