# Contributing to Installer Container Tests

## Overview

This guide helps you contribute tests to the installer-container package. We use snapshot testing to validate CloudFormation templates generated by CDK stacks.

## Prerequisites

Before writing tests, ensure you understand:

1. **CDK Basics** - How to create and configure CDK stacks
2. **CloudFormation** - Basic understanding of AWS CloudFormation templates
3. **Snapshot Testing** - Concept of capturing and comparing outputs
4. **Vitest** - Our testing framework

## Development Setup

### 1. Install Dependencies

```bash
# From repository root
yarn install

# Build required packages
yarn --cwd source/packages/@aws-accelerator/installer build
yarn --cwd source/packages/@aws-accelerator/utils build
yarn --cwd source/packages/@aws-accelerator/constructs build
```

### 2. Verify Setup

```bash
cd source/packages/@aws-accelerator/installer-container
yarn test:unit
```

All tests should pass âœ…

## Writing Your First Test

### Step 1: Understand What to Test

Ask yourself:
- What configuration scenario am I testing?
- What resources should be in the CloudFormation template?
- How is this different from existing tests?

### Step 2: Write the Test

Add to `test/installer-container-stack.test.ts`:

```typescript
/**
 * Test: My New Configuration
 *
 * Brief description of what this configuration tests and why it's important.
 *
 * Key Resources Validated:
 * - Resource 1: Description
 * - Resource 2: Description
 */
snapShotTest('Construct(InstallerContainerStack): My New Config', () => {
  const app = new cdk.App();
  return new InstallerContainerStack(app, 'TestStackMyConfig', {
    // Your configuration
    myNewProp: true,
    existingProp: false,
  });
});
```

### Step 3: Run the Test

```bash
yarn test:unit
```

The test will pass and create a snapshot automatically.

### Step 4: Review the Snapshot

```bash
# View the generated snapshot
cat test/__snapshots__/installer-container-stack.test.ts.snap
```

Look for:
- âœ… Expected resources are present
- âœ… Parameters are correct
- âœ… IAM policies are appropriate
- âš ï¸ No unexpected resources

### Step 5: Document Your Test

Add comments explaining:
- **What** the test validates
- **Why** this configuration is important
- **Key resources** that should be present

## Modifying Existing Tests

### When to Modify

Modify existing tests when:
- Stack behavior changes intentionally
- New resources are added to the stack
- Parameters or properties change
- Bug fixes affect CloudFormation output

### How to Modify

1. **Make your code changes** to the stack

2. **Run tests** to see what changed:
   ```bash
   yarn test:unit
   ```

3. **Review the diff carefully:**
   ```
   Expected: "OldValue"
   Received: "NewValue"
   ```

4. **Verify changes are intentional:**
   - âœ… Expected changes from your code
   - âš ï¸ Unexpected changes need investigation

5. **Update snapshots if correct:**
   ```bash
   yarn test:unit -u
   ```

6. **Document in commit message:**
   ```
   feat: add new parameter to stack
   
   - Added MyNewParameter for feature X
   - Updated snapshot tests to reflect new parameter
   - All existing resources unchanged
   ```

## Test Organization

### File Structure

```
test/
â”œâ”€â”€ README.md                    # Detailed documentation
â”œâ”€â”€ CONTRIBUTING.md              # This file
â”œâ”€â”€ snapshot-test.ts             # Shared utility (don't modify often)
â”œâ”€â”€ installer-container-stack.test.ts  # Main test file
â””â”€â”€ __snapshots__/               # Generated (committed to git)
```

### Test Naming

Use descriptive names that explain the configuration:

**Good:**
- `Construct(InstallerContainerStack): With External Pipeline Account`
- `Construct(InstallerContainerStack): Permission Boundary Enabled`
- `Construct(InstallerContainerStack): S3 Source with KMS Encryption`

**Bad:**
- `Test 1`
- `Stack test`
- `It works`

### Test Documentation

Each test should have a comment block:

```typescript
/**
 * Test: [Configuration Name]
 *
 * [1-2 sentence description of what this tests]
 *
 * Key Resources Validated:
 * - [Resource 1]: [Why it's important]
 * - [Resource 2]: [Why it's important]
 *
 * Additional Notes:
 * - [Any special considerations]
 */
snapShotTest('...', () => { ... });
```

## Common Patterns

### Testing Optional Features

```typescript
// Test with feature enabled
snapShotTest('Construct(Stack): With Feature X', () => {
  const app = new cdk.App();
  return new MyStack(app, 'TestStack', {
    enableFeatureX: true,
  });
});

// Test with feature disabled (if behavior differs significantly)
snapShotTest('Construct(Stack): Without Feature X', () => {
  const app = new cdk.App();
  return new MyStack(app, 'TestStack', {
    enableFeatureX: false,
  });
});
```

### Testing Conditional Resources

```typescript
// Test condition that creates resources
snapShotTest('Construct(Stack): Creates Optional Resources', () => {
  const app = new cdk.App();
  return new MyStack(app, 'TestStack', {
    createOptionalResources: true,
  });
});
```

### Testing Cross-Account Scenarios

```typescript
snapShotTest('Construct(Stack): Cross-Account Configuration', () => {
  const app = new cdk.App();
  return new MyStack(app, 'TestStack', {
    targetAccountId: '123456789012',
    crossAccountRoleName: 'MyRole',
  });
});
```

## Debugging Tests

### Test Fails: "Cannot find module"

**Problem:** Dependency not built

**Solution:**
```bash
# Build the missing dependency
yarn --cwd ../[package-name] build

# Example:
yarn --cwd ../installer build
```

### Test Fails: Snapshot Mismatch

**Problem:** CloudFormation template changed

**Solution:**
1. Review the diff shown in test output
2. Verify changes are intentional
3. Update snapshot: `yarn test:unit -u`

### Test Fails: Timeout

**Problem:** Stack synthesis taking too long

**Solution:**
```typescript
// In vitest.config.ts
test: {
  testTimeout: 180000, // Increase to 3 minutes
}
```

### Snapshot Keeps Changing

**Problem:** Dynamic values not normalized

**Solution:** Add serializer in `snapshot-test.ts`:
```typescript
// 1. Identify the pattern
const myPattern = /my-dynamic-value-\d+/;
const isMyValue = (val: unknown) => 
  typeof val === 'string' && val.match(myPattern) != null;

// 2. Add to configureSnapshotSerializers()
expect.addSnapshotSerializer({
  test: isMyValue,
  print: () => '"REPLACED-MY-VALUE"',
});
```

## Code Review Checklist

When submitting tests for review:

### Test Code
- [ ] Test name is descriptive
- [ ] Test has documentation comments
- [ ] Test covers a distinct scenario
- [ ] Test is not duplicating existing coverage
- [ ] Code follows existing patterns

### Snapshots
- [ ] Snapshot diff reviewed carefully
- [ ] Changes are intentional and expected
- [ ] No unexpected resource changes
- [ ] No sensitive data in snapshot
- [ ] Snapshot committed with code

### Documentation
- [ ] Comments explain what is being tested
- [ ] Comments explain why it's important
- [ ] Key resources are documented
- [ ] Commit message explains changes

## Best Practices

### âœ… Do

- **Write focused tests** - One configuration aspect per test
- **Document thoroughly** - Future you will thank you
- **Review diffs carefully** - Don't blindly update snapshots
- **Test edge cases** - Not just happy paths
- **Keep tests maintainable** - Simple and clear
- **Commit snapshots** - They're part of the test

### âŒ Don't

- **Test implementation details** - Test CloudFormation output
- **Duplicate tests** - Each test should be unique
- **Ignore test failures** - Investigate before updating
- **Skip documentation** - Always explain what you're testing
- **Forget dependencies** - Build packages before testing
- **Update snapshots blindly** - Always review the diff

## Getting Help

### Resources

1. **Test README** - [test/README.md](./README.md) - Detailed documentation
2. **Testing Guide** - [TESTING.md](../TESTING.md) - Quick reference
3. **Vitest Docs** - https://vitest.dev/
4. **CDK Testing** - https://docs.aws.amazon.com/cdk/v2/guide/testing.html

### Questions?

1. Check documentation in this directory
2. Review existing tests for examples
3. Ask in team development channel
4. Consult with team testing expert

## Example: Complete Contribution

Here's a complete example of adding a new test:

### 1. Identify the Need

"We need to test the stack with VPC endpoints enabled"

### 2. Write the Test

```typescript
/**
 * Test: VPC Endpoints Enabled
 *
 * Tests the stack with VPC endpoints enabled for private connectivity
 * to AWS services without internet gateway.
 *
 * Key Resources Validated:
 * - VPC Endpoint for S3
 * - VPC Endpoint for ECR
 * - Route table associations
 * - Security group rules for endpoints
 *
 * Additional Notes:
 * - This configuration is used in highly secure environments
 * - Endpoints reduce data transfer costs
 */
snapShotTest('Construct(InstallerContainerStack): With VPC Endpoints', () => {
  const app = new cdk.App();
  return new InstallerContainerStack(app, 'TestStackVpcEndpoints', {
    useExternalPipelineAccount: false,
    useS3Source: false,
    enableSingleAccountMode: false,
    usePermissionBoundary: false,
    setNodeVersion: false,
    enableVpcEndpoints: true, // New prop
  });
});
```

### 3. Run and Review

```bash
# Run test
yarn test:unit

# Review snapshot
cat test/__snapshots__/installer-container-stack.test.ts.snap | grep -A 20 "VPC Endpoints"
```

### 4. Commit

```bash
git add test/
git commit -m "test: add VPC endpoints configuration test

- Added snapshot test for VPC endpoints enabled
- Validates S3 and ECR endpoint creation
- Ensures proper security group configuration
- Snapshot includes all endpoint resources"
```

## Continuous Improvement

This testing approach evolves. If you find:
- Better patterns
- Useful utilities
- Common pitfalls
- Documentation gaps

Please update this guide and share with the team!

---

**Happy Testing! ðŸ§ª**
