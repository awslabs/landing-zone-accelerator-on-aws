# Testing Guide for Installer Container Package

## Quick Start

```bash
# Run all tests
yarn test:unit

# Run with coverage
yarn test:unit --coverage

# Update snapshots after intentional changes
yarn test:unit -u

# Watch mode for development
yarn test:unit --watch
```

## Test Architecture

This package uses **snapshot testing** to validate CloudFormation templates generated by CDK stacks.

### Why Snapshot Testing?

- âœ… Catches unintended infrastructure changes
- âœ… Fast to write and maintain
- âœ… Provides clear diffs of changes
- âœ… Acts as living documentation
- âœ… No need to write detailed assertions

### Test Files

```
test/
â”œâ”€â”€ README.md                           # Detailed testing documentation
â”œâ”€â”€ snapshot-test.ts                    # Reusable snapshot utility
â”œâ”€â”€ installer-container-stack.test.ts   # Stack tests (5 scenarios)
â””â”€â”€ __snapshots__/                      # Generated snapshots (committed)
```

## Configuration

### Vitest Config (`vitest.config.ts`)

The configuration handles monorepo dependencies with path aliases:

```typescript
resolve: {
  alias: {
    '@aws-accelerator/installer': '../installer/index.ts',
    '@aws-accelerator/utils/lib/lambda': '../utils/lib/lambda.ts',
    '@aws-accelerator/constructs': '../constructs/index.ts',
  },
}
```

**Why aliases?** Vitest runs in isolation and needs explicit paths to resolve monorepo packages.

### Coverage Thresholds

```typescript
coverage: {
  thresholds: {
    branches: 70,
    functions: 75,  // Adjusted for bin/ files
    lines: 85,
    statements: 85,
  },
}
```

## Writing Tests

### Basic Pattern

```typescript
import { snapShotTest } from './snapshot-test';
import { InstallerContainerStack } from '../lib/installer-container-stack';

describe('MyStack', () => {
  snapShotTest('Construct(MyStack): Description', () => {
    const app = new cdk.App();
    return new MyStack(app, 'TestStack', {
      // Configuration props
    });
  });
});
```

### Test Naming Convention

Format: `Construct(StackName): Configuration Description`

Examples:
- `Construct(InstallerContainerStack): Default Configuration`
- `Construct(InstallerContainerStack): With External Pipeline Account`
- `Construct(InstallerContainerStack): With Permission Boundary`

## Snapshot Management

### When to Update Snapshots

Update snapshots when you **intentionally** change:
- Stack resources (add/remove/modify)
- CloudFormation parameters
- IAM policies or roles
- Resource properties

### How to Update Snapshots

1. **Make your code changes**

2. **Run tests to see diff:**
   ```bash
   yarn test:unit
   ```

3. **Review the diff carefully** - look for:
   - Expected changes âœ…
   - Unexpected changes âš ï¸
   - Large diffs that need investigation ðŸ”

4. **Update if correct:**
   ```bash
   yarn test:unit -u
   ```

5. **Commit both code and snapshots together**

### Reviewing Snapshot Diffs

```diff
- "BucketName": "old-bucket-name"
+ "BucketName": "new-bucket-name"  âœ… Expected change

- "Effect": "Allow"
+ "Effect": "Deny"  âš ï¸ Investigate this!

+ "NewResource": { ... }  âœ… New resource added
```

## Troubleshooting

### Problem: "Cannot find module @aws-accelerator/installer"

**Cause:** Dependency package not built

**Solution:**
```bash
yarn --cwd ../installer build
yarn --cwd ../utils build
yarn --cwd ../constructs build
```

### Problem: Tests timeout after 120 seconds

**Cause:** CDK synthesis taking too long

**Solution:** Increase timeout in `vitest.config.ts`:
```typescript
test: {
  testTimeout: 180000, // 3 minutes
}
```

### Problem: Snapshots change on every run

**Cause:** Dynamic values (UUIDs, hashes) not normalized

**Solution:** Add serializer in `test/snapshot-test.ts`:
```typescript
const myRegex = /my-pattern/;
const isMyValue = (val: unknown) => 
  typeof val === 'string' && val.match(myRegex) != null;

expect.addSnapshotSerializer({
  test: isMyValue,
  print: () => '"REPLACED-VALUE"',
});
```

### Problem: Coverage below threshold

**Cause:** New code not covered by tests

**Solution:**
1. Add tests for new functionality, OR
2. Adjust thresholds in `vitest.config.ts` (with justification)

## CI/CD Integration

Tests run automatically in CI/CD:

```bash
yarn test:unit --coverage --reporter=junit
```

**Snapshot failures in CI indicate:**
- Missing snapshot updates in commit
- Unintended infrastructure changes
- Environment-specific issues

**Always investigate before merging!**

## Best Practices

### âœ… Do

- Review snapshot diffs carefully before updating
- Test multiple configuration scenarios
- Keep test descriptions clear and specific
- Commit snapshots with code changes
- Build dependencies before running tests
- Document why you're updating snapshots in commit messages

### âŒ Don't

- Blindly run `yarn test:unit -u` without reviewing
- Ignore large unexpected diffs
- Skip snapshot review in code reviews
- Test implementation details (test CloudFormation output)
- Forget to run tests before committing

## Snapshot Serializers

Dynamic values are normalized for stable snapshots:

| Value Type | Example | Replacement |
|------------|---------|-------------|
| UUID | `a1b2c3d4-...` | `REPLACED-UUID` |
| Zip file | `abc123...xyz.zip` | `REPLACED-GENERATED-NAME.zip` |
| JSON path | `config.json` | `REPLACED-JSON-PATH.json` |
| MD5 hash | `5d41402abc4b2a76b9719d911017c592` | `REPLACED-MD5` |

## Adding New Test Scenarios

1. **Identify the configuration** you want to test

2. **Add test case:**
   ```typescript
   snapShotTest('Construct(InstallerContainerStack): My Config', () => {
     const app = new cdk.App();
     return new InstallerContainerStack(app, 'TestStack', {
       myNewFeature: true,
     });
   });
   ```

3. **Run tests** to generate snapshot:
   ```bash
   yarn test:unit
   ```

4. **Review snapshot** in `test/__snapshots__/`

5. **Document the test** with comments explaining what it validates

6. **Commit test and snapshot**

## Example: Full Test Development Workflow

```bash
# 1. Make code changes to stack
vim lib/installer-container-stack.ts

# 2. Add new test case
vim test/installer-container-stack.test.ts

# 3. Build dependencies if needed
yarn --cwd ../installer build

# 4. Run tests (will fail - no snapshot yet)
yarn test:unit

# 5. Review the generated snapshot
cat test/__snapshots__/installer-container-stack.test.ts.snap

# 6. If correct, tests pass automatically (snapshot created)
# If changes to existing tests, review diff and update:
yarn test:unit -u

# 7. Verify all tests pass
yarn test:unit

# 8. Commit changes
git add test/ lib/
git commit -m "feat: add new configuration option with tests"
```

## Resources

- **Detailed Documentation:** [test/README.md](./test/README.md)
- **Vitest Docs:** https://vitest.dev/
- **CDK Testing:** https://docs.aws.amazon.com/cdk/v2/guide/testing.html
- **Snapshot Testing:** https://vitest.dev/guide/snapshot.html

## Questions?

1. Check [test/README.md](./test/README.md) for detailed information
2. Review existing tests for examples
3. Consult team testing guidelines
4. Ask in development channel
