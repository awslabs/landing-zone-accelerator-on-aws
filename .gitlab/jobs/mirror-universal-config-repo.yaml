# GitLab Repo Mirror Jobs for LZA Universal Configuration
# These jobs mirror the lza-universal-configuration repository to CodeCommit
# Triggered by changes in the LZA repository (cross-repo mirroring)
# Mirror UC repo for LZA testing
# ==============================

variables:
  UNIVERSAL_CONFIG_REPO_PATH: "landing-zone-accelerator/lza-universal-configuration.git"
  PARTITION: aws
  AWS_DEFAULT_REGION: "us-east-1"
  UC_REPO_NAME: lza-universal-configuration-mirror

# Template for universal config mirror jobs
.universal_config_mirror_template: &universal_config_mirror_template
  stage: mirror
  before_script:
    - rm -rf /var/lib/apt/lists/*
    - apt-get update
    - apt-cache gencaches
    - wget --progress=dot:mega -O /tmp/awscliv2.zip https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
    - unzip -q /tmp/awscliv2.zip -d /tmp
    - /tmp/aws/install
    - git config --global credential.helper '!aws codecommit credential-helper $@'
    - git config --global credential.UseHttpPath true
  script:
    - echo "Starting mirror of universal-config repo to ${UC_REPO_NAME} in account ${ACCOUNT_ID}"
    - git clone --mirror https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${UNIVERSAL_CONFIG_REPO_PATH} /tmp/universal-config-mirror
    - cd /tmp/universal-config-mirror
    - git remote add codecommit https://git-codecommit.${AWS_DEFAULT_REGION}.amazonaws.com/v1/repos/${UC_REPO_NAME}
    - git push codecommit --mirror --force
    - echo "Successfully mirrored universal-config repo to ${UC_REPO_NAME}"

# Account 1: LZA CICD Integ Replicator Account
universal-config:cicd-integ-replicator:
  <<: *universal_config_mirror_template
  variables:
    ACCOUNT_ID: "${LZA_CICD_INTEG_REPLICATOR_ACCOUNT_ID}"
    AWS_CREDS_TARGET_ROLE: "arn:${PARTITION}:iam::${ACCOUNT_ID}:role/${GITLAB_RUNNER_ROLE_NAME}"
  rules:
    - if: $SKIP_MIRROR_JOBS == "yes"
      when: never
    - if: $CI_PROJECT_ID == "11925" && $CI_COMMIT_BRANCH == "integ" && $CI_MERGE_REQUEST_IID == null
      when: always
    - when: never

# Account 2: LZA CICD Main Replicator Account
universal-config:cicd-main-replicator:
  <<: *universal_config_mirror_template
  variables:
    ACCOUNT_ID: "${LZA_CICD_MAIN_REPLICATOR_ACCOUNT_ID}"
    AWS_CREDS_TARGET_ROLE: "arn:${PARTITION}:iam::${ACCOUNT_ID}:role/${GITLAB_RUNNER_ROLE_NAME}"
  rules:
    - if: $SKIP_MIRROR_JOBS == "yes"
      when: never
    - if: $CI_PROJECT_ID == "11925" && $CI_COMMIT_BRANCH == "main" && $CI_MERGE_REQUEST_IID == null
      when: always
    - when: never

# Account 3: LZA Release Replicator Account
universal-config:release-replicator:
  <<: *universal_config_mirror_template
  variables:
    ACCOUNT_ID: "${LZA_RELEASE_REPLICATOR_ACCOUNT_ID}"
    AWS_CREDS_TARGET_ROLE: "arn:${PARTITION}:iam::${ACCOUNT_ID}:role/${GITLAB_RUNNER_ROLE_NAME}"
  rules:
    - if: $SKIP_MIRROR_JOBS == "yes"
      when: never
    - if: $CI_PROJECT_ID == "11925" && $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
      when: always
    - when: never

# Account 4: LZA Development Team Replicator Account
universal-config:dev-team-replicator:
  <<: *universal_config_mirror_template
  variables:
    ACCOUNT_ID: "${LZA_DEV_TEAM_REPLICATOR_ACCOUNT_ID}"
    AWS_CREDS_TARGET_ROLE: "arn:${PARTITION}:iam::${ACCOUNT_ID}:role/${GITLAB_RUNNER_ROLE_NAME}"
  rules:
    - if: $SKIP_MIRROR_JOBS == "yes"
      when: never
    - if: $CI_PROJECT_ID == "11925" && $CI_MERGE_REQUEST_IID == null
      when: always
    - when: never
